(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&e(o)}).observe(document,{childList:!0,subtree:!0});function i(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function e(s){if(s.ep)return;s.ep=!0;const n=i(s);fetch(s.href,n)}})();var v=(l=>(l.MENU="MENU",l.PLAYING="PLAYING",l.GAME_OVER="GAME_OVER",l.PAUSED="PAUSED",l))(v||{}),w=(l=>(l.SPAWNING="SPAWNING",l.ACTIVE="ACTIVE",l.FROZEN="FROZEN",l.DEAD="DEAD",l))(w||{}),m=(l=>(l.ZOMBIE_SNOW="ZOMBIE_SNOW",l.SWEEPER_LINE="SWEEPER_LINE",l.SPARSE_GRID="SPARSE_GRID",l.BOUNCING_BALL="BOUNCING_BALL",l.GATLING_POINT="GATLING_POINT",l.BULLET_HELL="BULLET_HELL",l.CONTAINMENT_RING="CONTAINMENT_RING",l.CYCLONE="CYCLONE",l.CLOCK_SWEEP="CLOCK_SWEEP",l))(m||{}),g=(l=>(l.KINETIC_BOMB="KINETIC_BOMB",l.BLASTER="BLASTER",l.ICE_BOMB="ICE_BOMB",l.HOMING_MISSILE="HOMING_MISSILE",l.NUCLEAR_BOMB="NUCLEAR_BOMB",l.ELECTRIC_BOMB="ELECTRIC_BOMB",l.DOT_REPELLENT="DOT_REPELLENT",l.CHAINSAW="CHAINSAW",l.FLAME_BURST="FLAME_BURST",l))(g||{}),d=(l=>(l.EASY="EASY",l.MEDIUM="MEDIUM",l.HARD="HARD",l))(d||{});class N{canvas;ctx;width=0;height=0;dpr=1;circleBatches=new Map;outlineBatches=new Map;static TWO_PI=Math.PI*2;scale=1.3;onScaleChange;constructor(t="game"){const i=document.getElementById(t);if(!i)throw new Error(`Canvas element with id "${t}" not found`);this.canvas=i;const e=i.getContext("2d");if(!e)throw new Error("Failed to get 2D context");this.ctx=e,this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){this.dpr=window.devicePixelRatio||1,this.width=window.innerWidth,this.height=window.innerHeight,this.canvas.width=Math.floor(this.width*this.dpr),this.canvas.height=Math.floor(this.height*this.dpr),this.canvas.style.width=`${this.width}px`,this.canvas.style.height=`${this.height}px`}getBounds(){return{width:this.width/this.scale,height:this.height/this.scale}}setScale(t){this.scale=t,this.onScaleChange&&this.onScaleChange()}getScale(){return this.scale}onScaleChangeCallback(t){this.onScaleChange=t}clear(t="#000000"){this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.ctx.scale(this.dpr*this.scale,this.dpr*this.scale)}endFrame(){this.ctx.restore()}drawCircle(t,i,e,s){let n=this.circleBatches.get(s);n||(n=[],this.circleBatches.set(s,n)),n.push({x:t,y:i,radius:e})}drawCircleOutline(t,i,e,s,n=2){let o=this.outlineBatches.get(s);o||(o=[],this.outlineBatches.set(s,o)),o.push({x:t,y:i,radius:e,lineWidth:n})}flushBatches(){const t=this.ctx;t.fillStyle="",this.circleBatches.forEach((i,e)=>{t.fillStyle=e,t.beginPath();for(let s=0;s<i.length;s++){const n=i[s];t.moveTo(n.x+n.radius,n.y),t.arc(n.x,n.y,n.radius,0,N.TWO_PI)}t.fill()}),this.circleBatches.clear(),t.strokeStyle="",this.outlineBatches.forEach((i,e)=>{const s=new Map;for(let n=0;n<i.length;n++){const o=i[n];let a=s.get(o.lineWidth);a||(a=[],s.set(o.lineWidth,a)),a.push(o)}s.forEach((n,o)=>{t.strokeStyle=e,t.lineWidth=o,t.beginPath();for(let a=0;a<n.length;a++){const r=n[a];t.moveTo(r.x+r.radius,r.y),t.arc(r.x,r.y,r.radius,0,N.TWO_PI)}t.stroke()})}),this.outlineBatches.clear()}drawCircleImmediate(t,i,e,s){this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(t,i,e,0,N.TWO_PI),this.ctx.fill()}drawLine(t,i,e,s,n,o=2){this.ctx.beginPath(),this.ctx.moveTo(t,i),this.ctx.lineTo(e,s),this.ctx.strokeStyle=n,this.ctx.lineWidth=o,this.ctx.stroke()}drawArrow(t,i,e,s,n="#00CC00"){const o=Math.cos(e),a=Math.sin(e),r=t+o*s,h=i+a*s,c=this.ctx;c.strokeStyle=n,c.lineWidth=3,c.beginPath(),c.moveTo(t,i),c.lineTo(r,h),c.stroke();const p=8,u=Math.PI/6;c.beginPath(),c.moveTo(r,h),c.lineTo(r-p*Math.cos(e-u),h-p*Math.sin(e-u)),c.moveTo(r,h),c.lineTo(r-p*Math.cos(e+u),h-p*Math.sin(e+u)),c.stroke()}drawRect(t,i,e,s,n){this.ctx.fillStyle=n,this.ctx.fillRect(t,i,e,s)}drawText(t,i,e,s="#FFFFFF",n=16){this.ctx.font=`${n}px Arial`,this.ctx.fillStyle=s,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(t,i,e)}drawTextLeft(t,i,e,s="#FFFFFF",n=16){this.ctx.font=`${n}px Arial`,this.ctx.fillStyle=s,this.ctx.textAlign="left",this.ctx.textBaseline="top",this.ctx.fillText(t,i,e)}drawPolygon(t,i){if(t.length<3)return;const e=this.ctx;e.fillStyle=i,e.beginPath(),e.moveTo(t[0].x,t[0].y);for(let s=1;s<t.length;s++)e.lineTo(t[s].x,t[s].y);e.closePath(),e.fill()}getContext(){return this.ctx}}const B=10,tt=B*.5,Y=800,it=15,M=8,K=1e3,k=1.5,O=20,et="#00FF00",st="#00CC00",nt="#FF0000",ot="#FF6666",at="#00FFFF",rt="#000000",q={KINETIC_BOMB:"#FF6600",BLASTER:"#9900FF",ICE_BOMB:"#00CCFF",HOMING_MISSILE:"#FFFF00",NUCLEAR_BOMB:"#FF0000",ELECTRIC_BOMB:"#00FFFF",DOT_REPELLENT:"#808080",CHAINSAW:"#0066FF",FLAME_BURST:"#FF9900"},ht=60,H=1e3/ht;class lt{velocity={x:0,y:0};permissionState="unknown";tiltBasis=null;constructor(){this.checkPermissionAvailability(),this.trackScreenOrientation()}trackScreenOrientation(){window.addEventListener("orientationchange",()=>{})}setTiltBasis(t){this.tiltBasis=t}getCurrentTiltBasis(){return this.tiltBasis}checkPermissionAvailability(){typeof DeviceOrientationEvent.requestPermission=="function"?this.permissionState="pending":window.DeviceOrientationEvent?(this.permissionState="granted",this.enableDeviceOrientation()):this.permissionState="denied"}async requestPermission(){if(this.permissionState==="granted")return!0;if(typeof DeviceOrientationEvent.requestPermission=="function")try{return await DeviceOrientationEvent.requestPermission()==="granted"?(this.permissionState="granted",this.enableDeviceOrientation(),!0):(this.permissionState="denied",!1)}catch(t){return console.error("Device orientation permission error:",t),this.permissionState="denied",!1}return this.permissionState==="granted"}enableDeviceOrientation(){window.addEventListener("deviceorientation",this.handleOrientation.bind(this))}lastTilt={gamma:0,beta:45};calibrateTiltBasis(){this.tiltBasis={...this.lastTilt}}getScreenOrientation(){return screen.orientation?screen.orientation.angle:0}transformTiltToGameCoords(t,i,e){const s=t,n=i-45;switch(e){case 0:return{x:s,y:n};case 90:case-270:return{x:-n,y:s};case 180:case-180:return{x:-s,y:-n};case-90:case 270:return{x:n,y:-s};default:return{x:s,y:n}}}handleOrientation(t){if(t.gamma===null||t.beta===null)return;const i=t.gamma,e=t.beta;this.lastTilt={gamma:i,beta:e};const s=this.getScreenOrientation(),n=this.tiltBasis;let o=i,a=e-45;n!==null&&(o=i-n.gamma,a=e-45-(n.beta-45));const r=this.transformTiltToGameCoords(o,a+45,s),h=this.clamp(r.x/22.5,-1,1),c=this.clamp(r.y/22.5,-1,1);this.velocity.x=h*Y,this.velocity.y=c*Y}clamp(t,i,e){return Math.max(i,Math.min(e,t))}getVelocity(){return{x:this.velocity.x,y:this.velocity.y}}getPermissionState(){return this.permissionState}needsPermissionRequest(){return this.permissionState==="pending"}destroy(){window.removeEventListener("deviceorientation",this.handleOrientation.bind(this))}}class I{constructor(t=0,i=0){this.x=t,this.y=i}static from(t){return new I(t.x,t.y)}add(t){return new I(this.x+t.x,this.y+t.y)}subtract(t){return new I(this.x-t.x,this.y-t.y)}multiply(t){return new I(this.x*t,this.y*t)}divide(t){if(t===0)throw new Error("Division by zero");return new I(this.x/t,this.y/t)}magnitude(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){const t=this.magnitude();return t===0?new I(0,0):this.divide(t)}dot(t){return this.x*t.x+this.y*t.y}angle(){return Math.atan2(this.y,this.x)}angleTo(t){return Math.atan2(t.y-this.y,t.x-this.x)}clone(){return new I(this.x,this.y)}set(t,i){this.x=t,this.y=i}addInPlace(t){this.x+=t.x,this.y+=t.y}}function G(l,t){const i=t.x-l.x,e=t.y-l.y;return Math.sqrt(i*i+e*e)}function Z(l,t){if(t.width>0&&t.height>0){for(;l.x<0;)l.x+=t.width;for(;l.y<0;)l.y+=t.height;l.x=l.x%t.width,l.y=l.y%t.height}}function X(l,t,i,e){const s=i.x-l.x,n=i.y-l.y,o=s*s+n*n,a=t+e;return o<a*a}function j(l,t=0){return{x:t+Math.random()*(l.width-t*2),y:t+Math.random()*(l.height-t*2)}}class ct{position;velocity={x:0,y:0};directionAngle=0;hitboxRadius=tt;constructor(t,i){this.position=new I(t,i)}update(t,i,e,s=!0){this.velocity.x=i.x,this.velocity.y=i.y,(this.velocity.x!==0||this.velocity.y!==0)&&(this.directionAngle=Math.atan2(this.velocity.y,this.velocity.x)),this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,s?Z(this.position,e):(this.position.x=Math.max(0,Math.min(e.width,this.position.x)),this.position.y=Math.max(0,Math.min(e.height,this.position.y)))}setPosition(t,i){this.position.x=t,this.position.y=i}render(t){t.drawCircleImmediate(this.position.x,this.position.y,B,et);const i=this.position.x+Math.cos(this.directionAngle)*(B+2),e=this.position.y+Math.sin(this.directionAngle)*(B+2);t.drawArrow(i,e,this.directionAngle,it,st)}getPosition(){return this.position}}class dt{score=0;kills=0;startTime=0;start(){this.score=0,this.kills=0,this.startTime=Date.now()}addKill(){this.kills++}addKills(t){this.kills+=t}addPatternBonus(t){const i={EASY:50,MEDIUM:100,HARD:200};this.score+=i[t]||50}getScore(){const t=Math.floor((Date.now()-this.startTime)/1e4);return this.score+this.kills*10+t}getKills(){return this.kills}getTimeAlive(){return Date.now()-this.startTime}}const _=100,pt=[[-1,-1],[0,-1],[1,-1],[-1,0],[0,0],[1,0],[-1,1],[0,1],[1,1]];class ut{grid=new Map;nearbyKeys=new Array(9);constructor(t){}getCellKey(t,i){const e=Math.floor(t/_),s=Math.floor(i/_);return e*1e4+s}getNearbyKeys(t,i){const e=Math.floor(t/_),s=Math.floor(i/_);for(let n=0;n<9;n++){const[o,a]=pt[n];this.nearbyKeys[n]=(e+o)*1e4+(s+a)}return this.nearbyKeys}rebuildGrid(t){this.grid.clear();for(let i=0;i<t.length;i++){const e=t[i];if(!e.isLethal()&&!e.isFrozen())continue;const s=e.getPosition(),n=this.getCellKey(s.x,s.y);let o=this.grid.get(n);o||(o=[],this.grid.set(n,o)),o.push(e)}}checkPlayerDotCollision(t){const i=t.getPosition(),e=t.hitboxRadius,s=this.getNearbyKeys(i.x,i.y);for(let n=0;n<9;n++){const o=this.grid.get(s[n]);if(o)for(let a=0;a<o.length;a++){const r=o[a],h=r.getPosition(),c=r.getEffectiveRadius();if(X(i,e,h,c))return r}}return null}checkPlayerOrbCollision(t,i){const e=t.getPosition(),s=t.hitboxRadius;for(let n=0;n<i.length;n++){const o=i[n];if(!o.isActive())continue;const a=o.getPosition(),r=o.radius;if(X(e,s,a,r))return o}return null}updateBounds(t){}}class ft{currentDifficulty=d.EASY;mediumThreshold=500;hardThreshold=1500;update(t){t>=this.hardThreshold?this.currentDifficulty=d.HARD:t>=this.mediumThreshold?this.currentDifficulty=d.MEDIUM:this.currentDifficulty=d.EASY}getDifficulty(){return this.currentDifficulty}getSpawnRateMultiplier(){return{[d.EASY]:1,[d.MEDIUM]:1.5,[d.HARD]:2}[this.currentDifficulty]}getMaxDots(){return{[d.EASY]:150,[d.MEDIUM]:225,[d.HARD]:300}[this.currentDifficulty]}}class gt{patterns=new Map;register(t,i){this.patterns.set(t,i)}create(t){const i=this.patterns.get(t);return i?new i:null}getAvailableTypes(){return Array.from(this.patterns.keys())}}const S=new gt;class yt{toasts=[];allMessages=[];container;errorOverlay=null;nextId=0;maxToasts=5;defaultDuration=3e3;constructor(){this.container=document.createElement("div"),this.container.id="toast-container",this.container.style.cssText=`
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 1000;
      pointer-events: none;
      font-family: Arial, sans-serif;
    `,document.body.appendChild(this.container)}show(t,i="info",e){const s={id:this.nextId++,text:t,type:i,createdAt:Date.now(),duration:e??this.defaultDuration};if(this.toasts.push(s),this.allMessages.push(s),this.allMessages.length>100&&(this.allMessages=this.allMessages.slice(-50)),this.toasts.length>this.maxToasts){const n=this.toasts.shift();n&&this.removeToastElement(n.id)}this.renderToast(s),this.scheduleRemoval(s)}renderToast(t){const i=document.createElement("div");i.id=`toast-${t.id}`;const e=this.getColorsForType(t.type);i.style.cssText=`
      background: ${e.background};
      color: ${e.text};
      padding: 10px 16px;
      border-radius: 4px;
      font-size: 14px;
      max-width: 280px;
      word-wrap: break-word;
      opacity: 0;
      transform: translateX(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      border-left: 3px solid ${e.border};
    `,i.textContent=t.text,this.container.appendChild(i),requestAnimationFrame(()=>{i.style.opacity="1",i.style.transform="translateX(0)"})}getColorsForType(t){switch(t){case"success":return{background:"rgba(0, 100, 0, 0.9)",text:"#90EE90",border:"#00FF00"};case"warning":return{background:"rgba(100, 80, 0, 0.9)",text:"#FFE4B5",border:"#FFD700"};case"error":return{background:"rgba(100, 0, 0, 0.9)",text:"#FFB6C1",border:"#FF4444"};default:return{background:"rgba(30, 30, 30, 0.9)",text:"#E0E0E0",border:"#888888"}}}scheduleRemoval(t){setTimeout(()=>{this.removeToast(t.id)},t.duration)}removeToast(t){const i=this.toasts.findIndex(e=>e.id===t);i!==-1&&(this.toasts.splice(i,1),this.removeToastElement(t))}removeToastElement(t){const i=document.getElementById(`toast-${t}`);i&&(i.style.opacity="0",i.style.transform="translateX(20px)",setTimeout(()=>{i.remove()},300))}clear(){this.toasts.forEach(t=>{this.removeToastElement(t.id)}),this.toasts=[],this.allMessages=[]}getRecentMessages(t=5){return this.toasts.slice(-t)}getAllMessages(){return this.allMessages}setupGlobalErrorHandler(){window.addEventListener("error",t=>{const i=t.error?.stack??"No stack trace available";this.showFatalError("Runtime Error",t.message,i,t.filename,t.lineno,t.colno)}),window.addEventListener("unhandledrejection",t=>{const i=t.reason,e=i instanceof Error?i.message:String(i),s=i instanceof Error?i.stack??"No stack trace available":"No stack trace available";this.showFatalError("Unhandled Promise Rejection",e,s)})}showFatalError(t,i,e,s,n,o){if(this.errorOverlay)return;this.errorOverlay=document.createElement("div"),this.errorOverlay.id="fatal-error-overlay",this.errorOverlay.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.95);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 40px;
      box-sizing: border-box;
      font-family: 'Courier New', monospace;
      overflow-y: auto;
    `;const a=document.createElement("div");a.style.cssText=`
      max-width: 900px;
      width: 100%;
      background: #1a1a1a;
      border: 2px solid #ff4444;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 0 30px rgba(255, 68, 68, 0.3);
    `;const r=document.createElement("h1");r.textContent="âš ï¸ "+t,r.style.cssText=`
      color: #ff4444;
      margin: 0 0 20px 0;
      font-size: 24px;
      font-family: Arial, sans-serif;
    `;const h=document.createElement("div");if(h.textContent=i,h.style.cssText=`
      color: #ffffff;
      font-size: 16px;
      margin-bottom: 10px;
      padding: 10px;
      background: rgba(255, 68, 68, 0.1);
      border-radius: 4px;
      font-family: Arial, sans-serif;
    `,a.appendChild(r),a.appendChild(h),s){const P=document.createElement("div");P.textContent=`Location: ${s}:${n??"?"}:${o??"?"}`,P.style.cssText=`
        color: #aaaaaa;
        font-size: 12px;
        margin-bottom: 20px;
        font-family: Arial, sans-serif;
      `,a.appendChild(P)}const c=document.createElement("div");c.textContent="Stack Trace:",c.style.cssText=`
      color: #ff8844;
      font-size: 14px;
      margin: 20px 0 10px 0;
      font-weight: bold;
      font-family: Arial, sans-serif;
    `,a.appendChild(c);const p=document.createElement("pre");p.textContent=e,p.style.cssText=`
      color: #cccccc;
      font-size: 12px;
      line-height: 1.5;
      background: #0a0a0a;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #333;
      margin: 0;
    `,a.appendChild(p);const u=document.createElement("div");u.style.cssText=`
      display: flex;
      gap: 10px;
      margin-top: 20px;
    `;const f=document.createElement("button");f.textContent="ðŸ”„ Reload Game",f.style.cssText=`
      padding: 12px 24px;
      font-size: 14px;
      background: #ff4444;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: Arial, sans-serif;
      font-weight: bold;
    `,f.onmouseover=()=>f.style.background="#ff6666",f.onmouseout=()=>f.style.background="#ff4444",f.onclick=()=>window.location.reload();const y=document.createElement("button");y.textContent="ðŸ“‹ Copy Error",y.style.cssText=`
      padding: 12px 24px;
      font-size: 14px;
      background: #444444;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: Arial, sans-serif;
      font-weight: bold;
    `,y.onmouseover=()=>y.style.background="#555555",y.onmouseout=()=>y.style.background="#444444",y.onclick=()=>{const P=`${t}
${i}
${s?`Location: ${s}:${n}:${o}
`:""}
Stack Trace:
${e}`;navigator.clipboard.writeText(P).then(()=>{y.textContent="âœ… Copied!",setTimeout(()=>y.textContent="ðŸ“‹ Copy Error",2e3)})},u.appendChild(f),u.appendChild(y),a.appendChild(u),this.errorOverlay.appendChild(a),document.body.appendChild(this.errorOverlay),console.error(`[FATAL ERROR] ${t}:`,i,`
Stack:`,e)}}const R=new yt,mt=new Map([[m.ZOMBIE_SNOW,d.EASY],[m.SPARSE_GRID,d.EASY],[m.CONTAINMENT_RING,d.EASY],[m.SWEEPER_LINE,d.MEDIUM],[m.GATLING_POINT,d.MEDIUM],[m.BOUNCING_BALL,d.MEDIUM],[m.BULLET_HELL,d.HARD],[m.CYCLONE,d.HARD]]),U={EASY_MAX:500,MEDIUM_MAX:1500};class wt{activePatterns=[];patternTimer=0;nextPatternInterval=3e3;currentScore=0;allDotsCache=[];minInterval=2e3;maxInterval=4e3;constructor(){this.nextPatternInterval=this.getRandomInterval()}update(t,i,e){if(this.patternTimer+=t*1e3,this.patternTimer>=this.nextPatternInterval){this.patternTimer=0,this.nextPatternInterval=this.getRandomInterval();const s=this.selectNextPattern();s&&this.spawnPattern(s,i,e)}for(let s=0;s<this.activePatterns.length;s++){const n=this.activePatterns[s];n.tick(t),n.update(t,i,e)}this.removeCompletedPatterns(),this.rebuildDotsCache()}addPattern(t){this.isPatternTypeActive(t.type)||this.activePatterns.push(t)}removePattern(t){const i=this.activePatterns.indexOf(t);i!==-1&&(t.clear(),this.activePatterns.splice(i,1))}getActivePatterns(){return this.activePatterns}getAllDots(){return this.allDotsCache}isAnyPatternActivelySpawning(){for(let t=0;t<this.activePatterns.length;t++)if(this.activePatterns[t].isActivelySpawning())return!0;return!1}rebuildDotsCache(){this.allDotsCache.length=0;for(let t=0;t<this.activePatterns.length;t++){const i=this.activePatterns[t].getDots();for(let e=0;e<i.length;e++)this.allDotsCache.push(i[e])}}setScore(t){this.currentScore=t}getAvailablePatternTypes(){const t=[],i=S.getAvailableTypes();for(const e of i){const s=mt.get(e);s&&this.isDifficultyAvailable(s)&&t.push(e)}return t}selectNextPattern(){const i=this.getAvailablePatternTypes().filter(s=>!this.isPatternTypeActive(s));if(i.length===0)return null;const e=Math.floor(Math.random()*i.length);return i[e]}spawnPattern(t,i,e){if(this.isPatternTypeActive(t))return;const s=S.create(t);if(!s){console.warn(`Failed to create pattern of type: ${t}`);return}R.show(`Pattern: ${this.formatPatternName(t)}`,"info"),s.spawn(i,e),s.start(),this.activePatterns.push(s)}isPatternTypeActive(t){for(let i=0;i<this.activePatterns.length;i++)if(this.activePatterns[i].type===t)return!0;return!1}isDifficultyAvailable(t){switch(t){case d.EASY:return this.currentScore<U.EASY_MAX;case d.MEDIUM:return this.currentScore>=U.EASY_MAX;case d.HARD:return this.currentScore>=U.MEDIUM_MAX;default:return!1}}removeCompletedPatterns(){for(let t=this.activePatterns.length-1;t>=0;t--)if(this.activePatterns[t].isComplete()){const i=this.activePatterns[t];i.clear(),this.activePatterns.splice(t,1),R.show(`Pattern ended: ${this.formatPatternName(i.type)}`,"info")}}clear(){for(let t=0;t<this.activePatterns.length;t++)this.activePatterns[t].clear();this.activePatterns=[],this.patternTimer=0,this.allDotsCache.length=0}getPatternTimer(){return this.patternTimer}getPatternInterval(){return this.nextPatternInterval}getRandomInterval(){return this.minInterval+Math.random()*(this.maxInterval-this.minInterval)}formatPatternName(t){return t.toLowerCase().split("_").map(i=>i.charAt(0).toUpperCase()+i.slice(1)).join(" ")}}class F{position;weaponType;pickedUp=!1;radius=O;static BOUNCED_WEAPONS=[g.NUCLEAR_BOMB,g.ELECTRIC_BOMB];velocity={x:0,y:0};lastBounceTime=0;bounceCooldown=100;constructor(t,i,e){this.position={x:t,y:i},this.weaponType=e}render(t){if(this.pickedUp)return;const i=q[this.weaponType]||"#FFFFFF";t.drawCircleImmediate(this.position.x,this.position.y,this.radius,i);const s=F.BOUNCED_WEAPONS.includes(this.weaponType)?"#9B30FF":"#FFFFFF",n=t.getContext();n.strokeStyle=s,n.lineWidth=3,n.beginPath(),n.arc(this.position.x,this.position.y,this.radius+2,0,Math.PI*2),n.stroke(),this.drawIcon(n,this.position.x,this.position.y,this.radius)}drawIcon(t,i,e,s){t.strokeStyle="#FFFFFF",t.lineWidth=2,t.fillStyle="#FFFFFF";const n=s*.5;switch(this.weaponType){case g.KINETIC_BOMB:this.drawKineticBombIcon(t,i,e,n);break;case g.BLASTER:this.drawBlasterIcon(t,i,e,n);break;case g.ICE_BOMB:this.drawIceBombIcon(t,i,e,n);break;case g.HOMING_MISSILE:this.drawHomingMissileIcon(t,i,e,n);break;case g.NUCLEAR_BOMB:this.drawNuclearBombIcon(t,i,e,n);break;case g.ELECTRIC_BOMB:this.drawElectricBombIcon(t,i,e,n);break;case g.DOT_REPELLENT:this.drawDotRepellentIcon(t,i,e,n);break;case g.CHAINSAW:this.drawChainsawIcon(t,i,e,n);break;case g.FLAME_BURST:this.drawFlameBurstIcon(t,i,e,n);break}}drawKineticBombIcon(t,i,e,s){t.beginPath(),t.arc(i,e,s*.3,0,Math.PI*2),t.fill();for(let n=0;n<8;n++){const o=n/8*Math.PI*2;t.beginPath(),t.moveTo(i+Math.cos(o)*s*.4,e+Math.sin(o)*s*.4),t.lineTo(i+Math.cos(o)*s*.8,e+Math.sin(o)*s*.8),t.stroke()}}drawBlasterIcon(t,i,e,s){t.fillRect(i-s*.8,e-s*.15,s*1.6,s*.3),t.fillRect(i-s*.9,e-s*.4,s*.3,s*.8),t.fillRect(i+s*.6,e-s*.4,s*.3,s*.8)}drawIceBombIcon(t,i,e,s){for(let n=0;n<6;n++){const o=n/6*Math.PI*2;t.beginPath(),t.moveTo(i,e),t.lineTo(i+Math.cos(o)*s*.8,e+Math.sin(o)*s*.8),t.stroke();const a=i+Math.cos(o)*s*.5,r=e+Math.sin(o)*s*.5;t.beginPath(),t.moveTo(a,r),t.lineTo(a+Math.cos(o+Math.PI/4)*s*.3,r+Math.sin(o+Math.PI/4)*s*.3),t.moveTo(a,r),t.lineTo(a+Math.cos(o-Math.PI/4)*s*.3,r+Math.sin(o-Math.PI/4)*s*.3),t.stroke()}}drawHomingMissileIcon(t,i,e,s){const n=s*.25,o=s*.35;for(let a=-1;a<=1;a++){const r=i+a*o,h=e;this.drawArrowUp(t,r,h,n)}}drawArrowUp(t,i,e,s){t.beginPath(),t.moveTo(i,e-s),t.lineTo(i-s*.5,e+s*.3),t.lineTo(i+s*.5,e+s*.3),t.closePath(),t.fill()}drawNuclearBombIcon(t,i,e,s){const n=s*.7;t.beginPath(),t.arc(i,e-n*.1,n*.5,0,Math.PI*2),t.fill(),t.fillStyle="#000000",t.beginPath(),t.arc(i-n*.2,e-n*.15,n*.15,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(i+n*.2,e-n*.15,n*.15,0,Math.PI*2),t.fill(),t.beginPath(),t.moveTo(i,e+n*.05),t.lineTo(i-n*.08,e+n*.2),t.lineTo(i+n*.08,e+n*.2),t.closePath(),t.fill(),t.fillStyle="#FFFFFF",t.beginPath(),t.rect(i-n*.25,e+n*.25,n*.5,n*.2),t.fill(),t.strokeStyle="#000000",t.lineWidth=1.5;for(let r=1;r<=2;r++){const h=i-n*.08*r;t.beginPath(),t.moveTo(h,e+n*.25),t.lineTo(h,e+n*.45),t.stroke();const c=i+n*.08*r;t.beginPath(),t.moveTo(c,e+n*.25),t.lineTo(c,e+n*.45),t.stroke()}t.strokeStyle="#FFFFFF",t.lineWidth=3,t.lineCap="round",t.beginPath(),t.moveTo(i-n*.7,e-n*.5),t.lineTo(i+n*.7,e+n*.5),t.stroke(),t.beginPath(),t.moveTo(i+n*.7,e-n*.5),t.lineTo(i-n*.7,e+n*.5),t.stroke(),t.fillStyle="#FFFFFF";const o=n*.1,a=[{x:i-n*.7,y:e-n*.5},{x:i+n*.7,y:e+n*.5},{x:i+n*.7,y:e-n*.5},{x:i-n*.7,y:e+n*.5}];for(const r of a)t.beginPath(),t.arc(r.x,r.y,o,0,Math.PI*2),t.fill()}drawElectricBombIcon(t,i,e,s){t.beginPath(),t.moveTo(i+s*.2,e-s*.8),t.lineTo(i-s*.1,e-s*.1),t.lineTo(i+s*.3,e-s*.1),t.lineTo(i-s*.2,e+s*.8),t.lineTo(i,e+s*.1),t.lineTo(i-s*.3,e+s*.1),t.closePath(),t.fill()}drawDotRepellentIcon(t,i,e,s){t.beginPath(),t.arc(i,e,s*.3,0,Math.PI*2),t.stroke(),t.beginPath(),t.arc(i,e,s*.6,0,Math.PI*2),t.stroke();for(let n=0;n<4;n++){const o=n/4*Math.PI*2;this.drawOutwardArrow(t,i,e,o,s)}}drawOutwardArrow(t,i,e,s,n){const o=i+Math.cos(s)*n*.45,a=e+Math.sin(s)*n*.45,r=n*.2;t.beginPath(),t.moveTo(o+Math.cos(s)*r,a+Math.sin(s)*r),t.lineTo(o+Math.cos(s+2.5)*r,a+Math.sin(s+2.5)*r),t.lineTo(o+Math.cos(s-2.5)*r,a+Math.sin(s-2.5)*r),t.closePath(),t.fill()}drawChainsawIcon(t,i,e,s){t.beginPath(),t.arc(i,e,s*.5,0,Math.PI*2),t.stroke();const n=8;for(let o=0;o<n;o++){const a=o/n*Math.PI*2,r=s*.5,h=s*.7;t.beginPath(),t.moveTo(i+Math.cos(a-.15)*r,e+Math.sin(a-.15)*r),t.lineTo(i+Math.cos(a)*h,e+Math.sin(a)*h),t.lineTo(i+Math.cos(a+.15)*r,e+Math.sin(a+.15)*r),t.fill()}t.beginPath(),t.arc(i,e,s*.15,0,Math.PI*2),t.fill()}drawFlameBurstIcon(t,i,e,s){t.beginPath(),t.moveTo(i,e-s*.8),t.bezierCurveTo(i-s*.4,e-s*.3,i-s*.6,e+s*.2,i-s*.2,e+s*.6),t.quadraticCurveTo(i,e+s*.8,i+s*.2,e+s*.6),t.bezierCurveTo(i+s*.6,e+s*.2,i+s*.4,e-s*.3,i,e-s*.8),t.fill(),t.fillStyle="rgba(0, 0, 0, 0.3)",t.beginPath(),t.moveTo(i,e-s*.4),t.bezierCurveTo(i-s*.2,e,i-s*.3,e+s*.3,i,e+s*.5),t.bezierCurveTo(i+s*.3,e+s*.3,i+s*.2,e,i,e-s*.4),t.fill()}isCollidingWith(t,i){const e=this.position.x-t.x,s=this.position.y-t.y,n=e*e+s*s,o=this.radius+i;return n<o*o}getPosition(){return this.position}getWeaponType(){return this.weaponType}pickup(){this.pickedUp=!0}isActive(){return!this.pickedUp}bounce(t,i){const e=Date.now();if(e-this.lastBounceTime<this.bounceCooldown||(this.lastBounceTime=e,!F.BOUNCED_WEAPONS.includes(this.weaponType)))return!1;const s=this.position.x-i.x,n=this.position.y-i.y,o=Math.sqrt(s*s+n*n);if(o===0)return this.velocity.x=t.x,this.velocity.y=t.y,!0;const a=s/o,r=n/o,h=-r,c=a,p=t.x*a+t.y*r,u=t.x*h+t.y*c,f=.8,y=.6;return this.velocity.x=a*p*f+h*u*y,this.velocity.y=r*p*f+c*u*y,!0}getVelocity(){return this.velocity}updatePosition(t,i){if(!F.BOUNCED_WEAPONS.includes(this.weaponType))return;this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t;const e=this.radius,s=i.width-this.radius,n=this.radius,o=i.height-this.radius;this.position.x<=e?(this.velocity.x=Math.abs(this.velocity.x),this.position.x=e):this.position.x>=s&&(this.velocity.x=-Math.abs(this.velocity.x),this.position.x=s),this.position.y<=n?(this.velocity.y=Math.abs(this.velocity.y),this.position.y=n):this.position.y>=o&&(this.velocity.y=-Math.abs(this.velocity.y),this.position.y=o)}}class Pt{orbs=[];orbCount=3;minSpacing=100;playerAvoidRadius=150;initialize(t,i){this.orbs=[];for(let e=0;e<this.orbCount;e++)this.spawnOrb(t,i)}update(t,i){for(;this.orbs.length<this.orbCount;)this.spawnOrb(t,i)}getOrbs(){return this.orbs}removeOrb(t){const i=this.orbs.indexOf(t);i>-1&&this.orbs.splice(i,1)}spawnOrb(t,i){const e=this.getRandomPosition(t,i),s=this.getRandomWeaponType();this.orbs.push(new F(e.x,e.y,s))}getRandomPosition(t,i){let e=0;for(;e<100;){const s=O+Math.random()*(t.width-O*2),n=O+Math.random()*(t.height-O*2),o=s-i.x,a=n-i.y;if(Math.sqrt(o*o+a*a)>=this.playerAvoidRadius&&this.isPositionValid({x:s,y:n}))return{x:s,y:n};e++}return{x:t.width/2,y:t.height/2}}isPositionValid(t){for(const i of this.orbs){const e=t.x-i.position.x,s=t.y-i.position.y;if(Math.sqrt(e*e+s*s)<this.minSpacing)return!1}return!0}getRandomWeaponType(){const t=[g.KINETIC_BOMB,g.BLASTER,g.ICE_BOMB,g.HOMING_MISSILE,g.NUCLEAR_BOMB,g.ELECTRIC_BOMB,g.DOT_REPELLENT,g.CHAINSAW,g.FLAME_BURST];return t[Math.floor(Math.random()*t.length)]}}class Mt{weapons=new Map;register(t,i){this.weapons.set(t,i)}create(t){const i=this.weapons.get(t);return i?new i:null}getAvailableTypes(){return Array.from(this.weapons.keys())}}const A=new Mt;class D{dots=[];startTime=0;isStarted=!1;killedDots=0;handlePlayerCollision(t,i){return!1}isActive(){return!1}getPosition(){return{x:0,y:0}}getRadius(){return 0}getDots(){return this.dots.filter(t=>!t.isDead())}isComplete(){return!1}start(){this.startTime=Date.now(),this.isStarted=!0}getElapsedTime(){return Date.now()-this.startTime}clear(){for(const t of this.dots)t.kill();this.dots=[]}getKilledDots(){return this.killedDots}addKilledDot(){this.killedDots++}}class J extends D{type=g.NUCLEAR_BOMB;state="DRIFTING";orbPosition={x:0,y:0};orbVelocity={x:0,y:0};fuseTime=4e3;collisionCount=0;explosionRadius=0;explosionStartTime=0;killedDotsInExplosion=new Set;_hasKilledPlayer=!1;bounds=null;flashInterval=100;flashGap=400;lastCollisionTime=0;collisionCooldown=100;orbRadius=O;activate(t,i){this.dots=i,this.start(),this.orbPosition={x:t.position.x,y:t.position.y},this.orbVelocity={x:0,y:0}}handlePlayerCollision(t,i){const e=Date.now();if(e-this.lastCollisionTime<this.collisionCooldown)return!1;this.lastCollisionTime=e;const s=this.orbPosition.x-t.position.x,n=this.orbPosition.y-t.position.y,o=Math.sqrt(s*s+n*n),a=50,r=Math.sqrt(i.x**2+i.y**2);if(r<a)return!1;if(o===0)return this.orbVelocity.x=i.x,this.orbVelocity.y=i.y,!0;const h=s/o,c=n/o,p=-c,u=h,f=i.x*h+i.y*c,y=i.x*p+i.y*u,P=f/r;if(P<.1)return!1;const E=1.5;if(P>.7)this.orbVelocity.x=i.x*E,this.orbVelocity.y=i.y*E;else{const x=P,T=1-P;this.orbVelocity.x=(h*f*x+p*y*T)*E,this.orbVelocity.y=(c*f*x+u*y*T)*E}return!0}getPosition(){return this.orbPosition}getRadius(){return this.orbRadius}isActive(){return this.state!=="COMPLETE"}update(t,i,e,s){switch(this.bounds=s,this.state){case"DRIFTING":{const n=this.getElapsedTime();this.orbPosition.x+=this.orbVelocity.x*t,this.orbPosition.y+=this.orbVelocity.y*t;const o=this.orbRadius,a=s.width-this.orbRadius,r=this.orbRadius,h=s.height-this.orbRadius;this.orbPosition.x<=o?(this.orbVelocity.x=Math.abs(this.orbVelocity.x),this.orbPosition.x=o,this.collisionCount++):this.orbPosition.x>=a&&(this.orbVelocity.x=-Math.abs(this.orbVelocity.x),this.orbPosition.x=a,this.collisionCount++),this.orbPosition.y<=r?(this.orbVelocity.y=Math.abs(this.orbVelocity.y),this.orbPosition.y=r,this.collisionCount++):this.orbPosition.y>=h&&(this.orbVelocity.y=-Math.abs(this.orbVelocity.y),this.orbPosition.y=h,this.collisionCount++),(n>=this.fuseTime||this.collisionCount>=3)&&(this.state="EXPLODING",this.explosionStartTime=Date.now(),this.explosionRadius=.55*s.width,R.show("Nuclear Bomb detonated!","warning"),this.killDotsInExplosion(e),this.checkAndKillPlayer(i));break}case"EXPLODING":{Date.now()-this.explosionStartTime>500&&(this.state="COMPLETE");break}}}render(t){if(this.bounds)switch(this.state){case"DRIFTING":{const i=this.getElapsedTime(),e=Math.min(i/this.fuseTime,1),s=this.interpolateColor("#FF6600","#FF0000",e),n=.55*this.bounds.width,o=t.getContext(),a=this.fuseTime-1500;if(i>=a){const r=i-a,h=0,c=this.flashInterval+this.flashGap;let p=!1;(r>=h&&r<h+this.flashInterval||r>=c&&r<c+this.flashInterval)&&(p=!0),p&&(o.fillStyle="rgba(255, 165, 0, 0.6)",o.beginPath(),o.arc(this.orbPosition.x,this.orbPosition.y,n,0,Math.PI*2),o.fill())}t.drawCircleImmediate(this.orbPosition.x,this.orbPosition.y,this.orbRadius,s),o.strokeStyle="#9B30FF",o.lineWidth=3,o.beginPath(),o.arc(this.orbPosition.x,this.orbPosition.y,this.orbRadius+2,0,Math.PI*2),o.stroke(),this.drawNuclearIcon(o,this.orbPosition.x,this.orbPosition.y,this.orbRadius*.5);break}case"EXPLODING":{const i=Date.now()-this.explosionStartTime;if(i<=500){const e=.8-i/500*.8;t.drawCircle(this.orbPosition.x,this.orbPosition.y,this.explosionRadius,`rgba(255, 0, 0, ${e})`)}break}}}interpolateColor(t,i,e){const s=parseInt(t.slice(1,3),16),n=parseInt(t.slice(3,5),16),o=parseInt(t.slice(5,7),16),a=parseInt(i.slice(1,3),16),r=parseInt(i.slice(3,5),16),h=parseInt(i.slice(5,7),16),c=Math.round(s+(a-s)*e),p=Math.round(n+(r-n)*e),u=Math.round(o+(h-o)*e);return`#${c.toString(16).padStart(2,"0")}${p.toString(16).padStart(2,"0")}${u.toString(16).padStart(2,"0")}`}drawNuclearIcon(t,i,e,s){t.fillStyle="#FFFFFF",t.strokeStyle="#FFFFFF",t.lineWidth=2;const n=s*.7;t.beginPath(),t.arc(i,e-n*.1,n*.5,0,Math.PI*2),t.fill(),t.fillStyle="#000000",t.beginPath(),t.arc(i-n*.2,e-n*.15,n*.15,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(i+n*.2,e-n*.15,n*.15,0,Math.PI*2),t.fill(),t.beginPath(),t.moveTo(i,e+n*.05),t.lineTo(i-n*.08,e+n*.2),t.lineTo(i+n*.08,e+n*.2),t.closePath(),t.fill(),t.fillStyle="#FFFFFF",t.beginPath(),t.rect(i-n*.25,e+n*.25,n*.5,n*.2),t.fill(),t.strokeStyle="#000000",t.lineWidth=1.5;for(let r=1;r<=2;r++){const h=i-n*.08*r;t.beginPath(),t.moveTo(h,e+n*.25),t.lineTo(h,e+n*.45),t.stroke();const c=i+n*.08*r;t.beginPath(),t.moveTo(c,e+n*.25),t.lineTo(c,e+n*.45),t.stroke()}t.strokeStyle="#FFFFFF",t.lineWidth=3,t.lineCap="round",t.beginPath(),t.moveTo(i-n*.7,e-n*.5),t.lineTo(i+n*.7,e+n*.5),t.stroke(),t.beginPath(),t.moveTo(i+n*.7,e-n*.5),t.lineTo(i-n*.7,e+n*.5),t.stroke(),t.fillStyle="#FFFFFF";const o=n*.1,a=[{x:i-n*.7,y:e-n*.5},{x:i+n*.7,y:e+n*.5},{x:i+n*.7,y:e-n*.5},{x:i-n*.7,y:e+n*.5}];for(const r of a)t.beginPath(),t.arc(r.x,r.y,o,0,Math.PI*2),t.fill()}isComplete(){return this.state==="COMPLETE"}hasKilledPlayer(){return this._hasKilledPlayer}killDotsInExplosion(t){for(const i of t){if(i.isDead()||this.killedDotsInExplosion.has(i))continue;const e=i.getPosition(),s=e.x-this.orbPosition.x,n=e.y-this.orbPosition.y;Math.sqrt(s*s+n*n)<=this.explosionRadius&&(i.kill(),this.addKilledDot(),this.killedDotsInExplosion.add(i))}}checkAndKillPlayer(t){if(this._hasKilledPlayer)return;const i=t.position.x-this.orbPosition.x,e=t.position.y-this.orbPosition.y;Math.sqrt(i*i+e*e)<=this.explosionRadius&&(this._hasKilledPlayer=!0)}}const Q="tilt-to-live-highscores",Et=10;function z(){try{const l=localStorage.getItem(Q);return l?JSON.parse(l).sort((i,e)=>e.score-i.score):[]}catch(l){return console.error("Failed to load highscores:",l),[]}}function bt(l){const t=z(),i={score:l,timestamp:Date.now()};t.push(i),t.sort((n,o)=>o.score-n.score);const e=t.slice(0,Et),s=e.findIndex(n=>n.timestamp===i.timestamp&&n.score===l)+1;try{localStorage.setItem(Q,JSON.stringify(e))}catch(n){console.error("Failed to save highscores:",n)}return s>0?s:-1}class St{renderer;input;state=v.MENU;lastFrameTime=0;isPaused=!1;accumulator=0;player=null;bounds;timeAlive=0;scoringSystem=new dt;collisionSystem;difficultyManager=new ft;patternManager=new wt;orbSpawner=new Pt;activeWeapons=[];lastDeathEvent=null;menuElement;gameOverElement;permissionElement;newGameBtn;playAgainBtn;enableMotionBtn;finalScoreElement;newHighscoreElement;constructor(){this.renderer=new N("game"),this.input=new lt,this.bounds=this.renderer.getBounds(),this.collisionSystem=new ut(this.bounds),this.menuElement=document.getElementById("menu"),this.gameOverElement=document.getElementById("game-over"),this.permissionElement=document.getElementById("permission-prompt"),this.newGameBtn=document.getElementById("new-game-btn"),this.playAgainBtn=document.getElementById("play-again-btn"),this.enableMotionBtn=document.getElementById("enable-motion-btn"),this.finalScoreElement=document.getElementById("final-score"),this.newHighscoreElement=document.getElementById("new-highscore"),this.setupEventListeners(),this.checkPlatform(),this.gameLoop(0),this.displayMenuHighscores()}checkPlatform(){if(!("ontouchstart"in window)&&!("DeviceOrientationEvent"in window)){this.showElement("desktop-warning",!0);return}this.checkOrientation(),window.addEventListener("orientationchange",()=>this.checkOrientation()),window.addEventListener("resize",()=>this.checkOrientation())}checkOrientation(){const t=window.innerWidth>window.innerHeight;this.showElement("landscape-warning",t&&this.state===v.PLAYING)}showElement(t,i){const e=document.getElementById(t);e&&(e.style.display=i?"flex":"none")}displayMenuHighscores(){const t=document.getElementById("menu-highscores");if(t){const i=z();i.length===0?t.innerHTML='<li style="color: #666;">No scores yet</li>':t.innerHTML=i.slice(0,10).map((e,s)=>`<li>${s+1}. ${e.score}</li>`).join("")}}setupEventListeners(){this.newGameBtn.addEventListener("click",()=>this.handleNewGameClick()),this.playAgainBtn.addEventListener("click",()=>this.handleNewGameClick()),this.enableMotionBtn.addEventListener("click",()=>this.requestMotionPermission()),window.addEventListener("resize",()=>{this.bounds=this.renderer.getBounds()}),document.addEventListener("visibilitychange",()=>{document.hidden&&this.state===v.PLAYING?this.pause():!document.hidden&&this.state===v.PAUSED&&this.resume()})}async handleNewGameClick(){if(this.input.needsPermissionRequest()){this.menuElement.classList.add("hidden"),this.permissionElement.style.display="flex";return}this.startGame()}async requestMotionPermission(){await this.input.requestPermission()?(this.permissionElement.style.display="none",this.startGame()):alert("Motion permission denied. The game requires device motion to play.")}startGame(){this.state=v.PLAYING,this.timeAlive=0,this.lastDeathEvent=null,this.scoringSystem.start(),this.collisionSystem.updateBounds(this.bounds);const t=this.bounds.width/2,i=this.bounds.height/2;this.player=new ct(t,i),this.patternManager.clear(),this.orbSpawner.initialize(this.bounds,this.player.getPosition()),this.activeWeapons=[],this.input.calibrateTiltBasis(),this.menuElement.classList.add("hidden"),this.gameOverElement.classList.add("hidden"),R.clear()}handleGameOver(){const t=this.scoringSystem.getScore();this.state=v.GAME_OVER,this.finalScoreElement.textContent=`Score: ${t}`;const i=bt(t);i>0&&i<=3?(this.newHighscoreElement.textContent=i===1?"New #1 High Score!":`New #${i} High Score!`,this.newHighscoreElement.style.display="block"):this.newHighscoreElement.style.display="none";const s=document.getElementById("gameover-highscores");if(s){const a=z();s.innerHTML=a.slice(0,10).map((r,h)=>`<li${i>0&&h+1===i?' style="color: #FFD700; font-weight: bold;"':""}>${h+1}. ${r.score}</li>`).join("")}const n=document.getElementById("death-reason");n&&(n.textContent=this.lastDeathEvent?.message??"Unknown");const o=document.getElementById("recent-toasts");if(o){const a=R.getAllMessages();o.innerHTML=a.length>0?a.map(r=>`<li class="toast-${r.type}">${r.text}</li>`).join(""):'<li class="toast-info">No recent events</li>'}this.gameOverElement.classList.remove("hidden")}pause(){this.isPaused=!0}resume(){this.isPaused=!1,this.lastFrameTime=performance.now()}gameLoop=t=>{if(this.state!==v.PLAYING||this.isPaused){requestAnimationFrame(this.gameLoop);return}const i=t-this.lastFrameTime;for(this.lastFrameTime=t,this.accumulator+=i;this.accumulator>=H;)this.update(H/1e3),this.accumulator-=H;this.render(),requestAnimationFrame(this.gameLoop)};update(t){if(!this.player)return;this.timeAlive+=t;const i=this.input.getVelocity();this.player.update(t,i,this.bounds);const e=this.scoringSystem.getScore();this.difficultyManager.update(e),this.patternManager.setScore(e),this.patternManager.update(t,this.player.getPosition(),this.bounds);const s=this.patternManager.getAllDots();if(s.length===0&&!this.patternManager.isAnyPatternActivelySpawning()){const r=this.patternManager.selectNextPattern();r&&this.patternManager.spawnPattern(r,this.player.getPosition(),this.bounds)}this.orbSpawner.update(this.bounds,this.player.getPosition()),this.collisionSystem.rebuildGrid(s);const n=this.orbSpawner.getOrbs();for(const r of n)r.updatePosition(t,this.bounds);const o=this.collisionSystem.checkPlayerOrbCollision(this.player,n);if(o){const r=this.input.getVelocity();if(!o.bounce(r,this.player.getPosition())){const c=o.getWeaponType(),p=A.create(c);p&&(p.activate(this.player,s),this.activeWeapons.push(p),o.pickup(),this.orbSpawner.removeOrb(o),R.show(`Picked up ${this.formatWeaponName(c)}`,"success"))}}for(let r=this.activeWeapons.length-1;r>=0;r--){const h=this.activeWeapons[r];if(h.update(t,this.player,s,this.bounds),h.isActive()){const c=this.player.getPosition(),p=h.getPosition(),u=h.getRadius(),f=this.player.hitboxRadius,y=p.x-c.x,P=p.y-c.y,E=y*y+P*P,x=u+f;if(E<x*x){const T=this.input.getVelocity();h.handlePlayerCollision(this.player,T)}}if(h instanceof J&&h.hasKilledPlayer()){this.lastDeathEvent={message:"Killed by Nuclear Bomb explosion",type:"nuclear_bomb",timestamp:Date.now()},this.handleGameOver();return}h.isComplete()&&(this.scoringSystem.addKills(h.getKilledDots()),this.activeWeapons.splice(r,1))}const a=this.collisionSystem.checkPlayerDotCollision(this.player);a&&(a.isLethal()?(this.lastDeathEvent={message:"Hit by a red dot",type:"dot",timestamp:Date.now()},this.handleGameOver()):a.isFrozen()&&(a.kill(),this.scoringSystem.addKills(1)))}render(){this.renderer.clear(rt);const t=this.orbSpawner.getOrbs();for(let e=0;e<t.length;e++)t[e].render(this.renderer);const i=this.patternManager.getAllDots();for(let e=0;e<i.length;e++)i[e].render(this.renderer);for(let e=0;e<this.activeWeapons.length;e++)this.activeWeapons[e].render(this.renderer);this.player&&this.player.render(this.renderer),this.renderer.flushBatches(),this.renderer.endFrame()}getState(){return this.state}getScore(){return this.scoringSystem.getScore()}formatWeaponName(t){return t.toLowerCase().split("_").map(i=>i.charAt(0).toUpperCase()+i.slice(1)).join(" ")}}const W=8,xt="#00CCFF",It=1/K,At=k-1;class L{position;velocity;state;patternId=null;spawnElapsed=0;currentScale=k;radius=M;frozenTime=0;thawDuration=6e3;preThawWarningTime=500;isZombie=!1;zombieSpeed=50;vibrationOffset={x:0,y:0};frozenBorderThickness=W;constructor(t,i,e=null){this.position=new I(t,i),this.velocity={x:0,y:0},this.state=w.SPAWNING,this.patternId=e}update(t,i,e){if(this.state===w.SPAWNING){this.spawnElapsed+=t*1e3;const s=this.spawnElapsed*It;s>=1?(this.state=w.ACTIVE,this.currentScale=1):this.currentScale=k-At*s;return}if(this.state===w.FROZEN){this.frozenTime+=t*1e3;const s=Math.min(this.frozenTime/this.thawDuration,1);this.frozenBorderThickness=W*(1-s);const n=this.thawDuration-this.frozenTime;if(n<=this.preThawWarningTime&&n>0){const o=2*(1-n/this.preThawWarningTime);this.vibrationOffset.x=(Math.random()-.5)*o,this.vibrationOffset.y=(Math.random()-.5)*o}else this.vibrationOffset.x=0,this.vibrationOffset.y=0;this.frozenTime>=this.thawDuration&&this.thaw(e);return}if(this.state===w.ACTIVE){if(this.isZombie&&e){const s=e.x-this.position.x,n=e.y-this.position.y,o=Math.sqrt(s*s+n*n);o>0&&(this.velocity.x=s/o*this.zombieSpeed,this.velocity.y=n/o*this.zombieSpeed)}this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.patternId!==m.CYCLONE&&Z(this.position,i)}}render(t){const i=this.radius*this.currentScale;let e;switch(this.state){case w.SPAWNING:e=ot;break;case w.FROZEN:e=at;break;default:e=nt}const s=this.position.x+this.vibrationOffset.x,n=this.position.y+this.vibrationOffset.y;if(t.drawCircle(s,n,i,e),this.state===w.SPAWNING){const o=1-this.currentScale/k;t.drawCircleOutline(s,n,i*1.5,`rgba(255,102,102,${o.toFixed(2)})`)}this.state===w.FROZEN&&(t.drawCircleOutline(s,n,i+this.frozenBorderThickness,xt),t.drawCircle(s,n,i,e))}isLethal(){return this.state===w.ACTIVE}isFrozen(){return this.state===w.FROZEN}freeze(){(this.state===w.ACTIVE||this.state===w.SPAWNING)&&(this.state=w.FROZEN,this.velocity.x=0,this.velocity.y=0,this.frozenTime=0,this.frozenBorderThickness=W)}thaw(t){if(this.state===w.FROZEN&&(this.state=w.ACTIVE,this.isZombie=!0,this.vibrationOffset.x=0,this.vibrationOffset.y=0,t)){const i=t.x-this.position.x,e=t.y-this.position.y,s=Math.sqrt(i*i+e*e);s>0&&(this.velocity.x=i/s*this.zombieSpeed,this.velocity.y=e/s*this.zombieSpeed)}}kill(){this.state=w.DEAD}isDead(){return this.state===w.DEAD}getPosition(){return this.position}getRadius(){return this.radius}getEffectiveRadius(){return this.state===w.FROZEN?this.radius+this.frozenBorderThickness:this.radius}}class C{dots=[];elapsedMs=0;isStarted=!1;spawnDot(t,i,e={x:0,y:0}){const s=new L(t,i,this.type);return s.velocity.x=e.x,s.velocity.y=e.y,this.dots.push(s),s}getDots(){return this.dots.filter(t=>!t.isDead())}isComplete(){return!1}isActivelySpawning(){return!1}start(){this.elapsedMs=0,this.isStarted=!0}getElapsedTime(){return this.elapsedMs}tick(t){this.elapsedMs+=t*1e3}render(t){}clear(){for(let t=0;t<this.dots.length;t++)this.dots[t].kill();this.dots=[]}}class Tt extends C{type=m.ZOMBIE_SNOW;difficulty=d.EASY;spawnInterval;elapsedSinceSpawn=0;duration=15e3;dotSpeed=50;constructor(t=d.EASY){switch(super(),this.difficulty=t,t){case d.HARD:this.spawnInterval=150;break;case d.MEDIUM:this.spawnInterval=300;break;default:this.spawnInterval=500}}spawn(t,i){this.start()}update(t,i,e){this.elapsedMs<=this.duration&&(this.elapsedSinceSpawn+=t*1e3,this.elapsedSinceSpawn>=this.spawnInterval&&(this.elapsedSinceSpawn=0,this.spawnDotAtRandomPosition(e)));for(let s=this.dots.length-1;s>=0;s--){const n=this.dots[s];if(!n.isLethal()){n.update(t,e,i);continue}const o=n.getPosition();if(o.x<-100||o.x>e.width+100||o.y<-100||o.y>e.height+100){this.dots.splice(s,1);continue}const a=i.x-o.x,r=i.y-o.y,h=Math.sqrt(a*a+r*r);h>0&&(n.velocity.x=a/h*this.dotSpeed,n.velocity.y=r/h*this.dotSpeed),n.update(t,e,i)}}spawnDotAtRandomPosition(t){const i=M*2,e=j(t,i);this.spawnDot(e.x,e.y)}isComplete(){return this.elapsedMs>this.duration&&this.getDots().length===0}isActivelySpawning(){return this.elapsedMs<=this.duration}}class Dt extends C{type=m.SWEEPER_LINE;difficulty=d.EASY;duration=2e4;dotSpacing=20;holeSize=40;isHorizontal=!0;lineVelocity=0;sweepSpeed=150;linePos=0;lineOffset=0;dotOffsets=[];constructor(t=d.EASY){switch(super(),this.difficulty=t,t){case d.HARD:this.sweepSpeed=220;break;case d.MEDIUM:this.sweepSpeed=180;break;default:this.sweepSpeed=140}}spawn(t,i){this.start(),this.isHorizontal=Math.random()>.5,this.isHorizontal?this.lineOffset=Math.random()*(i.width-200)+100:this.lineOffset=Math.random()*(i.height-200)+100,this.isHorizontal?(this.lineVelocity=Math.random()>.5?this.sweepSpeed:-this.sweepSpeed,this.linePos=this.lineVelocity>0?-50:i.height+50):(this.lineVelocity=Math.random()>.5?this.sweepSpeed:-this.sweepSpeed,this.linePos=this.lineVelocity>0?-50:i.width+50),this.generateLineWithHoles(i)}generateLineWithHoles(t){const i=Math.floor(Math.random()*2)+2,e=this.isHorizontal?t.height:t.width,s=Math.floor((e-100)/this.dotSpacing),n=new Set,o=Math.ceil(this.holeSize/this.dotSpacing);for(let r=0;r<i;r++){const h=Math.floor(Math.random()*(s-10))+5;for(let c=-Math.floor(o/2);c<=Math.floor(o/2);c++)n.add(h+c)}const a=(e-s*this.dotSpacing)/2;for(let r=0;r<s;r++)if(!n.has(r)){const h=a+r*this.dotSpacing;this.dotOffsets.push(h),this.isHorizontal?this.spawnDot(this.lineOffset+h-e/2,this.linePos,{x:0,y:0}):this.spawnDot(this.linePos,this.lineOffset+h-e/2,{x:0,y:0})}}update(t,i,e){this.linePos+=this.lineVelocity*t,this.isHorizontal?this.lineVelocity>0&&this.linePos>e.height+50?this.lineVelocity=-this.sweepSpeed:this.lineVelocity<0&&this.linePos<-50&&(this.lineVelocity=this.sweepSpeed):this.lineVelocity>0&&this.linePos>e.width+50?this.lineVelocity=-this.sweepSpeed:this.lineVelocity<0&&this.linePos<-50&&(this.lineVelocity=this.sweepSpeed);const s=this.isHorizontal?e.height:e.width;for(let n=0;n<this.dots.length;n++){const o=this.dots[n];if(o.isFrozen()){o.update(t,e,i);continue}if(!o.isLethal()){o.update(t,e,i);continue}const a=this.dotOffsets[n];this.isHorizontal?(o.position.x=this.lineOffset+a-s/2,o.position.y=this.linePos):(o.position.x=this.linePos,o.position.y=this.lineOffset+a-s/2),o.update(t,e,i)}for(let n=this.dots.length-1;n>=0;n--)this.dots[n].isDead()&&(this.dots.splice(n,1),this.dotOffsets.splice(n,1))}isComplete(){return this.elapsedMs>this.duration&&this.dots.length===0}}class Ct extends C{type=m.SPARSE_GRID;difficulty=d.EASY;dotSpeed=20;constructor(t=d.EASY){switch(super(),this.difficulty=t,t){case d.HARD:this.dotSpeed=40;break;case d.MEDIUM:this.dotSpeed=30;break;default:this.dotSpeed=20}}spawn(t,i){this.start(),this.spawnGrid(i)}update(t,i,e){for(let s=this.dots.length-1;s>=0;s--){const n=this.dots[s];if(!n.isLethal()){n.update(t,e,i);continue}const o=n.getPosition();if(o.x<-100||o.x>e.width+100||o.y<-100||o.y>e.height+100){this.dots.splice(s,1);continue}const a=i.x-o.x,r=i.y-o.y,h=Math.sqrt(a*a+r*r);if(h>0){const c=h>50?this.dotSpeed:this.dotSpeed*(h/50);n.velocity.x=a/h*c,n.velocity.y=r/h*c}n.update(t,e,i)}}spawnGrid(t){const s=Math.floor((t.width-200)/85),n=Math.floor((t.height-200)/85);for(let o=0;o<n;o++)for(let a=0;a<s;a++){const r=100+a*85+42.5,h=100+o*85+85/2;this.spawnDot(r,h,{x:0,y:0})}}isComplete(){return this.getDots().length===0}}class vt extends C{type=m.BOUNCING_BALL;difficulty=d.MEDIUM;duration=3e4;ballRadius=120;dotCount=200;centerPosition={x:0,y:0};centerVelocity={x:0,y:0};dotOffsets=[];speed=120;constructor(t=d.MEDIUM){switch(super(),this.difficulty=t,t){case d.HARD:this.speed=180;break;case d.MEDIUM:this.speed=120;break;default:this.speed=80}}spawn(t,i){this.start(),this.centerPosition={x:i.width/2,y:i.height/2};const e=Math.random()*Math.PI*2;this.centerVelocity={x:Math.cos(e)*this.speed,y:Math.sin(e)*this.speed},this.spawnDots()}spawnDots(){this.dotOffsets=[];const t=20,i=Math.ceil(this.dotCount/t);for(let e=0;e<i;e++){const s=this.ballRadius*(e+1)/i,n=Math.min(t,this.dotCount-this.dotOffsets.length);for(let o=0;o<n;o++){const a=o/n*Math.PI*2;this.dotOffsets.push({x:Math.cos(a)*s,y:Math.sin(a)*s})}if(this.dotOffsets.length>=this.dotCount)break}for(let e=0;e<this.dotOffsets.length;e++){const s=this.dotOffsets[e];this.spawnDot(this.centerPosition.x+s.x,this.centerPosition.y+s.y,{x:this.centerVelocity.x,y:this.centerVelocity.y})}}update(t,i,e){this.centerPosition.x+=this.centerVelocity.x*t,this.centerPosition.y+=this.centerVelocity.y*t;const s=this.ballRadius+M,n=e.width-this.ballRadius-M,o=this.ballRadius+M,a=e.height-this.ballRadius-M;this.centerPosition.x<=s?(this.centerPosition.x=s,this.centerVelocity.x=Math.abs(this.centerVelocity.x)):this.centerPosition.x>=n&&(this.centerPosition.x=n,this.centerVelocity.x=-Math.abs(this.centerVelocity.x)),this.centerPosition.y<=o?(this.centerPosition.y=o,this.centerVelocity.y=Math.abs(this.centerVelocity.y)):this.centerPosition.y>=a&&(this.centerPosition.y=a,this.centerVelocity.y=-Math.abs(this.centerVelocity.y));for(let r=0;r<this.dots.length;r++){const h=this.dots[r];if(h.isFrozen()){h.update(t,e,i);continue}const c=this.dotOffsets[r];if(c&&!h.isDead()){const p=this.centerPosition.x+c.x,u=this.centerPosition.y+c.y,f=h.position.x-p,y=h.position.y-u;this.centerPosition.x+=f,this.centerPosition.y+=y;const P=this.centerPosition.x+c.x,E=this.centerPosition.y+c.y;h.position.x=P,h.position.y=E,h.velocity.x=this.centerVelocity.x,h.velocity.y=this.centerVelocity.y}h.update(t,e,i)}}isComplete(){return this.elapsedMs>this.duration&&this.getDots().length===0}}class Rt extends C{type=m.GATLING_POINT;difficulty=d.MEDIUM;shootDuration;dotSpeed=400;shootInterval=100;elapsedSinceSpawn=0;spawnPoint={x:0,y:0};spawnPointDot=null;spawnPointRadius=M*2.5;spawnPointDead=!1;constructor(t=d.MEDIUM){switch(super(),this.difficulty=t,t){case d.HARD:this.shootDuration=6e3,this.shootInterval=50;break;case d.MEDIUM:this.shootDuration=4500,this.shootInterval=80;break;default:this.shootDuration=3e3,this.shootInterval=100}}spawn(t,i){this.start();const e=50;this.spawnPoint=j(i,e),this.spawnPointDot=new L(this.spawnPoint.x,this.spawnPoint.y,this.type),this.spawnPointDot.state=w.ACTIVE,Object.defineProperty(this.spawnPointDot,"radius",{value:this.spawnPointRadius,writable:!1,configurable:!0}),this.dots.push(this.spawnPointDot)}update(t,i,e){this.spawnPointDot&&!this.spawnPointDead&&(this.spawnPointDot.isDead()?this.spawnPointDead=!0:this.spawnPointDot.isFrozen()||this.elapsedMs<=this.shootDuration&&(this.elapsedSinceSpawn+=t*1e3,this.elapsedSinceSpawn>=this.shootInterval&&(this.elapsedSinceSpawn=0,this.spawnDotAtPoint(i))));for(let s=this.dots.length-1;s>=0;s--){const n=this.dots[s];if(!n.isLethal()){n.update(t,e,i);continue}const o=n.getPosition(),a=n.velocity;if(o.x<-100||o.x>e.width+100||o.y<-100||o.y>e.height+100){this.dots.splice(s,1);continue}(o.x<M||o.x>e.width-M)&&(a.x=-a.x*.5),(o.y<M||o.y>e.height-M)&&(a.y=-a.y*.5),n.update(t,e,i)}}spawnDotAtPoint(t){const i=t.x-this.spawnPoint.x,e=t.y-this.spawnPoint.y,s=Math.sqrt(i*i+e*e);s>0?this.spawnDot(this.spawnPoint.x,this.spawnPoint.y,{x:i/s*this.dotSpeed,y:e/s*this.dotSpeed}):this.spawnDot(this.spawnPoint.x,this.spawnPoint.y)}isComplete(){return this.spawnPointDead||this.spawnPointDot&&this.spawnPointDot.isFrozen()?this.getDots().length===0:this.elapsedMs>this.shootDuration&&this.getDots().length===0}isActivelySpawning(){return this.spawnPointDead||this.spawnPointDot&&this.spawnPointDot.isFrozen()?!1:this.elapsedMs<=this.shootDuration}getSpawnPointDot(){return this.spawnPointDot}isSpawnPointDead(){return this.spawnPointDead}render(t){if(super.render?.(t),this.spawnPointDot&&!this.spawnPointDot.isDead()&&!this.spawnPointDot.isFrozen()){const i=this.spawnPointDot.getPosition(),e=1+Math.sin(this.elapsedMs*.005)*.2;t.drawCircleOutline(i.x,i.y,this.spawnPointRadius*e,"#FFD700",3),t.drawCircleOutline(i.x,i.y,this.spawnPointRadius*e*1.3,"rgba(255, 215, 0, 0.3)",1)}}}class Ot extends C{type=m.BULLET_HELL;difficulty=d.HARD;duration=15e3;baseDotSpeed=250;warningDuration=K;spawnInterval=150;originX=0;originY=0;hasStartedSpawning=!1;spawnAccumulator=0;patternPhase=0;spawnTimeoutId=null;constructor(t=d.HARD){switch(super(),this.difficulty=t,t){case d.HARD:this.duration=15e3;break;case d.MEDIUM:this.duration=12e3;break}}spawn(t,i){this.start(),this.hasStartedSpawning=!1,this.spawnAccumulator=0,this.patternPhase=0,this.originX=i.width/2,this.originY=-30,this.spawnTimeoutId=window.setTimeout(()=>{this.hasStartedSpawning=!0},this.warningDuration)}update(t,i,e){if(this.hasStartedSpawning&&this.elapsedMs<=this.duration+this.warningDuration)for(this.spawnAccumulator+=t*1e3;this.spawnAccumulator>=this.spawnInterval;)this.spawnAccumulator-=this.spawnInterval,this.spawnBulletWave(i);this.patternPhase+=t*.5;for(let s=this.dots.length-1;s>=0;s--){const n=this.dots[s];if(n.isFrozen()){n.update(t,e,i);continue}const o=n.getPosition();if(o.x<-M||o.x>e.width+M||o.y<-M||o.y>e.height+M){this.dots.splice(s,1);continue}n.position.x+=n.velocity.x*t,n.position.y+=n.velocity.y*t}}render(t){if(super.render?.(t),!this.hasStartedSpawning&&this.isStarted){const i=Math.min(this.elapsedMs/this.warningDuration,1),e=1.5-.5*i,s=1-i;t.drawCircle(this.originX,this.originY,M*e*2,`rgba(255, 102, 102, ${s.toFixed(2)})`),t.drawCircleOutline(this.originX,this.originY,M*e*3,`rgba(255, 0, 0, ${s.toFixed(2)})`)}}spawnBulletWave(t){const i=this.elapsedMs*.001;switch(Math.floor(i/3)%4){case 0:this.spawnSpiral();break;case 1:this.spawnCircleBurst();break;case 2:this.spawnAimedStreams(t);break;case 3:this.spawnWavePattern();break}}spawnSpiral(){for(let s=0;s<3;s++){const n=this.patternPhase*2+s*Math.PI*2/3;for(let o=0;o<2;o++){const a=n+o*.1,r=this.baseDotSpeed*(.8+o*.1),h=new L(this.originX,this.originY,this.type);h.velocity.x=Math.cos(a)*r,h.velocity.y=Math.sin(a)*r,h.state=w.ACTIVE,this.dots.push(h)}}}spawnCircleBurst(){const i=Math.PI*2/16;for(let e=0;e<16;e++){const s=e*i+this.patternPhase*.5,n=new L(this.originX,this.originY,this.type);n.velocity.x=Math.cos(s)*this.baseDotSpeed,n.velocity.y=Math.sin(s)*this.baseDotSpeed,n.state=w.ACTIVE,this.dots.push(n)}}spawnAimedStreams(t){const e=Math.atan2(t.y-this.originY,t.x-this.originX);for(let s=0;s<5;s++){const n=(s-Math.floor(2.5))*.15,o=e+n,a=this.baseDotSpeed*(.9+Math.random()*.2),r=new L(this.originX,this.originY,this.type);r.velocity.x=Math.cos(o)*a,r.velocity.y=Math.sin(o)*a,r.state=w.ACTIVE,this.dots.push(r)}}spawnWavePattern(){const t=Math.PI,i=7,e=Math.PI/2+Math.sin(this.patternPhase*2)*.3;for(let s=0;s<i;s++){const n=(s/(i-1)-.5)*t,o=e+n,a=this.baseDotSpeed*(.7+Math.abs(n)*.3),r=new L(this.originX,this.originY,this.type);r.velocity.x=Math.cos(o)*a,r.velocity.y=Math.sin(o)*a,r.state=w.ACTIVE,this.dots.push(r)}}isComplete(){return this.elapsedMs>this.duration+this.warningDuration&&this.getDots().length===0}isActivelySpawning(){return this.elapsedMs<=this.duration+this.warningDuration}clear(){this.spawnTimeoutId!==null&&(window.clearTimeout(this.spawnTimeoutId),this.spawnTimeoutId=null),this.hasStartedSpawning=!1,super.clear()}}class Lt extends C{type=m.CONTAINMENT_RING;difficulty=d.EASY;ringRadius=100;dotSpeed=30;dotCount=40;innerRadius=20;constructor(t=d.EASY){super(),this.difficulty=t}spawn(t,i){this.start(),this.spawnRing(t,i)}update(t,i,e){for(let s=this.dots.length-1;s>=0;s--){const n=this.dots[s];if(!n.isLethal()){n.update(t,e,i);continue}const o=n.getPosition();if(o.x<-100||o.x>e.width+100||o.y<-100||o.y>e.height+100){this.dots.splice(s,1);continue}const a=i.x-o.x,r=i.y-o.y,h=Math.sqrt(a*a+r*r);h>this.innerRadius?(n.velocity.x=a/h*this.dotSpeed,n.velocity.y=r/h*this.dotSpeed):(n.velocity.x=0,n.velocity.y=0),n.update(t,e,i)}}spawnRing(t,i){const e=Math.floor(Math.random()*5),s=e>0?2:0,n=[];for(let o=0;o<e;o++){const a=this.dotCount*o/e+Math.floor(this.dotCount/(e*2)),r=a-s,h=a+s;n.push([r,h])}for(let o=0;o<this.dotCount;o++){if(n.some(([p,u])=>o>=p&&o<=u))continue;const r=2*Math.PI*o/this.dotCount,h=t.x+this.ringRadius*Math.cos(r),c=t.y+this.ringRadius*Math.sin(r);this.spawnDot(h,c)}}isComplete(){return this.getDots().length===0}}class Nt extends C{type=m.CYCLONE;difficulty=d.HARD;duration=25e3;circleRadius=50;dotSpeed=150;constructor(t=d.HARD){switch(super(),this.difficulty=t,t){case d.HARD:this.dotSpeed=300,this.circleRadius=80;break;case d.MEDIUM:this.dotSpeed=200,this.circleRadius=60;break;default:this.dotSpeed=150,this.circleRadius=50}}spawn(t,i){this.start(),this.spawnDots(i)}update(t,i,e){for(let s=this.dots.length-1;s>=0;s--){const n=this.dots[s];if(!n.isLethal()){n.update(t,e,i);continue}const o=n.getPosition();if(o.x<-50||o.x>e.width+50||o.y<-50||o.y>e.height+50){this.dots.splice(s,1);continue}n.update(t,e,i)}}spawnDots(t){const i=[{x:t.width*.15,y:t.height*.15},{x:t.width*.85,y:t.height*.15},{x:t.width*.15,y:t.height*.85},{x:t.width*.85,y:t.height*.85}],e=i[Math.floor(Math.random()*i.length)],s=150;for(let n=0;n<s;n++){const a=n/s*Math.PI*2+(Math.random()-.5)*.2,r=this.circleRadius*(.8+Math.random()*.4),h=e.x+Math.cos(a)*r,c=e.y+Math.sin(a)*r,p=a+Math.PI/2+(Math.random()-.5)*.5,u=this.dotSpeed*(.5+Math.random()*1);this.spawnDot(h,c,{x:Math.cos(p)*u,y:Math.sin(p)*u})}}isComplete(){return this.elapsedMs>this.duration&&this.getDots().length===0}}class Ft extends C{type=m.CLOCK_SWEEP;difficulty=d.MEDIUM;duration=25e3;center={x:0,y:0};hands=[];spawnProgress=0;spawnDuration=2e3;hasFinishedSpawning=!1;secondHandSpeed=1.5;secondHandLength=400;secondHandDotCount=15;minuteHandSpeed=.4;minuteHandLength=350;minuteHandDotCount=20;hourHandSpeed=.15;hourHandLength=200;hourHandDotCount=25;constructor(t=d.MEDIUM){switch(super(),this.difficulty=t,t){case d.HARD:this.hands=[this.createHand(this.secondHandSpeed*1.3,this.secondHandLength,this.secondHandDotCount,[]),this.createHand(this.minuteHandSpeed*1.2,this.minuteHandLength,this.minuteHandDotCount,[8,9,10]),this.createHand(this.hourHandSpeed*1.2,this.hourHandLength,this.hourHandDotCount+5,[])];break;case d.MEDIUM:this.hands=[this.createHand(this.secondHandSpeed,this.secondHandLength,this.secondHandDotCount,[]),this.createHand(this.minuteHandSpeed,this.minuteHandLength,this.minuteHandDotCount,[9,10,11]),this.createHand(this.hourHandSpeed,this.hourHandLength,this.hourHandDotCount,[])];break;default:this.hands=[this.createHand(this.secondHandSpeed*.8,this.secondHandLength*.9,this.secondHandDotCount-3,[]),this.createHand(this.minuteHandSpeed*.8,this.minuteHandLength*.9,this.minuteHandDotCount-3,[9,10]),this.createHand(this.hourHandSpeed*.8,this.hourHandLength*.9,this.hourHandDotCount-5,[])]}}createHand(t,i,e,s){const n=[],o=i/(e-1);for(let a=0;a<e;a++)s.includes(a)||n.push({index:a,distance:a*o,angleOffset:0});return{angle:Math.random()*Math.PI*2,speed:t,length:i,dotCount:e,gaps:s,dots:n}}spawn(t,i){this.start(),this.center=t,this.spawnProgress=0,this.hasFinishedSpawning=!1;for(const e of this.hands)for(const s of e.dots)this.spawnDot(this.center.x,this.center.y,{x:0,y:0})}update(t,i,e){this.hasFinishedSpawning||(this.spawnProgress+=t*1e3,this.spawnProgress>=this.spawnDuration&&(this.hasFinishedSpawning=!0,this.spawnProgress=this.spawnDuration));const s=this.hasFinishedSpawning?1:this.spawnProgress/this.spawnDuration;for(const o of this.hands)o.angle+=o.speed*t;let n=0;for(const o of this.hands)for(const a of o.dots){if(n>=this.dots.length)break;const r=this.dots[n];if(n++,r.isFrozen()){r.update(t,e,i);continue}if(!r.isLethal()){r.update(t,e,i);continue}const h=a.distance*s,c=this.center.x+Math.cos(o.angle)*h,p=this.center.y+Math.sin(o.angle)*h;r.position.x=c,r.position.y=p,r.velocity.x=0,r.velocity.y=0,this.hasFinishedSpawning,r.update(t,e,i)}for(let o=this.dots.length-1;o>=0;o--)this.dots[o].isDead()&&this.dots.splice(o,1)}isComplete(){return this.elapsedMs>this.duration&&this.dots.length===0}}class _t extends D{type=g.BLASTER;state="AIMING";aimTime=1e3;aimStartTime=0;beamPosition=0;prevBeamPosition=0;beamAngle=0;playerPosition={x:0,y:0};playerAngle=0;beamOriginPosition={x:0,y:0};activate(t,i){this.start(),this.dots=i,this.aimStartTime=Date.now(),this.playerPosition=t.getPosition(),this.playerAngle=t.directionAngle,this.beamAngle=this.playerAngle,this.state="AIMING"}update(t,i,e,s){if(this.state==="COMPLETE")return;const n=Date.now()-this.aimStartTime;this.state==="AIMING"?(this.playerPosition=i.getPosition(),this.playerAngle=i.directionAngle,n>=this.aimTime&&(this.state="FIRING",this.beamAngle=this.playerAngle,this.beamOriginPosition={...this.playerPosition})):this.state==="FIRING"&&(this.prevBeamPosition=this.beamPosition,this.beamPosition+=500*t,this.checkBeamCollision(e),this.beamPosition>Math.max(s.width,s.height)&&(this.state="COMPLETE"))}checkBeamCollision(t){if(!t||t.length===0)return;const i=Math.cos(this.beamAngle),e=Math.sin(this.beamAngle);for(const s of t)if(!s.isDead()){const n=s.getPosition(),o=s.getRadius(),a=n.x-this.beamOriginPosition.x,r=n.y-this.beamOriginPosition.y,h=a*i+r*e,c=a*e-r*i,p=50+o,u=100+o;if(!(Math.abs(c)<=p))continue;const y=this.prevBeamPosition-u,P=this.beamPosition+u;h>=y&&h<=P&&(s.kill(),this.addKilledDot())}}render(t){if(this.state==="COMPLETE")return;const i=t.getContext();if(this.state==="AIMING"){const e=this.playerPosition.x,s=this.playerPosition.y;i.save(),i.translate(e,s),i.rotate(this.playerAngle),i.fillStyle="rgb(128, 0, 128)",i.fillRect(0,-6,20,12),i.restore()}else if(this.state==="FIRING"){const e=this.beamOriginPosition.x+this.beamPosition*Math.cos(this.beamAngle),s=this.beamOriginPosition.y+this.beamPosition*Math.sin(this.beamAngle);i.save(),i.translate(e,s),i.rotate(this.beamAngle),i.fillStyle="rgba(128, 0, 255, 0.78)",i.fillRect(-5,-75,10,150),i.restore()}}isComplete(){return this.state==="COMPLETE"}}class Bt extends D{type=g.CHAINSAW;duration=5e3;chainsawRadius=50;playerPosition={x:0,y:0};warningStartTime=4200;flashDuration=100;flashGap=300;activate(t,i){this.start(),this.playerPosition=t.getPosition()}update(t,i,e,s){if(!(this.getElapsedTime()>=this.duration)&&!(!e||e.length===0)){this.playerPosition=i.getPosition();for(const n of e){if(n.isDead())continue;const o=n.getPosition(),a=o.x-this.playerPosition.x,r=o.y-this.playerPosition.y;Math.sqrt(a*a+r*r)<=this.chainsawRadius&&(n.kill(),this.addKilledDot())}}}shouldShowVisual(){const t=this.getElapsedTime();if(t<this.warningStartTime)return!0;const i=t-this.warningStartTime,e=i<this.flashDuration,s=i>=this.flashGap&&i<this.flashGap+this.flashDuration;return!e&&!s}render(t){if(!this.shouldShowVisual())return;const e=this.getElapsedTime()/50%(Math.PI*2),s=8,n=this.chainsawRadius*.7,o=this.chainsawRadius;t.drawCircle(this.playerPosition.x,this.playerPosition.y,this.chainsawRadius,q.CHAINSAW+"66");const a=t.getContext();a.save(),a.translate(this.playerPosition.x,this.playerPosition.y),a.rotate(e),a.fillStyle="#E0E0E0";for(let r=0;r<s;r++){const h=r/s*Math.PI*2,c=(r+1)/s*Math.PI*2;a.beginPath(),a.moveTo(Math.cos(h)*n,Math.sin(h)*n),a.lineTo(Math.cos(h+(c-h)*.5)*o,Math.sin(h+(c-h)*.5)*o),a.lineTo(Math.cos(c)*n,Math.sin(c)*n),a.closePath(),a.fill()}a.fillStyle="#808080",a.beginPath(),a.arc(0,0,n*.5,0,Math.PI*2),a.fill(),a.restore()}isComplete(){return this.getElapsedTime()>=this.duration}getChainsawRadius(){return this.chainsawRadius}}class kt extends D{type=g.DOT_REPELLENT;duration=8e3;fieldRadius=100;playerPosition={x:0,y:0};activate(t,i){this.start(),this.dots=[],this.playerPosition=t.getPosition()}update(t,i,e,s){if(!(this.getElapsedTime()>=this.duration)&&!(!e||e.length===0)){this.playerPosition=i.getPosition();for(const o of e){if(o.isDead())continue;const a=o.getPosition(),r=a.x-this.playerPosition.x,h=a.y-this.playerPosition.y,c=Math.sqrt(r*r+h*h);if(c<this.fieldRadius&&c>0){const p=5*(1-c/this.fieldRadius);o.position.x+=r/c*p,o.position.y+=h/c*p}}}}render(t){const i=t.getContext();i.save(),i.beginPath(),i.arc(this.playerPosition.x,this.playerPosition.y,this.fieldRadius,0,Math.PI*2),i.strokeStyle="rgba(128, 128, 128, 0.3)",i.lineWidth=3,i.stroke(),i.restore()}isComplete(){return this.getElapsedTime()>=this.duration}}class Ht extends D{type=g.ELECTRIC_BOMB;state="ROLLING";orbPosition={x:0,y:0};orbVelocity={x:0,y:0};chainNodes=[];lightningArcs=[];dotsToProcess=[];initialRadiusFactor=.15;chainRadiusFactor=.1;maxChainDepth=50;orbSpeed=300;orbRadius=12;rollingDuration=2e3;chainDelayMs=80;lastChainTime=0;bounds=null;lastCollisionTime=0;collisionCooldown=100;activate(t,i){this.dots=i,this.start(),this.orbPosition={...t.getPosition()};const e=Math.random()*Math.PI*2;this.orbVelocity={x:Math.cos(e)*this.orbSpeed,y:Math.sin(e)*this.orbSpeed},this.state="ROLLING"}update(t,i,e,s){switch(this.bounds===null&&(this.bounds=s),this.state){case"ROLLING":this.updateRolling(t,s);break;case"CHAINING":this.updateChaining(e,i,s);break}}getPosition(){return this.orbPosition}getRadius(){return this.orbRadius}handlePlayerCollision(t,i){const e=Date.now();if(e-this.lastCollisionTime<this.collisionCooldown)return!1;this.lastCollisionTime=e;const s=this.orbPosition.x-t.position.x,n=this.orbPosition.y-t.position.y,o=Math.sqrt(s*s+n*n),a=50,r=Math.sqrt(i.x**2+i.y**2);if(r<a)return!1;if(o===0)return this.orbVelocity.x=i.x,this.orbVelocity.y=i.y,!0;const h=s/o,c=n/o,p=-c,u=h,f=i.x*h+i.y*c,y=i.x*p+i.y*u,P=f/r;if(P<.1)return!1;const E=1.5;if(P>.7)this.orbVelocity.x=i.x*E,this.orbVelocity.y=i.y*E;else{const x=P,T=1-P;this.orbVelocity.x=(h*f*x+p*y*T)*E,this.orbVelocity.y=(c*f*x+u*y*T)*E}return!0}updateRolling(t,i){this.orbPosition.x+=this.orbVelocity.x*t,this.orbPosition.y+=this.orbVelocity.y*t,this.orbPosition.x-this.orbRadius<0?(this.orbPosition.x=this.orbRadius,this.orbVelocity.x=Math.abs(this.orbVelocity.x)):this.orbPosition.x+this.orbRadius>i.width&&(this.orbPosition.x=i.width-this.orbRadius,this.orbVelocity.x=-Math.abs(this.orbVelocity.x)),this.orbPosition.y-this.orbRadius<0?(this.orbPosition.y=this.orbRadius,this.orbVelocity.y=Math.abs(this.orbVelocity.y)):this.orbPosition.y+this.orbRadius>i.height&&(this.orbPosition.y=i.height-this.orbRadius,this.orbVelocity.y=-Math.abs(this.orbVelocity.y)),this.getElapsedTime()>=this.rollingDuration&&this.triggerInitialExplosion()}triggerInitialExplosion(){this.state="CHAINING",this.lastChainTime=Date.now(),R.show("Electric Bomb discharged!","warning");const t=(this.bounds?.width??800)*this.initialRadiusFactor;this.chainNodes.push({x:this.orbPosition.x,y:this.orbPosition.y,radius:t,activatedAt:Date.now(),chainDepth:0}),this.findAndElectrifyDots(this.chainNodes[0])}findAndElectrifyDots(t){for(const i of this.dots){if(i.isDead())continue;const e=i.getPosition(),s=e.x-t.x,n=e.y-t.y;if(Math.sqrt(s*s+n*n)<=t.radius){i.kill(),this.addKilledDot(),this.lightningArcs.push({x1:t.x,y1:t.y,x2:e.x,y2:e.y,createdAt:Date.now(),chainDepth:t.chainDepth});const a={x:e.x,y:e.y,radius:(this.bounds?.width??800)*this.chainRadiusFactor,activatedAt:Date.now(),chainDepth:t.chainDepth+1,parentX:t.x,parentY:t.y};this.chainNodes.push(a),this.dotsToProcess.push(i)}}}updateChaining(t,i,e){if(!t||t.length===0){this.state="COMPLETE";return}const s=Date.now();if(s-this.lastChainTime<this.chainDelayMs)return;this.lastChainTime=s;const n=this.chainNodes.filter(o=>o.chainDepth>0&&s-o.activatedAt<100&&o.chainDepth<this.maxChainDepth);if(n.length===0){this.checkPlayerHit(i);const o=this.chainNodes.filter(r=>s-r.activatedAt<600),a=this.chainNodes.some(r=>r.chainDepth>0);(o.length===0||!a)&&(this.state="COMPLETE");return}for(const o of n)this.findAndElectrifyDots(o);this.checkPlayerHit(i)}checkPlayerHit(t){}render(t){this.state==="ROLLING"?(t.drawCircle(this.orbPosition.x,this.orbPosition.y,this.orbRadius,"#00FFFF"),t.drawCircleOutline(this.orbPosition.x,this.orbPosition.y,this.orbRadius+4,"rgba(0, 255, 255, 0.5)",2)):(this.state==="CHAINING"||this.state==="COMPLETE")&&(this.renderChainNodes(t),this.renderLightning(t))}renderChainNodes(t){const i=Date.now(),e=500;this.chainNodes=this.chainNodes.filter(s=>i-s.activatedAt<e+100);for(const s of this.chainNodes){const n=i-s.activatedAt,o=Math.max(0,1-n/e);o>0&&(t.drawCircle(s.x,s.y,s.radius,`rgba(0, 255, 255, ${o*.3})`),t.drawCircleOutline(s.x,s.y,s.radius,`rgba(0, 255, 255, ${o})`,3))}}renderLightning(t){const i=Date.now(),e=500;this.lightningArcs=this.lightningArcs.filter(s=>i-s.createdAt<e);for(const s of this.lightningArcs){const n=i-s.createdAt,o=Math.max(0,1-n/e);o>0&&this.drawJaggedLightning(t,s.x1,s.y1,s.x2,s.y2,o,s.chainDepth)}}drawJaggedLightning(t,i,e,s,n,o,a){const r=3+Math.min(a,3),h=6+a*2,c=`rgba(0, 200, 255, ${o})`,p=`rgba(100, 230, 255, ${o*.5})`,u=[];u.push({x:i,y:e});for(let f=1;f<r;f++){const y=f/r,P=i+(s-i)*y,E=e+(n-e)*y,x=(Math.random()-.5)*h*2,T=(Math.random()-.5)*h*2;u.push({x:P+x,y:E+T})}u.push({x:s,y:n});for(let f=0;f<u.length-1;f++)t.drawLine(u[f].x,u[f].y,u[f+1].x,u[f+1].y,p,4);for(let f=0;f<u.length-1;f++)t.drawLine(u[f].x,u[f].y,u[f+1].x,u[f+1].y,c,2)}isActive(){return this.state==="ROLLING"}isComplete(){return this.state==="COMPLETE"}hasKilledPlayer(){return!1}getExplosionCount(){return this.chainNodes.length}}class Gt extends D{type=g.FLAME_BURST;FLAME_DURATION_MS=3e3;CONE_ANGLE_RAD=Math.PI/3;FLAME_REACH_PX=200;TRAIL_DURATION_MS=1e3;PARTICLE_MAX_AGE_MS=200;PARTICLE_AGE_VARIANCE_MS=100;PARTICLES_PER_FRAME=5;FRAME_TIME_MS=16;playerPosition={x:0,y:0};playerAngle=0;flames=[];trails=[];flameActive=!1;complete=!1;activate(t,i){this.start(),this.dots=i,this.playerPosition=t.getPosition(),this.playerAngle=t.directionAngle,this.flames=[],this.trails=[],this.flameActive=!0,this.complete=!1}update(t,i,e,s){if(this.complete)return;if(this.getElapsedTime()>=this.FLAME_DURATION_MS){this.flameActive=!1;const a=Date.now();this.trails=this.trails.filter(r=>a-r.startTime<r.duration),this.trails.length===0&&(this.complete=!0);return}this.playerPosition=i.getPosition(),this.playerAngle=i.directionAngle,this.spawnFlameParticles(),this.flames=this.flames.filter(a=>(a.age+=this.FRAME_TIME_MS,a.age<a.maxAge)),Math.random()<.3&&this.spawnFireTrail();const o=Date.now();this.trails=this.trails.filter(a=>o-a.startTime<a.duration),this.killDotsInFlameCone(e)}spawnFlameParticles(){for(let t=0;t<this.PARTICLES_PER_FRAME;t++){const i=(Math.random()-.5)*this.CONE_ANGLE_RAD,e=this.playerAngle+i,s=Math.random()*this.FLAME_REACH_PX,n=(Math.random()-.5)*20,o=(Math.random()-.5)*20;this.flames.push({x:this.playerPosition.x+Math.cos(e)*s+n,y:this.playerPosition.y+Math.sin(e)*s+o,age:0,maxAge:this.PARTICLE_MAX_AGE_MS+Math.random()*this.PARTICLE_AGE_VARIANCE_MS})}}spawnFireTrail(){const t=(Math.random()-.5)*this.CONE_ANGLE_RAD,i=this.playerAngle+t,e=20+Math.random()*60;this.trails.push({x:this.playerPosition.x+Math.cos(i)*e,y:this.playerPosition.y+Math.sin(i)*e,startTime:Date.now(),duration:this.TRAIL_DURATION_MS})}killDotsInFlameCone(t){if(!t||t.length===0)return;const i=this.CONE_ANGLE_RAD/2;for(const e of t){if(e.isDead())continue;const s=e.getPosition(),n=s.x-this.playerPosition.x,o=s.y-this.playerPosition.y;if(Math.sqrt(n*n+o*o)>this.FLAME_REACH_PX)continue;let h=Math.atan2(o,n)-this.playerAngle;for(;h>Math.PI;)h-=Math.PI*2;for(;h<-Math.PI;)h+=Math.PI*2;Math.abs(h)<=i&&(e.kill(),this.addKilledDot())}}render(t){if(this.complete)return;const i=t.getContext(),e=Date.now();this.renderTrails(i,e),this.flameActive&&(this.renderFlameCone(i),this.renderFlameParticles(i))}renderTrails(t,i){for(const e of this.trails){const n=(i-e.startTime)/e.duration,o=Math.max(0,1-n),a=8+n*5;t.beginPath(),t.arc(e.x,e.y,a,0,Math.PI*2),t.fillStyle=`rgba(255, 100, 0, ${o*.6})`,t.fill(),t.beginPath(),t.arc(e.x,e.y,a*.5,0,Math.PI*2),t.fillStyle=`rgba(255, 200, 50, ${o*.8})`,t.fill()}}renderFlameCone(t){t.save(),t.translate(this.playerPosition.x,this.playerPosition.y),t.rotate(this.playerAngle);const i=t.createRadialGradient(0,0,0,0,0,this.FLAME_REACH_PX);i.addColorStop(0,"rgba(255, 150, 0, 0.3)"),i.addColorStop(.5,"rgba(255, 100, 0, 0.2)"),i.addColorStop(1,"rgba(255, 50, 0, 0)"),t.beginPath(),t.moveTo(0,0),t.arc(0,0,this.FLAME_REACH_PX,-this.CONE_ANGLE_RAD/2,this.CONE_ANGLE_RAD/2),t.closePath(),t.fillStyle=i,t.fill(),t.restore()}renderFlameParticles(t){for(const i of this.flames){const e=i.age/i.maxAge,s=Math.max(0,1-e),n=6+e*8;t.beginPath(),t.arc(i.x,i.y,n,0,Math.PI*2),t.fillStyle=`rgba(255, ${Math.floor(100+e*50)}, 0, ${s*.5})`,t.fill(),t.beginPath(),t.arc(i.x,i.y,n*.4,0,Math.PI*2),t.fillStyle=`rgba(255, ${Math.floor(200+e*55)}, ${Math.floor(50+e*100)}, ${s*.8})`,t.fill()}}isComplete(){return this.complete}}const b=6,Ut="#FF6B00",Wt="rgba(255, 107, 0, 0.3)",V=5*Math.PI/180,$=45,zt=15,Yt=500,Xt=250,Vt="#FFD700";class $t extends D{type=g.HOMING_MISSILE;missiles=[];explosions=[];missileSpeed=800;activate(t,i){this.start(),this.dots=i,this.missiles=[],this.explosions=[];const e=t.getPosition(),s=t.directionAngle,n=t.velocity,o=Math.sqrt(n.x**2+n.y**2)*.5,a=this.missileSpeed+o,r=[s-Math.PI/6,s,s+Math.PI/6];for(const h of r){const c={x:e.x,y:e.y,vx:Math.cos(h)*a,vy:Math.sin(h)*a,angle:h,target:null,active:!0};this.missiles.push(c)}}findBestTarget(t,i){if(!i||i.length===0)return null;let e=null,s=1/0;for(const n of i){if(n.isDead())continue;const o=n.getPosition(),a=G(t,o),r=Math.atan2(o.y-t.y,o.x-t.x),h=Math.abs(this.normalizeAngle(r-t.angle)),c=a*(1+h);c<s&&(s=c,e=n)}return e}normalizeAngle(t){for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;return t}createExplosion(t,i){const e=[];for(let n=0;n<4;n++){const o=Math.random()*Math.PI*2,a=Math.random()*$*.6;e.push({x:Math.cos(o)*a,y:Math.sin(o)*a,radius:zt*(.8+Math.random()*.4)})}const s={x:t,y:i,startTime:Date.now(),duration:Yt,mainRadius:$,subExplosions:e,hasAppliedDamage:!1,active:!0};this.explosions.push(s)}applyExplosionDamage(t,i){if(!t.hasAppliedDamage){for(const e of i){if(e.isDead())continue;const s=e.getPosition();G({x:t.x,y:t.y},s)<t.mainRadius+e.getRadius()&&(e.kill(),this.addKilledDot())}t.hasAppliedDamage=!0}}update(t,i,e,s){const n=Date.now();this.missiles=this.missiles.filter(o=>o.active),this.explosions=this.explosions.filter(o=>o.active);for(const o of this.explosions)n-o.startTime>=o.duration&&(o.active=!1),o.hasAppliedDamage||this.applyExplosionDamage(o,e);for(const o of this.missiles)if(o.active){if((!o.target||o.target.isDead())&&(o.target=this.findBestTarget(o,e)),o.target){const a=o.target.getPosition(),r=Math.atan2(a.y-o.y,a.x-o.x),h=this.normalizeAngle(r-o.angle),c=Math.max(-V,Math.min(V,h));o.angle+=c;const p=Math.sqrt(o.vx**2+o.vy**2);o.vx=Math.cos(o.angle)*p,o.vy=Math.sin(o.angle)*p}if(o.x+=o.vx*t,o.y+=o.vy*t,o.x<-b||o.x>s.width+b||o.y<-b||o.y>s.height+b){o.active=!1;continue}for(const a of e){if(a.isDead())continue;const r=a.getPosition();if(G(o,r)<b+a.getRadius()){this.createExplosion(o.x,o.y),o.active=!1;break}}}}render(t){const i=t.getContext(),e=Date.now();for(const s of this.missiles)s.active&&(i.save(),i.translate(s.x,s.y),i.rotate(s.angle),i.beginPath(),i.moveTo(-15,0),i.lineTo(-b,0),i.strokeStyle=Wt,i.lineWidth=4,i.stroke(),i.beginPath(),i.moveTo(b*1.5,0),i.lineTo(-b,-b*.6),i.lineTo(-b,b*.6),i.closePath(),i.fillStyle=Ut,i.fill(),i.restore());for(const s of this.explosions){if(!s.active)continue;const n=e-s.startTime,a=1-n/s.duration;if(i.save(),i.globalAlpha=a,i.fillStyle=Vt,i.beginPath(),i.arc(s.x,s.y,s.mainRadius,0,Math.PI*2),i.fill(),n>=Xt)for(const r of s.subExplosions)i.beginPath(),i.arc(s.x+r.x,s.y+r.y,r.radius,0,Math.PI*2),i.fill();i.restore()}}isComplete(){return this.missiles.every(t=>!t.active)&&this.explosions.every(t=>!t.active)}}class Kt extends D{type=g.ICE_BOMB;state="EXPLODING";bounds=null;explosionRadius=0;explosionCenter={x:0,y:0};explosionStartTime=0;frozenDotsCount=0;activate(t,i){this.start(),this.explosionStartTime=Date.now(),this.explosionCenter={x:t.position.x,y:t.position.y},this.dots=i,this.explosionRadius=.3*(i.length>0,800),this.freezeDotsInRadius(i),this.state="EXPLODING"}update(t,i,e,s){this.bounds||(this.bounds=s,this.explosionRadius=.3*s.width),(this.state==="EXPLODING"||this.state==="FADING")&&this.freezeDotsInRadius(e),this.state==="EXPLODING"?Date.now()-this.explosionStartTime>=500&&(this.state="FADING"):this.state==="FADING"&&Date.now()-this.explosionStartTime>=6e3&&(this.state="COMPLETE")}render(t){if(this.state==="EXPLODING"||this.state==="FADING"){const i=Date.now()-this.explosionStartTime;let e=.6;this.state==="FADING"&&(e=.6*(1-(i-500)/5500)),e>0&&t.drawCircle(this.explosionCenter.x,this.explosionCenter.y,this.explosionRadius,`rgba(0, 204, 255, ${e})`)}}isComplete(){return this.state==="COMPLETE"}freezeDotsInRadius(t){if(!(!t||t.length===0))for(const i of t){if(i.isDead()||i.isFrozen())continue;const e=i.getPosition(),s=e.x-this.explosionCenter.x,n=e.y-this.explosionCenter.y;Math.sqrt(s*s+n*n)<=this.explosionRadius&&(i.freeze(),this.frozenDotsCount++)}}getFrozenDotsCount(){return this.frozenDotsCount}getExplosionRadius(){return this.explosionRadius}}class qt extends D{type=g.KINETIC_BOMB;state="COLLAPSING";explosionCenter={x:0,y:0};explosionRadius=0;bounds=null;killedDotsInExplosion=new Set;activate(t,i){this.dots=i,this.explosionCenter={x:t.position.x,y:t.position.y},this.start()}update(t,i,e,s){this.bounds||(this.bounds=s);const n=this.getElapsedTime();switch(this.state){case"COLLAPSING":n>=100&&(this.state="EXPLODING",this.explosionRadius=.45*s.width);break;case"EXPLODING":this.killDotsInExplosion(e),n>=1e3&&(this.state="COMPLETE");break}}render(t){const i=this.getElapsedTime();if(this.state==="COLLAPSING"){const e=50*(1-i/100);e>0&&t.drawCircle(this.explosionCenter.x,this.explosionCenter.y,Math.max(0,e),"#FF4500")}else if(this.state==="EXPLODING"){const n=1-(i-100)/900;n>0&&t.drawCircle(this.explosionCenter.x,this.explosionCenter.y,this.explosionRadius,`rgba(255, 69, 0, ${n*.7})`)}}isComplete(){return this.state==="COMPLETE"}killDotsInExplosion(t){for(const i of t){if(i.isDead()||this.killedDotsInExplosion.has(i))continue;const e=i.getPosition(),s=e.x-this.explosionCenter.x,n=e.y-this.explosionCenter.y;Math.sqrt(s*s+n*n)<=this.explosionRadius&&(i.kill(),this.addKilledDot(),this.killedDotsInExplosion.add(i))}}}S.register(m.ZOMBIE_SNOW,Tt);S.register(m.SWEEPER_LINE,Dt);S.register(m.SPARSE_GRID,Ct);S.register(m.BOUNCING_BALL,vt);S.register(m.GATLING_POINT,Rt);S.register(m.BULLET_HELL,Ot);S.register(m.CONTAINMENT_RING,Lt);S.register(m.CYCLONE,Nt);S.register(m.CLOCK_SWEEP,Ft);A.register(g.BLASTER,_t);A.register(g.CHAINSAW,Bt);A.register(g.DOT_REPELLENT,kt);A.register(g.ELECTRIC_BOMB,Ht);A.register(g.FLAME_BURST,Gt);A.register(g.HOMING_MISSILE,$t);A.register(g.ICE_BOMB,Kt);A.register(g.KINETIC_BOMB,qt);A.register(g.NUCLEAR_BOMB,J);R.setupGlobalErrorHandler();new St;
//# sourceMappingURL=index-QSxojIDE.js.map
