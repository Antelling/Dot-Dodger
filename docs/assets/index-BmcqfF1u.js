(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))s(e);new MutationObserver(e=>{for(const o of e)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function i(e){const o={};return e.integrity&&(o.integrity=e.integrity),e.referrerPolicy&&(o.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?o.credentials="include":e.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(e){if(e.ep)return;e.ep=!0;const o=i(e);fetch(e.href,o)}})();var x=(l=>(l.MENU="MENU",l.PLAYING="PLAYING",l.GAME_OVER="GAME_OVER",l.PAUSED="PAUSED",l))(x||{}),S=(l=>(l.SPAWNING="SPAWNING",l.ACTIVE="ACTIVE",l.FROZEN="FROZEN",l.DEAD="DEAD",l))(S||{}),y=(l=>(l.ZOMBIE_SNOW="ZOMBIE_SNOW",l.SWEEPER_LINE="SWEEPER_LINE",l.SPARSE_GRID="SPARSE_GRID",l.ULTRA_SPARSE_GRID="ULTRA_SPARSE_GRID",l.BOUNCING_BALL="BOUNCING_BALL",l.GATLING_POINT="GATLING_POINT",l.SPIRAL="SPIRAL",l.CIRCLE_BURST="CIRCLE_BURST",l.AIMED_STREAMS="AIMED_STREAMS",l.WAVE="WAVE",l.CONTAINMENT_RING="CONTAINMENT_RING",l.CYCLONE="CYCLONE",l.CLOCK_SWEEP="CLOCK_SWEEP",l))(y||{}),f=(l=>(l.KINETIC_BOMB="KINETIC_BOMB",l.BLASTER="BLASTER",l.ICE_BOMB="ICE_BOMB",l.HOMING_MISSILE="HOMING_MISSILE",l.NUCLEAR_BOMB="NUCLEAR_BOMB",l.ELECTRIC_BOMB="ELECTRIC_BOMB",l.DOT_REPELLENT="DOT_REPELLENT",l.CHAINSAW="CHAINSAW",l.FLAME_BURST="FLAME_BURST",l.TRIPLE_CANNON="TRIPLE_CANNON",l.FIREBALL_ORB="FIREBALL_ORB",l.TESLA_CANNON="TESLA_CANNON",l))(f||{}),g=(l=>(l.EASY="EASY",l.MEDIUM="MEDIUM",l.HARD="HARD",l))(g||{}),v=(l=>(l.PATTERN_SPAWN_START="PATTERN_SPAWN_START",l.PATTERN_SPAWN_COMPLETE="PATTERN_SPAWN_COMPLETE",l.WEAPON_PICKUP="WEAPON_PICKUP",l.WEAPON_ACTIVATE="WEAPON_ACTIVATE",l.BOUNCED_ORB_DETONATE="BOUNCED_ORB_DETONATE",l.PLAYER_DEATH="PLAYER_DEATH",l))(v||{});class O{canvas;ctx;width=0;height=0;dpr=1;circleBatches=new Map;outlineBatches=new Map;static TWO_PI=Math.PI*2;scale=1.3;onScaleChange;constructor(t="game"){const i=document.getElementById(t);if(!i)throw new Error(`Canvas element with id "${t}" not found`);this.canvas=i;const s=i.getContext("2d");if(!s)throw new Error("Failed to get 2D context");this.ctx=s,this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){this.dpr=window.devicePixelRatio||1,this.width=window.innerWidth,this.height=window.innerHeight,this.canvas.width=Math.floor(this.width*this.dpr),this.canvas.height=Math.floor(this.height*this.dpr),this.canvas.style.width=`${this.width}px`,this.canvas.style.height=`${this.height}px`}getBounds(){return{width:this.width/this.scale,height:this.height/this.scale}}setScale(t){this.scale=t,this.onScaleChange&&this.onScaleChange()}getScale(){return this.scale}onScaleChangeCallback(t){this.onScaleChange=t}clear(t="#000000"){this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.ctx.scale(this.dpr*this.scale,this.dpr*this.scale)}endFrame(){this.ctx.restore()}drawCircle(t,i,s,e){let o=this.circleBatches.get(e);o||(o=[],this.circleBatches.set(e,o)),o.push({x:t,y:i,radius:s})}drawCircleOutline(t,i,s,e,o=2){let n=this.outlineBatches.get(e);n||(n=[],this.outlineBatches.set(e,n)),n.push({x:t,y:i,radius:s,lineWidth:o})}flushBatches(){const t=this.ctx;t.fillStyle="",this.circleBatches.forEach((i,s)=>{t.fillStyle=s,t.beginPath();for(let e=0;e<i.length;e++){const o=i[e];t.moveTo(o.x+o.radius,o.y),t.arc(o.x,o.y,o.radius,0,O.TWO_PI)}t.fill()}),this.circleBatches.clear(),t.strokeStyle="",this.outlineBatches.forEach((i,s)=>{const e=new Map;for(let o=0;o<i.length;o++){const n=i[o];let a=e.get(n.lineWidth);a||(a=[],e.set(n.lineWidth,a)),a.push(n)}e.forEach((o,n)=>{t.strokeStyle=s,t.lineWidth=n,t.beginPath();for(let a=0;a<o.length;a++){const r=o[a];t.moveTo(r.x+r.radius,r.y),t.arc(r.x,r.y,r.radius,0,O.TWO_PI)}t.stroke()})}),this.outlineBatches.clear()}drawCircleImmediate(t,i,s,e){this.ctx.fillStyle=e,this.ctx.beginPath(),this.ctx.arc(t,i,s,0,O.TWO_PI),this.ctx.fill()}drawLine(t,i,s,e,o,n=2){this.ctx.beginPath(),this.ctx.moveTo(t,i),this.ctx.lineTo(s,e),this.ctx.strokeStyle=o,this.ctx.lineWidth=n,this.ctx.stroke()}drawArrow(t,i,s,e,o="#00CC00"){const n=Math.cos(s),a=Math.sin(s),r=t+n*e,h=i+a*e,c=this.ctx;c.strokeStyle=o,c.lineWidth=3,c.beginPath(),c.moveTo(t,i),c.lineTo(r,h),c.stroke();const d=8,p=Math.PI/6;c.beginPath(),c.moveTo(r,h),c.lineTo(r-d*Math.cos(s-p),h-d*Math.sin(s-p)),c.moveTo(r,h),c.lineTo(r-d*Math.cos(s+p),h-d*Math.sin(s+p)),c.stroke()}drawRect(t,i,s,e,o){this.ctx.fillStyle=o,this.ctx.fillRect(t,i,s,e)}drawText(t,i,s,e="#FFFFFF",o=16){this.ctx.font=`${o}px Arial`,this.ctx.fillStyle=e,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(t,i,s)}drawTextLeft(t,i,s,e="#FFFFFF",o=16){this.ctx.font=`${o}px Arial`,this.ctx.fillStyle=e,this.ctx.textAlign="left",this.ctx.textBaseline="top",this.ctx.fillText(t,i,s)}drawPolygon(t,i){if(t.length<3)return;const s=this.ctx;s.fillStyle=i,s.beginPath(),s.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)s.lineTo(t[e].x,t[e].y);s.closePath(),s.fill()}getContext(){return this.ctx}}const B=10,ot=B*.5,z=1200,nt=15,b=8,J=1e3,F=1.5,N=20,at="#00FF00",rt="#00CC00",ht="#FF0000",lt="#FF6666",ct="#00FFFF",dt="#000000",Q={KINETIC_BOMB:"#FF6600",BLASTER:"#9900FF",ICE_BOMB:"#00CCFF",HOMING_MISSILE:"#FFFF00",NUCLEAR_BOMB:"#FF0000",ELECTRIC_BOMB:"#00FFFF",DOT_REPELLENT:"#808080",CHAINSAW:"#0066FF",FLAME_BURST:"#FF9900",TRIPLE_CANNON:"#FF00FF",FIREBALL_ORB:"#FF4500",TESLA_CANNON:"#00CCFF"},pt=60,U=1e3/pt;class ut{velocity={x:0,y:0};permissionState="unknown";tiltBasis=null;constructor(){this.checkPermissionAvailability(),this.trackScreenOrientation()}trackScreenOrientation(){window.addEventListener("orientationchange",()=>{})}setTiltBasis(t){this.tiltBasis=t}getCurrentTiltBasis(){return this.tiltBasis}checkPermissionAvailability(){typeof DeviceOrientationEvent.requestPermission=="function"?this.permissionState="pending":window.DeviceOrientationEvent?(this.permissionState="granted",this.enableDeviceOrientation()):this.permissionState="denied"}async requestPermission(){if(this.permissionState==="granted")return!0;if(typeof DeviceOrientationEvent.requestPermission=="function")try{return await DeviceOrientationEvent.requestPermission()==="granted"?(this.permissionState="granted",this.enableDeviceOrientation(),!0):(this.permissionState="denied",!1)}catch(t){return console.error("Device orientation permission error:",t),this.permissionState="denied",!1}return this.permissionState==="granted"}enableDeviceOrientation(){window.addEventListener("deviceorientation",this.handleOrientation.bind(this))}lastTilt={gamma:0,beta:45};calibrateTiltBasis(){this.tiltBasis={...this.lastTilt}}getScreenOrientation(){return screen.orientation?screen.orientation.angle:0}transformTiltToGameCoords(t,i,s){const e=t,o=i-45;switch(s){case 0:return{x:e,y:o};case 90:case-270:return{x:-o,y:e};case 180:case-180:return{x:-e,y:-o};case-90:case 270:return{x:o,y:-e};default:return{x:e,y:o}}}handleOrientation(t){if(t.gamma===null||t.beta===null)return;const i=t.gamma,s=t.beta;this.lastTilt={gamma:i,beta:s};const e=this.getScreenOrientation(),o=this.tiltBasis;let n=i,a=s-45;o!==null&&(n=i-o.gamma,a=s-45-(o.beta-45));const r=this.transformTiltToGameCoords(n,a+45,e),h=this.clamp(r.x/35,-1,1),c=this.clamp(r.y/35,-1,1);this.velocity.x=h*z,this.velocity.y=c*z}clamp(t,i,s){return Math.max(i,Math.min(s,t))}getVelocity(){return{x:this.velocity.x,y:this.velocity.y}}getPermissionState(){return this.permissionState}needsPermissionRequest(){return this.permissionState==="pending"}destroy(){window.removeEventListener("deviceorientation",this.handleOrientation.bind(this))}}class R{constructor(t=0,i=0){this.x=t,this.y=i}static from(t){return new R(t.x,t.y)}add(t){return new R(this.x+t.x,this.y+t.y)}subtract(t){return new R(this.x-t.x,this.y-t.y)}multiply(t){return new R(this.x*t,this.y*t)}divide(t){if(t===0)throw new Error("Division by zero");return new R(this.x/t,this.y/t)}magnitude(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){const t=this.magnitude();return t===0?new R(0,0):this.divide(t)}dot(t){return this.x*t.x+this.y*t.y}angle(){return Math.atan2(this.y,this.x)}angleTo(t){return Math.atan2(t.y-this.y,t.x-this.x)}clone(){return new R(this.x,this.y)}set(t,i){this.x=t,this.y=i}addInPlace(t){this.x+=t.x,this.y+=t.y}}function W(l,t){const i=t.x-l.x,s=t.y-l.y;return Math.sqrt(i*i+s*s)}function tt(l,t){if(t.width>0&&t.height>0){for(;l.x<0;)l.x+=t.width;for(;l.y<0;)l.y+=t.height;l.x=l.x%t.width,l.y=l.y%t.height}}function Y(l,t,i,s){const e=i.x-l.x,o=i.y-l.y,n=e*e+o*o,a=t+s;return n<a*a}function it(l,t=0){return{x:t+Math.random()*(l.width-t*2),y:t+Math.random()*(l.height-t*2)}}class ft{position;velocity={x:0,y:0};directionAngle=0;hitboxRadius=ot;constructor(t,i){this.position=new R(t,i)}update(t,i,s,e=!0){this.velocity.x=i.x,this.velocity.y=i.y,(this.velocity.x!==0||this.velocity.y!==0)&&(this.directionAngle=Math.atan2(this.velocity.y,this.velocity.x)),this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,e?tt(this.position,s):(this.position.x=Math.max(0,Math.min(s.width,this.position.x)),this.position.y=Math.max(0,Math.min(s.height,this.position.y)))}setPosition(t,i){this.position.x=t,this.position.y=i}render(t){t.drawCircleImmediate(this.position.x,this.position.y,B,at);const i=this.position.x+Math.cos(this.directionAngle)*(B+2),s=this.position.y+Math.sin(this.directionAngle)*(B+2);t.drawArrow(i,s,this.directionAngle,nt,rt)}getPosition(){return this.position}}class gt{score=0;kills=0;startTime=0;start(){this.score=0,this.kills=0,this.startTime=Date.now()}addKill(){this.kills++}addKills(t){this.kills+=t}addPatternBonus(t){const i={EASY:50,MEDIUM:100,HARD:200};this.score+=i[t]||50}getScore(){const t=Math.floor((Date.now()-this.startTime)/1e4);return this.score+this.kills*10+t}getKills(){return this.kills}getTimeAlive(){return Date.now()-this.startTime}}const _=100,yt=[[-1,-1],[0,-1],[1,-1],[-1,0],[0,0],[1,0],[-1,1],[0,1],[1,1]];class mt{grid=new Map;nearbyKeys=new Array(9);constructor(t){}getCellKey(t,i){const s=Math.floor(t/_),e=Math.floor(i/_);return s*1e4+e}getNearbyKeys(t,i){const s=Math.floor(t/_),e=Math.floor(i/_);for(let o=0;o<9;o++){const[n,a]=yt[o];this.nearbyKeys[o]=(s+n)*1e4+(e+a)}return this.nearbyKeys}rebuildGrid(t){this.grid.clear();for(let i=0;i<t.length;i++){const s=t[i];if(!s.isLethal()&&!s.isFrozen())continue;const e=s.getPosition(),o=this.getCellKey(e.x,e.y);let n=this.grid.get(o);n||(n=[],this.grid.set(o,n)),n.push(s)}}checkPlayerDotCollision(t){const i=t.getPosition(),s=t.hitboxRadius,e=this.getNearbyKeys(i.x,i.y);for(let o=0;o<9;o++){const n=this.grid.get(e[o]);if(n)for(let a=0;a<n.length;a++){const r=n[a],h=r.getPosition(),c=r.getEffectiveRadius();if(Y(i,s,h,c))return r}}return null}checkPlayerOrbCollision(t,i){const s=t.getPosition(),e=t.hitboxRadius;for(let o=0;o<i.length;o++){const n=i[o];if(!n.isActive())continue;const a=n.getPosition(),r=n.radius;if(Y(s,e,a,r))return n}return null}updateBounds(t){}}class Pt{patterns=new Map;register(t,i){this.patterns.set(t,i)}create(t){const i=this.patterns.get(t);return i?new i:null}getAvailableTypes(){return Array.from(this.patterns.keys())}}const I=new Pt,K=4e3,Et=1500,St=5e3;class wt{activePatterns=[];patternTimer=0;nextPatternInterval=3e3;currentScore=0;allDotsCache=[];eventLogger=null;constructor(){this.nextPatternInterval=this.getRandomInterval()}update(t,i,s){if(this.patternTimer+=t*1e3,this.patternTimer>=this.nextPatternInterval){this.patternTimer=0,this.nextPatternInterval=this.getRandomInterval();const e=this.selectNextPattern();e&&this.spawnPattern(e,i,s)}for(let e=0;e<this.activePatterns.length;e++){const o=this.activePatterns[e];o.tick(t),o.update(t,i,s)}this.removeCompletedPatterns(),this.rebuildDotsCache()}addPattern(t){this.isPatternTypeActive(t.type)||this.activePatterns.push(t)}removePattern(t){const i=this.activePatterns.indexOf(t);i!==-1&&(t.clear(),this.activePatterns.splice(i,1))}getActivePatterns(){return this.activePatterns}getAllDots(){return this.allDotsCache}setEventLogger(t){this.eventLogger=t}isAnyPatternActivelySpawning(){for(let t=0;t<this.activePatterns.length;t++)if(this.activePatterns[t].isActivelySpawning())return!0;return!1}rebuildDotsCache(){this.allDotsCache.length=0;for(let t=0;t<this.activePatterns.length;t++){const i=this.activePatterns[t].getDots();for(let s=0;s<i.length;s++)this.allDotsCache.push(i[s])}}setScore(t){this.currentScore=t}selectNextPattern(){const i=I.getAvailableTypes().filter(e=>!this.isPatternTypeActive(e));if(i.length===0)return null;const s=Math.floor(Math.random()*i.length);return i[s]}spawnPattern(t,i,s){if(this.isPatternTypeActive(t))return;const e=I.create(t);if(!e){console.warn(`Failed to create pattern of type: ${t}`);return}e.spawn(i,s),e.start(),this.activePatterns.push(e),this.eventLogger&&this.eventLogger.logPatternSpawnStart(t)}isPatternTypeActive(t){for(let i=0;i<this.activePatterns.length;i++)if(this.activePatterns[i].type===t)return!0;return!1}removeCompletedPatterns(){for(let t=this.activePatterns.length-1;t>=0;t--)if(this.activePatterns[t].isComplete()){const i=this.activePatterns[t];this.eventLogger&&this.eventLogger.logPatternSpawnComplete(i.type,i.getDots().length),i.clear(),this.activePatterns.splice(t,1)}}clear(){for(let t=0;t<this.activePatterns.length;t++)this.activePatterns[t].clear();this.activePatterns=[],this.patternTimer=0,this.allDotsCache.length=0}getPatternTimer(){return this.patternTimer}getPatternInterval(){return this.nextPatternInterval}getRandomInterval(){const t=Math.min(this.currentScore/St,1);return K-t*(K-Et)+(Math.random()-.5)*1e3}}class L{position;weaponType;pickedUp=!1;radius=N;static BOUNCED_WEAPONS=[f.NUCLEAR_BOMB,f.ELECTRIC_BOMB,f.FIREBALL_ORB];velocity={x:0,y:0};lastBounceTime=0;bounceCooldown=100;constructor(t,i,s){this.position={x:t,y:i},this.weaponType=s}render(t){if(this.pickedUp)return;const i=Q[this.weaponType]||"#FFFFFF";t.drawCircleImmediate(this.position.x,this.position.y,this.radius,i);const e=L.BOUNCED_WEAPONS.includes(this.weaponType)?"#9B30FF":"#FFFFFF",o=t.getContext();o.strokeStyle=e,o.lineWidth=3,o.beginPath(),o.arc(this.position.x,this.position.y,this.radius+2,0,Math.PI*2),o.stroke(),this.drawIcon(o,this.position.x,this.position.y,this.radius)}drawIcon(t,i,s,e){t.strokeStyle="#FFFFFF",t.lineWidth=2,t.fillStyle="#FFFFFF";const o=e*.5;switch(this.weaponType){case f.KINETIC_BOMB:this.drawKineticBombIcon(t,i,s,o);break;case f.BLASTER:this.drawBlasterIcon(t,i,s,o);break;case f.ICE_BOMB:this.drawIceBombIcon(t,i,s,o);break;case f.HOMING_MISSILE:this.drawHomingMissileIcon(t,i,s,o);break;case f.NUCLEAR_BOMB:this.drawNuclearBombIcon(t,i,s,o);break;case f.ELECTRIC_BOMB:this.drawElectricBombIcon(t,i,s,o);break;case f.DOT_REPELLENT:this.drawDotRepellentIcon(t,i,s,o);break;case f.CHAINSAW:this.drawChainsawIcon(t,i,s,o);break;case f.FLAME_BURST:this.drawFlameBurstIcon(t,i,s,o);break;case f.TRIPLE_CANNON:this.drawTripleCannonIcon(t,i,s,o);break;case f.FIREBALL_ORB:this.drawFireballOrbIcon(t,i,s,o);break;case f.TESLA_CANNON:this.drawTeslaCannonIcon(t,i,s,o);break}}drawKineticBombIcon(t,i,s,e){t.beginPath(),t.arc(i,s,e*.3,0,Math.PI*2),t.fill();for(let o=0;o<8;o++){const n=o/8*Math.PI*2;t.beginPath(),t.moveTo(i+Math.cos(n)*e*.4,s+Math.sin(n)*e*.4),t.lineTo(i+Math.cos(n)*e*.8,s+Math.sin(n)*e*.8),t.stroke()}}drawBlasterIcon(t,i,s,e){t.fillRect(i-e*.8,s-e*.15,e*1.6,e*.3),t.fillRect(i-e*.9,s-e*.4,e*.3,e*.8),t.fillRect(i+e*.6,s-e*.4,e*.3,e*.8)}drawIceBombIcon(t,i,s,e){for(let o=0;o<6;o++){const n=o/6*Math.PI*2;t.beginPath(),t.moveTo(i,s),t.lineTo(i+Math.cos(n)*e*.8,s+Math.sin(n)*e*.8),t.stroke();const a=i+Math.cos(n)*e*.5,r=s+Math.sin(n)*e*.5;t.beginPath(),t.moveTo(a,r),t.lineTo(a+Math.cos(n+Math.PI/4)*e*.3,r+Math.sin(n+Math.PI/4)*e*.3),t.moveTo(a,r),t.lineTo(a+Math.cos(n-Math.PI/4)*e*.3,r+Math.sin(n-Math.PI/4)*e*.3),t.stroke()}}drawHomingMissileIcon(t,i,s,e){const o=e*.25,n=e*.35;for(let a=-1;a<=1;a++){const r=i+a*n,h=s;this.drawArrowUp(t,r,h,o)}}drawArrowUp(t,i,s,e){t.beginPath(),t.moveTo(i,s-e),t.lineTo(i-e*.5,s+e*.3),t.lineTo(i+e*.5,s+e*.3),t.closePath(),t.fill()}drawNuclearBombIcon(t,i,s,e){const o=e*.7;t.beginPath(),t.arc(i,s-o*.1,o*.5,0,Math.PI*2),t.fill(),t.fillStyle="#000000",t.beginPath(),t.arc(i-o*.2,s-o*.15,o*.15,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(i+o*.2,s-o*.15,o*.15,0,Math.PI*2),t.fill(),t.beginPath(),t.moveTo(i,s+o*.05),t.lineTo(i-o*.08,s+o*.2),t.lineTo(i+o*.08,s+o*.2),t.closePath(),t.fill(),t.fillStyle="#FFFFFF",t.beginPath(),t.rect(i-o*.25,s+o*.25,o*.5,o*.2),t.fill(),t.strokeStyle="#000000",t.lineWidth=1.5;for(let r=1;r<=2;r++){const h=i-o*.08*r;t.beginPath(),t.moveTo(h,s+o*.25),t.lineTo(h,s+o*.45),t.stroke();const c=i+o*.08*r;t.beginPath(),t.moveTo(c,s+o*.25),t.lineTo(c,s+o*.45),t.stroke()}t.strokeStyle="#FFFFFF",t.lineWidth=3,t.lineCap="round",t.beginPath(),t.moveTo(i-o*.7,s-o*.5),t.lineTo(i+o*.7,s+o*.5),t.stroke(),t.beginPath(),t.moveTo(i+o*.7,s-o*.5),t.lineTo(i-o*.7,s+o*.5),t.stroke(),t.fillStyle="#FFFFFF";const n=o*.1,a=[{x:i-o*.7,y:s-o*.5},{x:i+o*.7,y:s+o*.5},{x:i+o*.7,y:s-o*.5},{x:i-o*.7,y:s+o*.5}];for(const r of a)t.beginPath(),t.arc(r.x,r.y,n,0,Math.PI*2),t.fill()}drawElectricBombIcon(t,i,s,e){t.beginPath(),t.moveTo(i+e*.2,s-e*.8),t.lineTo(i-e*.1,s-e*.1),t.lineTo(i+e*.3,s-e*.1),t.lineTo(i-e*.2,s+e*.8),t.lineTo(i,s+e*.1),t.lineTo(i-e*.3,s+e*.1),t.closePath(),t.fill()}drawDotRepellentIcon(t,i,s,e){t.beginPath(),t.arc(i,s,e*.3,0,Math.PI*2),t.stroke(),t.beginPath(),t.arc(i,s,e*.6,0,Math.PI*2),t.stroke();for(let o=0;o<4;o++){const n=o/4*Math.PI*2;this.drawOutwardArrow(t,i,s,n,e)}}drawOutwardArrow(t,i,s,e,o){const n=i+Math.cos(e)*o*.45,a=s+Math.sin(e)*o*.45,r=o*.2;t.beginPath(),t.moveTo(n+Math.cos(e)*r,a+Math.sin(e)*r),t.lineTo(n+Math.cos(e+2.5)*r,a+Math.sin(e+2.5)*r),t.lineTo(n+Math.cos(e-2.5)*r,a+Math.sin(e-2.5)*r),t.closePath(),t.fill()}drawChainsawIcon(t,i,s,e){t.beginPath(),t.arc(i,s,e*.5,0,Math.PI*2),t.stroke();const o=8;for(let n=0;n<o;n++){const a=n/o*Math.PI*2,r=e*.5,h=e*.7;t.beginPath(),t.moveTo(i+Math.cos(a-.15)*r,s+Math.sin(a-.15)*r),t.lineTo(i+Math.cos(a)*h,s+Math.sin(a)*h),t.lineTo(i+Math.cos(a+.15)*r,s+Math.sin(a+.15)*r),t.fill()}t.beginPath(),t.arc(i,s,e*.15,0,Math.PI*2),t.fill()}drawFlameBurstIcon(t,i,s,e){t.beginPath(),t.moveTo(i,s-e*.8),t.bezierCurveTo(i-e*.4,s-e*.3,i-e*.6,s+e*.2,i-e*.2,s+e*.6),t.quadraticCurveTo(i,s+e*.8,i+e*.2,s+e*.6),t.bezierCurveTo(i+e*.6,s+e*.2,i+e*.4,s-e*.3,i,s-e*.8),t.fill(),t.fillStyle="rgba(0, 0, 0, 0.3)",t.beginPath(),t.moveTo(i,s-e*.4),t.bezierCurveTo(i-e*.2,s,i-e*.3,s+e*.3,i,s+e*.5),t.bezierCurveTo(i+e*.3,s+e*.3,i+e*.2,s,i,s-e*.4),t.fill()}drawTripleCannonIcon(t,i,s,e){const o=e*.2,n=e*.5;for(let a=-1;a<=1;a++){const r=i+a*n;t.beginPath(),t.arc(r,s,o,0,Math.PI*2),t.fill()}}drawFireballOrbIcon(t,i,s,e){t.beginPath(),t.arc(i,s,e*.4,0,Math.PI*2),t.fill();const o=5;for(let n=0;n<o;n++){const a=n/o*Math.PI*2-Math.PI/2,r=e*(.5+n%2*.2);t.beginPath(),t.moveTo(i,s),t.quadraticCurveTo(i+Math.cos(a-.2)*r*.5,s+Math.sin(a-.2)*r*.5,i+Math.cos(a)*r,s+Math.sin(a)*r),t.quadraticCurveTo(i+Math.cos(a+.2)*r*.5,s+Math.sin(a+.2)*r*.5,i,s),t.fill()}}drawTeslaCannonIcon(t,i,s,e){const o=e*.15,n=e*.4;for(let a=-1;a<=1;a++){const r=i+a*n;t.beginPath(),t.arc(r,s,o,0,Math.PI*2),t.fill()}t.strokeStyle="#FFFFFF",t.lineWidth=2,t.beginPath(),t.moveTo(i,s+e*.4),t.lineTo(i,s+e*.8),t.stroke()}isCollidingWith(t,i){const s=this.position.x-t.x,e=this.position.y-t.y,o=s*s+e*e,n=this.radius+i;return o<n*n}getPosition(){return this.position}getWeaponType(){return this.weaponType}pickup(){this.pickedUp=!0}isActive(){return!this.pickedUp}bounce(t,i){const s=Date.now();if(s-this.lastBounceTime<this.bounceCooldown||(this.lastBounceTime=s,!L.BOUNCED_WEAPONS.includes(this.weaponType)))return!1;const e=this.position.x-i.x,o=this.position.y-i.y,n=Math.sqrt(e*e+o*o);if(n===0)return this.velocity.x=t.x,this.velocity.y=t.y,!0;const a=e/n,r=o/n,h=-r,c=a,d=t.x*a+t.y*r,p=t.x*h+t.y*c,u=.8,m=.6;return this.velocity.x=a*d*u+h*p*m,this.velocity.y=r*d*u+c*p*m,!0}getVelocity(){return this.velocity}updatePosition(t,i){if(!L.BOUNCED_WEAPONS.includes(this.weaponType))return;this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t;const s=this.radius,e=i.width-this.radius,o=this.radius,n=i.height-this.radius;this.position.x<=s?(this.velocity.x=Math.abs(this.velocity.x),this.position.x=s):this.position.x>=e&&(this.velocity.x=-Math.abs(this.velocity.x),this.position.x=e),this.position.y<=o?(this.velocity.y=Math.abs(this.velocity.y),this.position.y=o):this.position.y>=n&&(this.velocity.y=-Math.abs(this.velocity.y),this.position.y=n)}}class Mt{orbs=[];orbCount=3;minSpacing=100;playerAvoidRadius=150;initialize(t,i){this.orbs=[];for(let s=0;s<this.orbCount;s++)this.spawnOrb(t,i)}update(t,i){for(;this.orbs.length<this.orbCount;)this.spawnOrb(t,i)}getOrbs(){return this.orbs}removeOrb(t){const i=this.orbs.indexOf(t);i>-1&&this.orbs.splice(i,1)}spawnOrb(t,i){const s=this.getRandomPosition(t,i),e=this.getRandomWeaponType();this.orbs.push(new L(s.x,s.y,e))}getRandomPosition(t,i){let s=0;for(;s<100;){const e=N+Math.random()*(t.width-N*2),o=N+Math.random()*(t.height-N*2),n=e-i.x,a=o-i.y;if(Math.sqrt(n*n+a*a)>=this.playerAvoidRadius&&this.isPositionValid({x:e,y:o}))return{x:e,y:o};s++}return{x:t.width/2,y:t.height/2}}isPositionValid(t){for(const i of this.orbs){const s=t.x-i.position.x,e=t.y-i.position.y;if(Math.sqrt(s*s+e*e)<this.minSpacing)return!1}return!0}getRandomWeaponType(){const t=[f.KINETIC_BOMB,f.BLASTER,f.ICE_BOMB,f.HOMING_MISSILE,f.NUCLEAR_BOMB,f.ELECTRIC_BOMB,f.DOT_REPELLENT,f.CHAINSAW,f.FLAME_BURST,f.TRIPLE_CANNON,f.FIREBALL_ORB,f.TESLA_CANNON];return t[Math.floor(Math.random()*t.length)]}}class It{weapons=new Map;register(t,i){this.weapons.set(t,i)}create(t){const i=this.weapons.get(t);return i?new i:null}getAvailableTypes(){return Array.from(this.weapons.keys())}}const A=new It;class D{dots=[];startTime=0;isStarted=!1;killedDots=0;handlePlayerCollision(t,i){return!1}isActive(){return!1}getPosition(){return{x:0,y:0}}getRadius(){return 0}getDots(){return this.dots.filter(t=>!t.isDead())}isComplete(){return!1}start(){this.startTime=Date.now(),this.isStarted=!0}getElapsedTime(){return Date.now()-this.startTime}clear(){for(const t of this.dots)t.kill();this.dots=[]}getKilledDots(){return this.killedDots}addKilledDot(){this.killedDots++}}class k extends D{type=f.NUCLEAR_BOMB;state="DRIFTING";orbPosition={x:0,y:0};orbVelocity={x:0,y:0};fuseTime=1500;explosionRadius=0;explosionStartTime=0;killedDotsInExplosion=new Set;orbsToDestroy=new Set;orbs=[];_hasKilledPlayer=!1;bounds=null;flashInterval=100;flashGap=400;lastCollisionTime=0;collisionCooldown=100;orbRadius=N;activate(t,i,s){if(this.dots=i,this.start(),s)this.orbPosition={x:s.x,y:s.y};else{const e=Math.sqrt(t.velocity.x**2+t.velocity.y**2);if(e>10){const o=t.velocity.x/e,n=t.velocity.y/e,a=t.hitboxRadius+this.orbRadius+5;this.orbPosition={x:t.position.x+o*a,y:t.position.y+n*a}}else this.orbPosition={x:t.position.x,y:t.position.y-t.hitboxRadius-this.orbRadius-5}}this.orbVelocity={x:0,y:0}}handlePlayerCollision(t,i){const s=Date.now();if(s-this.lastCollisionTime<this.collisionCooldown)return!1;this.lastCollisionTime=s;const e=this.orbPosition.x-t.position.x,o=this.orbPosition.y-t.position.y,n=Math.sqrt(e*e+o*o),a=50,r=Math.sqrt(i.x**2+i.y**2);if(r<a)return!1;if(n===0)return this.orbVelocity.x=i.x,this.orbVelocity.y=i.y,!0;const h=e/n,c=o/n,d=-c,p=h,u=i.x*h+i.y*c,m=i.x*d+i.y*p,P=u/r;if(P<.1)return!1;const E=2.2;if(P>.7)this.orbVelocity.x=i.x*E,this.orbVelocity.y=i.y*E;else{const w=P,M=1-P;this.orbVelocity.x=(h*u*w+d*m*M)*E,this.orbVelocity.y=(c*u*w+p*m*M)*E}return!0}getPosition(){return this.orbPosition}getRadius(){return this.orbRadius}isActive(){return this.state!=="COMPLETE"}update(t,i,s,e){switch(this.bounds=e,this.state){case"DRIFTING":{const o=this.getElapsedTime();this.orbPosition.x+=this.orbVelocity.x*t,this.orbPosition.y+=this.orbVelocity.y*t;const n=this.orbRadius,a=e.width-this.orbRadius,r=this.orbRadius,h=e.height-this.orbRadius;this.orbPosition.x<=n?(this.orbVelocity.x=Math.abs(this.orbVelocity.x),this.orbPosition.x=n):this.orbPosition.x>=a&&(this.orbVelocity.x=-Math.abs(this.orbVelocity.x),this.orbPosition.x=a),this.orbPosition.y<=r?(this.orbVelocity.y=Math.abs(this.orbVelocity.y),this.orbPosition.y=r):this.orbPosition.y>=h&&(this.orbVelocity.y=-Math.abs(this.orbVelocity.y),this.orbPosition.y=h),o>=this.fuseTime&&(this.state="EXPLODING",this.explosionStartTime=Date.now(),this.explosionRadius=.55*e.width,this.killDotsInExplosion(s),this.checkAndKillPlayer(i));break}case"EXPLODING":{Date.now()-this.explosionStartTime>500&&(this.state="COMPLETE");break}}}render(t){if(this.bounds)switch(this.state){case"DRIFTING":{const i=this.getElapsedTime(),s=Math.min(i/this.fuseTime,1),e=this.interpolateColor("#FF6600","#FF0000",s),o=.55*this.bounds.width,n=t.getContext(),a=this.fuseTime*.5;if(i>=a){const r=i-a,h=0,c=this.flashInterval+this.flashGap;let d=!1;(r>=h&&r<h+this.flashInterval||r>=c&&r<c+this.flashInterval)&&(d=!0),d&&(n.fillStyle="rgba(255, 165, 0, 0.6)",n.beginPath(),n.arc(this.orbPosition.x,this.orbPosition.y,o,0,Math.PI*2),n.fill())}t.drawCircleImmediate(this.orbPosition.x,this.orbPosition.y,this.orbRadius,e),n.strokeStyle="#9B30FF",n.lineWidth=3,n.beginPath(),n.arc(this.orbPosition.x,this.orbPosition.y,this.orbRadius+2,0,Math.PI*2),n.stroke(),this.drawNuclearIcon(n,this.orbPosition.x,this.orbPosition.y,this.orbRadius*.5);break}case"EXPLODING":{const i=Date.now()-this.explosionStartTime;if(i<=500){const s=.8-i/500*.8;t.drawCircle(this.orbPosition.x,this.orbPosition.y,this.explosionRadius,`rgba(255, 0, 0, ${s})`)}break}}}interpolateColor(t,i,s){const e=parseInt(t.slice(1,3),16),o=parseInt(t.slice(3,5),16),n=parseInt(t.slice(5,7),16),a=parseInt(i.slice(1,3),16),r=parseInt(i.slice(3,5),16),h=parseInt(i.slice(5,7),16),c=Math.round(e+(a-e)*s),d=Math.round(o+(r-o)*s),p=Math.round(n+(h-n)*s);return`#${c.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}${p.toString(16).padStart(2,"0")}`}drawNuclearIcon(t,i,s,e){t.fillStyle="#FFFFFF",t.strokeStyle="#FFFFFF",t.lineWidth=2;const o=e*.7;t.beginPath(),t.arc(i,s-o*.1,o*.5,0,Math.PI*2),t.fill(),t.fillStyle="#000000",t.beginPath(),t.arc(i-o*.2,s-o*.15,o*.15,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(i+o*.2,s-o*.15,o*.15,0,Math.PI*2),t.fill(),t.beginPath(),t.moveTo(i,s+o*.05),t.lineTo(i-o*.08,s+o*.2),t.lineTo(i+o*.08,s+o*.2),t.closePath(),t.fill(),t.fillStyle="#FFFFFF",t.beginPath(),t.rect(i-o*.25,s+o*.25,o*.5,o*.2),t.fill(),t.strokeStyle="#000000",t.lineWidth=1.5;for(let r=1;r<=2;r++){const h=i-o*.08*r;t.beginPath(),t.moveTo(h,s+o*.25),t.lineTo(h,s+o*.45),t.stroke();const c=i+o*.08*r;t.beginPath(),t.moveTo(c,s+o*.25),t.lineTo(c,s+o*.45),t.stroke()}t.strokeStyle="#FFFFFF",t.lineWidth=3,t.lineCap="round",t.beginPath(),t.moveTo(i-o*.7,s-o*.5),t.lineTo(i+o*.7,s+o*.5),t.stroke(),t.beginPath(),t.moveTo(i+o*.7,s-o*.5),t.lineTo(i-o*.7,s+o*.5),t.stroke(),t.fillStyle="#FFFFFF";const n=o*.1,a=[{x:i-o*.7,y:s-o*.5},{x:i+o*.7,y:s+o*.5},{x:i+o*.7,y:s-o*.5},{x:i-o*.7,y:s+o*.5}];for(const r of a)t.beginPath(),t.arc(r.x,r.y,n,0,Math.PI*2),t.fill()}setOrbs(t){this.orbs=t}getDestroyedOrbs(){return Array.from(this.orbsToDestroy)}isComplete(){return this.state==="COMPLETE"}hasKilledPlayer(){return this._hasKilledPlayer}killDotsInExplosion(t){for(const i of t){if(i.isDead()||this.killedDotsInExplosion.has(i))continue;const s=i.getPosition(),e=s.x-this.orbPosition.x,o=s.y-this.orbPosition.y;Math.sqrt(e*e+o*o)<=this.explosionRadius&&(i.kill(),this.addKilledDot(),this.killedDotsInExplosion.add(i))}for(const i of this.orbs){if(this.orbsToDestroy.has(i)||!i.isActive())continue;const s=i.getPosition(),e=s.x-this.orbPosition.x,o=s.y-this.orbPosition.y;Math.sqrt(e*e+o*o)<=this.explosionRadius&&this.orbsToDestroy.add(i)}}checkAndKillPlayer(t){if(this._hasKilledPlayer)return;const i=t.position.x-this.orbPosition.x,s=t.position.y-this.orbPosition.y;Math.sqrt(i*i+s*s)<=this.explosionRadius&&(this._hasKilledPlayer=!0)}}const st="tilt-to-live-highscores",At=10;function X(){try{const l=localStorage.getItem(st);return l?JSON.parse(l).sort((i,s)=>s.score-i.score):[]}catch(l){return console.error("Failed to load highscores:",l),[]}}function bt(l){const t=X(),i={score:l,timestamp:Date.now()};t.push(i),t.sort((o,n)=>n.score-o.score);const s=t.slice(0,At),e=s.findIndex(o=>o.timestamp===i.timestamp&&o.score===l)+1;try{localStorage.setItem(st,JSON.stringify(s))}catch(o){console.error("Failed to save highscores:",o)}return e>0?e:-1}class Dt{events=[];gameStartTime=0;startGame(){this.events=[],this.gameStartTime=Date.now()}log(t){this.events.push({...t,timestamp:Date.now()})}logPatternSpawnStart(t){this.log({type:v.PATTERN_SPAWN_START,message:`Pattern started: ${this.formatPatternName(t)}`})}logPatternSpawnComplete(t,i){this.log({type:v.PATTERN_SPAWN_COMPLETE,message:`Pattern finished spawning: ${this.formatPatternName(t)} (${i} dots)`,details:{patternType:t,dotsSpawned:i}})}logWeaponPickup(t){this.log({type:v.WEAPON_PICKUP,message:`Picked up: ${this.formatWeaponName(t)}`})}logWeaponActivate(t){this.log({type:v.WEAPON_ACTIVATE,message:`Activated: ${this.formatWeaponName(t)}`})}logBouncedOrbDetonate(t,i){this.log({type:v.BOUNCED_ORB_DETONATE,message:`${this.formatWeaponName(t)} detonated (${i} kills)`,details:{weaponType:t,kills:i}})}logPlayerDeath(t){this.log({type:v.PLAYER_DEATH,message:`Death: ${t}`})}getEvents(){return[...this.events]}getEventsReversed(){return[...this.events].reverse()}getFormattedEvents(){return this.getEventsReversed().map(t=>({time:this.formatTime(t.timestamp),message:t.message}))}formatTime(t){const i=t-this.gameStartTime,s=Math.floor(i/1e3),e=Math.floor(s/60),o=s%60;return`${e}:${o.toString().padStart(2,"0")}`}formatPatternName(t){return{ZOMBIE_SNOW:"Zombie Snow",SWEEPER_LINE:"Sweeper Line",SPARSE_GRID:"Sparse Grid",BOUNCING_BALL:"Bouncing Ball",GATLING_POINT:"Gatling Point",BULLET_HELL:"Bullet Hell",CONTAINMENT_RING:"Containment Ring",CYCLONE:"Cyclone",CLOCK_SWEEP:"Clock Sweep"}[t]||t}formatWeaponName(t){return{KINETIC_BOMB:"Kinetic Bomb",BLASTER:"Blaster",ICE_BOMB:"Ice Bomb",HOMING_MISSILE:"Homing Missile",NUCLEAR_BOMB:"Nuclear Bomb",ELECTRIC_BOMB:"Electric Bomb",DOT_REPELLENT:"Dot Repellent",CHAINSAW:"Chainsaw",FLAME_BURST:"Flame Burst",TRIPLE_CANNON:"Triple Cannon",FIREBALL_ORB:"Fireball Orb",TESLA_CANNON:"Tesla Cannon"}[t]||t}clear(){this.events=[]}}class Tt{renderer;input;state=x.MENU;lastFrameTime=0;isPaused=!1;accumulator=0;player=null;bounds;timeAlive=0;scoringSystem=new gt;collisionSystem;patternManager=new wt;orbSpawner=new Mt;activeWeapons=[];lastDeathEvent=null;eventLogger=new Dt;menuElement;gameOverElement;permissionElement;newGameBtn;playAgainBtn;enableMotionBtn;finalScoreElement;newHighscoreElement;constructor(){this.renderer=new O("game"),this.input=new ut,this.bounds=this.renderer.getBounds(),this.collisionSystem=new mt(this.bounds),this.menuElement=document.getElementById("menu"),this.gameOverElement=document.getElementById("game-over"),this.permissionElement=document.getElementById("permission-prompt"),this.newGameBtn=document.getElementById("new-game-btn"),this.playAgainBtn=document.getElementById("play-again-btn"),this.enableMotionBtn=document.getElementById("enable-motion-btn"),this.finalScoreElement=document.getElementById("final-score"),this.newHighscoreElement=document.getElementById("new-highscore"),this.setupEventListeners(),this.setupScaleSlider(),this.checkPlatform(),this.gameLoop(0),this.displayMenuHighscores()}checkPlatform(){if(!("ontouchstart"in window)&&!("DeviceOrientationEvent"in window)){this.showElement("desktop-warning",!0);return}this.checkOrientation(),window.addEventListener("orientationchange",()=>this.checkOrientation()),window.addEventListener("resize",()=>this.checkOrientation())}checkOrientation(){const t=window.innerWidth>window.innerHeight;this.showElement("landscape-warning",t&&this.state===x.PLAYING)}showElement(t,i){const s=document.getElementById(t);s&&(s.style.display=i?"flex":"none")}displayMenuHighscores(){const t=document.getElementById("menu-highscores");if(t){const i=X();i.length===0?t.innerHTML='<li style="color: #666;">No scores yet</li>':t.innerHTML=i.slice(0,10).map((s,e)=>`<li>${e+1}. ${s.score}</li>`).join("")}}setupEventListeners(){this.newGameBtn.addEventListener("click",()=>this.handleNewGameClick()),this.playAgainBtn.addEventListener("click",()=>this.handleNewGameClick()),this.enableMotionBtn.addEventListener("click",()=>this.requestMotionPermission()),window.addEventListener("resize",()=>{this.bounds=this.renderer.getBounds()}),document.addEventListener("visibilitychange",()=>{document.hidden&&this.state===x.PLAYING?this.pause():!document.hidden&&this.state===x.PAUSED&&this.resume()})}setupScaleSlider(){const t=document.getElementById("game-scale-slider"),i=document.getElementById("scale-value");if(t&&i){const s=localStorage.getItem("game-scale"),e=s?parseInt(s,10):130;t.value=e.toString(),i.textContent=`${e}%`,this.renderer.setScale(e/100),this.bounds=this.renderer.getBounds(),this.collisionSystem.updateBounds(this.bounds),t.addEventListener("input",()=>{const o=parseInt(t.value,10);i.textContent=`${o}%`,this.renderer.setScale(o/100),localStorage.setItem("game-scale",o.toString()),this.bounds=this.renderer.getBounds(),this.collisionSystem&&this.collisionSystem.updateBounds(this.bounds)})}}async handleNewGameClick(){if(this.input.needsPermissionRequest()){this.menuElement.classList.add("hidden"),this.permissionElement.style.display="flex";return}this.startGame()}async requestMotionPermission(){await this.input.requestPermission()?(this.permissionElement.style.display="none",this.startGame()):alert("Motion permission denied. The game requires device motion to play.")}startGame(){this.state=x.PLAYING,this.timeAlive=0,this.lastDeathEvent=null,this.lastFrameTime=performance.now(),this.scoringSystem.start(),this.collisionSystem.updateBounds(this.bounds);const t=this.bounds.width/2,i=this.bounds.height/2;this.player=new ft(t,i),this.patternManager.clear(),this.orbSpawner.initialize(this.bounds,this.player.getPosition()),this.activeWeapons=[],this.eventLogger.startGame(),this.input.calibrateTiltBasis(),this.menuElement.classList.add("hidden"),this.gameOverElement.classList.add("hidden")}handleGameOver(){const t=this.scoringSystem.getScore();this.state=x.GAME_OVER,this.finalScoreElement.textContent=`Score: ${t}`;const i=bt(t);i>0&&i<=3?(this.newHighscoreElement.textContent=i===1?"New #1 High Score!":`New #${i} High Score!`,this.newHighscoreElement.style.display="block"):this.newHighscoreElement.style.display="none";const e=document.getElementById("gameover-highscores");if(e){const a=X();e.innerHTML=a.slice(0,10).map((r,h)=>`<li${i>0&&h+1===i?' style="color: #FFD700; font-weight: bold;"':""}>${h+1}. ${r.score}</li>`).join("")}const o=document.getElementById("death-reason");o&&(o.textContent=this.lastDeathEvent?.message??"Unknown");const n=document.getElementById("event-log");if(n){const a=this.eventLogger.getFormattedEvents();n.innerHTML=a.map(r=>`<li><span class="event-time">[${r.time}]</span> ${r.message}</li>`).join("")}this.gameOverElement.classList.remove("hidden")}pause(){this.isPaused=!0}resume(){this.isPaused=!1,this.lastFrameTime=performance.now()}gameLoop=t=>{if(this.state!==x.PLAYING||this.isPaused){requestAnimationFrame(this.gameLoop);return}const i=t-this.lastFrameTime;for(this.lastFrameTime=t,this.accumulator+=i;this.accumulator>=U;)this.update(U/1e3),this.accumulator-=U;this.render(),requestAnimationFrame(this.gameLoop)};update(t){if(!this.player)return;this.timeAlive+=t;const i=this.input.getVelocity();this.player.update(t,i,this.bounds);const s=this.scoringSystem.getScore();this.patternManager.setScore(s),this.patternManager.update(t,this.player.getPosition(),this.bounds);const e=this.patternManager.getAllDots();if(e.length===0&&!this.patternManager.isAnyPatternActivelySpawning()){const r=this.patternManager.selectNextPattern();r&&this.patternManager.spawnPattern(r,this.player.getPosition(),this.bounds)}this.orbSpawner.update(this.bounds,this.player.getPosition()),this.collisionSystem.rebuildGrid(e);const o=this.orbSpawner.getOrbs();for(const r of o)r.updatePosition(t,this.bounds);const n=this.collisionSystem.checkPlayerOrbCollision(this.player,o);if(n){const r=this.input.getVelocity();if(!n.bounce(r,this.player.getPosition())){const c=n.getWeaponType(),d=A.create(c);d&&(d.activate(this.player,e,n.getPosition()),this.activeWeapons.push(d),n.pickup(),this.orbSpawner.removeOrb(n),this.eventLogger.logWeaponPickup(c))}}for(let r=this.activeWeapons.length-1;r>=0;r--){const h=this.activeWeapons[r];if(h instanceof k&&h.setOrbs(o),h.update(t,this.player,e,this.bounds),h instanceof k){const c=h.getDestroyedOrbs();for(const d of c)this.orbSpawner.removeOrb(d)}if(h.isActive()){const c=this.player.getPosition(),d=h.getPosition(),p=h.getRadius(),u=this.player.hitboxRadius,m=d.x-c.x,P=d.y-c.y,E=m*m+P*P,w=p+u;if(E<w*w){const M=this.input.getVelocity();h.handlePlayerCollision(this.player,M)}}if(h instanceof k&&h.hasKilledPlayer()){this.eventLogger.logBouncedOrbDetonate("NUCLEAR_BOMB",h.getKilledDots()),this.eventLogger.logPlayerDeath("Nuclear Bomb explosion"),this.lastDeathEvent={message:"Killed by Nuclear Bomb explosion",type:"nuclear_bomb",timestamp:Date.now()},this.handleGameOver();return}h.isComplete()&&(this.scoringSystem.addKills(h.getKilledDots()),this.activeWeapons.splice(r,1))}const a=this.collisionSystem.checkPlayerDotCollision(this.player);a&&(a.isLethal()?(this.eventLogger.logPlayerDeath("red dot"),this.lastDeathEvent={message:"Hit by a red dot",type:"dot",timestamp:Date.now()},this.handleGameOver()):a.isFrozen()&&(a.kill(),this.scoringSystem.addKills(1)))}render(){this.renderer.clear(dt);const t=this.orbSpawner.getOrbs();for(let s=0;s<t.length;s++)t[s].render(this.renderer);const i=this.patternManager.getAllDots();for(let s=0;s<i.length;s++)i[s].render(this.renderer);for(let s=0;s<this.activeWeapons.length;s++)this.activeWeapons[s].render(this.renderer);this.player&&this.player.render(this.renderer),this.renderer.flushBatches(),this.renderer.endFrame()}getState(){return this.state}getScore(){return this.scoringSystem.getScore()}}const V=8,Rt="#00CCFF",q=1/J,Ct=F-1;class G{position;velocity;state;patternId=null;spawnElapsed=0;currentScale=F;radius=b;frozenTime=0;thawDuration=6e3;preThawWarningTime=500;isZombie=!1;zombieSpeed=50;vibrationOffset={x:0,y:0};frozenBorderThickness=V;constructor(t,i,s=null){this.position=new R(t,i),this.velocity={x:0,y:0},this.state=S.SPAWNING,this.patternId=s}skipSpawnAnimation(){this.state=S.ACTIVE,this.currentScale=1,this.spawnElapsed=1/q}update(t,i,s){if(this.state===S.SPAWNING){this.spawnElapsed+=t*1e3;const e=this.spawnElapsed*q;e>=1?(this.state=S.ACTIVE,this.currentScale=1):this.currentScale=F-Ct*e;return}if(this.state===S.FROZEN){this.frozenTime+=t*1e3;const e=Math.min(this.frozenTime/this.thawDuration,1);this.frozenBorderThickness=V*(1-e);const o=this.thawDuration-this.frozenTime;if(o<=this.preThawWarningTime&&o>0){const n=2*(1-o/this.preThawWarningTime);this.vibrationOffset.x=(Math.random()-.5)*n,this.vibrationOffset.y=(Math.random()-.5)*n}else this.vibrationOffset.x=0,this.vibrationOffset.y=0;this.frozenTime>=this.thawDuration&&this.thaw(s);return}if(this.state===S.ACTIVE){if(this.isZombie&&s){const e=s.x-this.position.x,o=s.y-this.position.y,n=Math.sqrt(e*e+o*o);n>0&&(this.velocity.x=e/n*this.zombieSpeed,this.velocity.y=o/n*this.zombieSpeed)}this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.patternId!==y.CYCLONE&&this.patternId!==y.CLOCK_SWEEP&&this.patternId!==y.SWEEPER_LINE&&tt(this.position,i)}}render(t){const i=this.radius*this.currentScale;let s;switch(this.state){case S.SPAWNING:s=lt;break;case S.FROZEN:s=ct;break;default:s=ht}const e=this.position.x+this.vibrationOffset.x,o=this.position.y+this.vibrationOffset.y;if(t.drawCircle(e,o,i,s),this.state===S.SPAWNING){const n=1-this.currentScale/F;t.drawCircleOutline(e,o,i*1.5,`rgba(255,102,102,${n.toFixed(2)})`)}this.state===S.FROZEN&&(t.drawCircleOutline(e,o,i+this.frozenBorderThickness,Rt),t.drawCircle(e,o,i,s))}isLethal(){return this.state===S.ACTIVE}isFrozen(){return this.state===S.FROZEN}freeze(){(this.state===S.ACTIVE||this.state===S.SPAWNING)&&(this.state=S.FROZEN,this.velocity.x=0,this.velocity.y=0,this.frozenTime=0,this.frozenBorderThickness=V)}thaw(t){if(this.state===S.FROZEN&&(this.state=S.ACTIVE,this.isZombie=!0,this.vibrationOffset.x=0,this.vibrationOffset.y=0,t)){const i=t.x-this.position.x,s=t.y-this.position.y,e=Math.sqrt(i*i+s*s);e>0&&(this.velocity.x=i/e*this.zombieSpeed,this.velocity.y=s/e*this.zombieSpeed)}}kill(){this.state=S.DEAD}isDead(){return this.state===S.DEAD}getPosition(){return this.position}getRadius(){return this.radius}getEffectiveRadius(){return this.state===S.FROZEN?this.radius+this.frozenBorderThickness:this.radius}}class C{dots=[];elapsedMs=0;isStarted=!1;spawnDot(t,i,s={x:0,y:0}){const e=new G(t,i,this.type);return e.velocity.x=s.x,e.velocity.y=s.y,this.dots.push(e),e}getDots(){return this.dots.filter(t=>!t.isDead())}isComplete(){return!1}isActivelySpawning(){return!1}start(){this.elapsedMs=0,this.isStarted=!0}getElapsedTime(){return this.elapsedMs}tick(t){this.elapsedMs+=t*1e3}render(t){}clear(){for(let t=0;t<this.dots.length;t++)this.dots[t].kill();this.dots=[]}}class xt extends C{type=y.ZOMBIE_SNOW;difficulty=g.EASY;spawnInterval;elapsedSinceSpawn=0;duration=15e3;dotSpeed=50;constructor(t=g.EASY){switch(super(),this.difficulty=t,t){case g.HARD:this.spawnInterval=150;break;case g.MEDIUM:this.spawnInterval=300;break;default:this.spawnInterval=500}}spawn(t,i){this.start()}update(t,i,s){this.elapsedMs<=this.duration&&(this.elapsedSinceSpawn+=t*1e3,this.elapsedSinceSpawn>=this.spawnInterval&&(this.elapsedSinceSpawn=0,this.spawnDotAtRandomPosition(s)));for(let e=this.dots.length-1;e>=0;e--){const o=this.dots[e];if(!o.isLethal()){o.update(t,s,i);continue}const n=o.getPosition();if(n.x<-100||n.x>s.width+100||n.y<-100||n.y>s.height+100){this.dots.splice(e,1);continue}const a=i.x-n.x,r=i.y-n.y,h=Math.sqrt(a*a+r*r);h>0&&(o.velocity.x=a/h*this.dotSpeed,o.velocity.y=r/h*this.dotSpeed),o.update(t,s,i)}}spawnDotAtRandomPosition(t){const i=b*2,s=it(t,i);this.spawnDot(s.x,s.y)}isComplete(){return this.elapsedMs>this.duration&&this.getDots().length===0}isActivelySpawning(){return this.elapsedMs<=this.duration}}class vt extends C{type=y.SWEEPER_LINE;difficulty=g.EASY;duration=2e4;dotSpacing=20;holeSize=40;isHorizontal=!0;sweepSpeed=150;linePos=0;lineVelocity=0;lineOffset=0;pendingSpawns=[];spawnTimer=0;spawnDelay=12;isSpawning=!1;spawnCompleteTime=0;constructor(t=g.EASY){switch(super(),this.difficulty=t,t){case g.HARD:this.sweepSpeed=220;break;case g.MEDIUM:this.sweepSpeed=180;break;default:this.sweepSpeed=140}}spawn(t,i){this.start(),this.isSpawning=!0,this.spawnCompleteTime=0,this.isHorizontal=Math.random()>.5,this.isHorizontal?this.lineOffset=Math.random()*(i.width-200)+100:this.lineOffset=Math.random()*(i.height-200)+100,this.isHorizontal?(this.lineVelocity=Math.random()>.5?this.sweepSpeed:-this.sweepSpeed,this.linePos=this.lineVelocity>0?0:i.height):(this.lineVelocity=Math.random()>.5?this.sweepSpeed:-this.sweepSpeed,this.linePos=this.lineVelocity>0?0:i.width),this.generateLineWithHoles(i)}generateLineWithHoles(t){const i=Math.floor(Math.random()*2)+2,s=this.isHorizontal?t.height:t.width,e=Math.floor((s-100)/this.dotSpacing),o=new Set,n=Math.ceil(this.holeSize/this.dotSpacing);for(let r=0;r<i;r++){const h=Math.floor(Math.random()*(e-10))+5;for(let c=-Math.floor(n/2);c<=Math.floor(n/2);c++)o.add(h+c)}const a=(s-e*this.dotSpacing)/2;for(let r=0;r<e;r++)if(!o.has(r)){const h=a+r*this.dotSpacing;this.pendingSpawns.push({offset:h})}}update(t,i,s){if(this.isSpawning){this.spawnCompleteTime+=t*1e3;const n=J+this.pendingSpawns.length*this.spawnDelay;this.spawnCompleteTime>=n&&(this.isSpawning=!1)}if(this.isSpawning||(this.linePos+=this.lineVelocity*t,this.isHorizontal?this.linePos>=s.height?(this.linePos=s.height,this.lineVelocity=-this.sweepSpeed):this.linePos<=0&&(this.linePos=0,this.lineVelocity=this.sweepSpeed):this.linePos>=s.width?(this.linePos=s.width,this.lineVelocity=-this.sweepSpeed):this.linePos<=0&&(this.linePos=0,this.lineVelocity=this.sweepSpeed)),this.pendingSpawns.length>0){this.spawnTimer+=t*1e3;const n=this.isHorizontal?s.height:s.width;for(;this.spawnTimer>=this.spawnDelay&&this.pendingSpawns.length>0;){this.spawnTimer-=this.spawnDelay;const{offset:a}=this.pendingSpawns.shift();this.isHorizontal?this.spawnDot(this.lineOffset+a-n/2,this.linePos,{x:0,y:this.lineVelocity}):this.spawnDot(this.linePos,this.lineOffset+a-n/2,{x:this.lineVelocity,y:0})}}const e=this.isHorizontal?0:this.lineVelocity,o=this.isHorizontal?this.lineVelocity:0;for(let n=this.dots.length-1;n>=0;n--){const a=this.dots[n];if(a.isFrozen()){a.update(t,s,i);continue}this.isSpawning||(a.position.x+=e*t,a.position.y+=o*t,a.velocity.x=e,a.velocity.y=o,this.isHorizontal?a.position.y=Math.max(0,Math.min(s.height,a.position.y)):a.position.x=Math.max(0,Math.min(s.width,a.position.x))),this.isHorizontal?(a.position.x<-50||a.position.x>s.width+50)&&a.kill():(a.position.y<-50||a.position.y>s.height+50)&&a.kill(),a.update(t,s,i)}for(let n=this.dots.length-1;n>=0;n--)this.dots[n].isDead()&&this.dots.splice(n,1)}isComplete(){return this.elapsedMs>this.duration&&this.dots.length===0}}class Nt extends C{type=y.SPARSE_GRID;difficulty=g.EASY;dotSpeed=20;constructor(t=g.EASY){switch(super(),this.difficulty=t,t){case g.HARD:this.dotSpeed=40;break;case g.MEDIUM:this.dotSpeed=30;break;default:this.dotSpeed=20}}spawn(t,i){this.start(),this.spawnGrid(i)}update(t,i,s){for(let e=this.dots.length-1;e>=0;e--){const o=this.dots[e];if(!o.isLethal()){o.update(t,s,i);continue}const n=o.getPosition();if(n.x<-100||n.x>s.width+100||n.y<-100||n.y>s.height+100){this.dots.splice(e,1);continue}const a=i.x-n.x,r=i.y-n.y,h=Math.sqrt(a*a+r*r);if(h>0){const c=h>50?this.dotSpeed:this.dotSpeed*(h/50);o.velocity.x=a/h*c,o.velocity.y=r/h*c}o.update(t,s,i)}}spawnGrid(t){const e=Math.floor((t.width-200)/85),o=Math.floor((t.height-200)/85);for(let n=0;n<o;n++)for(let a=0;a<e;a++){const r=100+a*85+42.5,h=100+n*85+85/2;this.spawnDot(r,h,{x:0,y:0})}}isComplete(){return this.getDots().length===0}}class Ot extends C{type=y.ULTRA_SPARSE_GRID;difficulty=g.EASY;dotSpeed=20;constructor(t=g.EASY){switch(super(),this.difficulty=t,t){case g.HARD:this.dotSpeed=40;break;case g.MEDIUM:this.dotSpeed=30;break;default:this.dotSpeed=20}}spawn(t,i){this.start(),this.spawnGrid(i)}update(t,i,s){for(let e=this.dots.length-1;e>=0;e--){const o=this.dots[e];if(!o.isLethal()){o.update(t,s,i);continue}const n=o.getPosition();if(n.x<-100||n.x>s.width+100||n.y<-100||n.y>s.height+100){this.dots.splice(e,1);continue}const a=i.x-n.x,r=i.y-n.y,h=Math.sqrt(a*a+r*r);if(h>0){const c=h>50?this.dotSpeed:this.dotSpeed*(h/50);o.velocity.x=a/h*c,o.velocity.y=r/h*c}o.update(t,s,i)}}spawnGrid(t){const s=Math.floor(t.width/170),e=Math.floor(t.height/170),o=(t.width-s*170)/2,n=(t.height-e*170)/2;for(let a=0;a<e;a++)for(let r=0;r<s;r++){const h=o+r*170+85,c=n+a*170+170/2;this.spawnDot(h,c,{x:0,y:0})}}isComplete(){return this.getDots().length===0}}class Lt extends C{type=y.BOUNCING_BALL;difficulty=g.MEDIUM;duration=3e4;ballRadius=120;dotCount=200;centerPosition={x:0,y:0};centerVelocity={x:0,y:0};dotOffsets=[];speed=120;constructor(t=g.MEDIUM){switch(super(),this.difficulty=t,t){case g.HARD:this.speed=180;break;case g.MEDIUM:this.speed=120;break;default:this.speed=80}}spawn(t,i){this.start(),this.centerPosition={x:i.width/2,y:i.height/2};const s=Math.random()*Math.PI*2;this.centerVelocity={x:Math.cos(s)*this.speed,y:Math.sin(s)*this.speed},this.spawnDots()}spawnDots(){this.dotOffsets=[];const t=20,i=Math.ceil(this.dotCount/t);for(let s=0;s<i;s++){const e=this.ballRadius*(s+1)/i,o=Math.min(t,this.dotCount-this.dotOffsets.length);for(let n=0;n<o;n++){const a=n/o*Math.PI*2;this.dotOffsets.push({x:Math.cos(a)*e,y:Math.sin(a)*e})}if(this.dotOffsets.length>=this.dotCount)break}for(let s=0;s<this.dotOffsets.length;s++){const e=this.dotOffsets[s];this.spawnDot(this.centerPosition.x+e.x,this.centerPosition.y+e.y,{x:this.centerVelocity.x,y:this.centerVelocity.y})}}update(t,i,s){this.centerPosition.x+=this.centerVelocity.x*t,this.centerPosition.y+=this.centerVelocity.y*t;const e=this.ballRadius+b,o=s.width-this.ballRadius-b,n=this.ballRadius+b,a=s.height-this.ballRadius-b;this.centerPosition.x<=e?(this.centerPosition.x=e,this.centerVelocity.x=Math.abs(this.centerVelocity.x)):this.centerPosition.x>=o&&(this.centerPosition.x=o,this.centerVelocity.x=-Math.abs(this.centerVelocity.x)),this.centerPosition.y<=n?(this.centerPosition.y=n,this.centerVelocity.y=Math.abs(this.centerVelocity.y)):this.centerPosition.y>=a&&(this.centerPosition.y=a,this.centerVelocity.y=-Math.abs(this.centerVelocity.y));for(let r=0;r<this.dots.length;r++){const h=this.dots[r];if(h.isFrozen()){h.update(t,s,i);continue}const c=this.dotOffsets[r];if(c&&!h.isDead()){const d=this.centerPosition.x+c.x,p=this.centerPosition.y+c.y,u=h.position.x-d,m=h.position.y-p;this.centerPosition.x+=u,this.centerPosition.y+=m;const P=this.centerPosition.x+c.x,E=this.centerPosition.y+c.y;h.position.x=P,h.position.y=E,h.velocity.x=this.centerVelocity.x,h.velocity.y=this.centerVelocity.y}h.update(t,s,i)}}isComplete(){return this.elapsedMs>this.duration&&this.getDots().length===0}}class _t extends C{type=y.GATLING_POINT;difficulty=g.MEDIUM;shootDuration;dotSpeed=400;shootInterval=100;elapsedSinceSpawn=0;spawnPoint={x:0,y:0};spawnPointDot=null;spawnPointRadius=b;spawnPointDead=!1;cooldownDuration=5e3;cooldownElapsed=0;isShooting=!1;shootingElapsed=0;masterSpawnDuration=1500;masterSpawnElapsed=0;shotsFired=0;slowShotCount=5;slowShotSpeedMultiplier=.5;constructor(t=g.MEDIUM){switch(super(),this.difficulty=t,t){case g.HARD:this.shootDuration=6e3,this.shootInterval=50;break;case g.MEDIUM:this.shootDuration=4500,this.shootInterval=80;break;default:this.shootDuration=3e3,this.shootInterval=100}}spawn(t,i){this.start();const s=50;this.spawnPoint=it(i,s),this.spawnPointDot=new G(this.spawnPoint.x,this.spawnPoint.y,this.type),Object.defineProperty(this.spawnPointDot,"radius",{value:this.spawnPointRadius,writable:!1,configurable:!0}),this.dots.push(this.spawnPointDot)}update(t,i,s){this.spawnPointDot&&!this.spawnPointDead&&(this.spawnPointDot.isDead()?this.spawnPointDead=!0:this.spawnPointDot.isFrozen()||(this.updateMasterSpawnAnimation(t),this.updateShootingLogic(t,i)));for(let e=this.dots.length-1;e>=0;e--){const o=this.dots[e];if(!o.isLethal()){o.update(t,s,i);continue}const n=o.getPosition(),a=o.velocity;if(n.x<-100||n.x>s.width+100||n.y<-100||n.y>s.height+100){this.dots.splice(e,1);continue}const r=o.radius;n.x<=r&&a.x<0?(a.x=-a.x*.5,n.x=r+1):n.x>=s.width-r&&a.x>0&&(a.x=-a.x*.5,n.x=s.width-r-1),n.y<=r&&a.y<0?(a.y=-a.y*.5,n.y=r+1):n.y>=s.height-r&&a.y>0&&(a.y=-a.y*.5,n.y=s.height-r-1),o.update(t,s,i)}}updateMasterSpawnAnimation(t){this.spawnPointDot&&this.spawnPointDot.state===S.SPAWNING&&(this.masterSpawnElapsed+=t*1e3,this.spawnPointDot.update(t,{width:0,height:0}),this.masterSpawnElapsed>=this.masterSpawnDuration&&(this.spawnPointDot.state=S.ACTIVE,this.isShooting=!0))}updateShootingLogic(t,i){this.isShooting?(this.shootingElapsed+=t*1e3,this.elapsedSinceSpawn+=t*1e3,this.elapsedSinceSpawn>=this.shootInterval&&(this.elapsedSinceSpawn=0,this.spawnDotAtPoint(i)),this.shootingElapsed>=this.shootDuration&&(this.isShooting=!1,this.cooldownElapsed=0)):(this.cooldownElapsed+=t*1e3,this.cooldownElapsed>=this.cooldownDuration&&(this.isShooting=!0,this.shootingElapsed=0,this.elapsedSinceSpawn=0))}spawnDotAtPoint(t){const i=t.x-this.spawnPoint.x,s=t.y-this.spawnPoint.y,e=Math.sqrt(i*i+s*s);if(e>0){let o=this.dotSpeed;this.shotsFired<this.slowShotCount&&(o=this.dotSpeed*this.slowShotSpeedMultiplier),this.shotsFired++,this.spawnDot(this.spawnPoint.x,this.spawnPoint.y,{x:i/e*o,y:s/e*o}).skipSpawnAnimation()}else this.spawnDot(this.spawnPoint.x,this.spawnPoint.y)}isComplete(){return this.spawnPointDead||this.spawnPointDot&&this.spawnPointDot.isFrozen()?this.getDots().length===0:!1}isActivelySpawning(){return this.spawnPointDead||this.spawnPointDot&&this.spawnPointDot.isFrozen()?!1:this.isShooting}getSpawnPointDot(){return this.spawnPointDot}isSpawnPointDead(){return this.spawnPointDead}render(t){if(super.render?.(t),this.spawnPointDot&&!this.spawnPointDot.isDead()&&!this.spawnPointDot.isFrozen()){const i=this.spawnPointDot.getPosition(),s=1+Math.sin(this.elapsedMs*.005)*.2;t.drawCircleOutline(i.x,i.y,this.spawnPointRadius*s,"#FFD700",3),t.drawCircleOutline(i.x,i.y,this.spawnPointRadius*s*1.3,"rgba(255, 215, 0, 0.3)",1)}}}const $=["top","bottom","left","right","topLeft","topRight","bottomLeft","bottomRight"];class H extends C{duration=4e3;baseDotSpeed=250;spawnInterval=150;masterRadius=b*2;originX=0;originY=0;spawnAccumulator=0;patternPhase=0;isShooting=!1;masterDot=null;masterDead=!1;masterSpawnDuration=1500;masterSpawnElapsed=0;spawn(t,i){this.start(),this.spawnAccumulator=0,this.patternPhase=0,this.masterSpawnElapsed=0,this.masterDead=!1;const s=$[Math.floor(Math.random()*$.length)],e=this.getSpawnPosition(i,s);this.originX=e.x,this.originY=e.y,this.masterDot=new G(this.originX,this.originY,this.type),Object.defineProperty(this.masterDot,"radius",{value:this.masterRadius,writable:!1,configurable:!0}),this.dots.push(this.masterDot)}getSpawnPosition(t,i){const s=this.masterRadius+5,e=t.width,o=t.height;switch(i){case"top":return{x:e/2,y:s};case"bottom":return{x:e/2,y:o-s};case"left":return{x:s,y:o/2};case"right":return{x:e-s,y:o/2};case"topLeft":return{x:s,y:s};case"topRight":return{x:e-s,y:s};case"bottomLeft":return{x:s,y:o-s};case"bottomRight":return{x:e-s,y:o-s}}}update(t,i,s){if(this.masterDot&&!this.masterDead){if(this.masterDot.isDead())this.masterDead=!0;else if(!this.masterDot.isFrozen()){if(this.updateMasterSpawnAnimation(t),this.isShooting&&this.elapsedMs<=this.duration+this.masterSpawnDuration)for(this.spawnAccumulator+=t*1e3;this.spawnAccumulator>=this.spawnInterval;)this.spawnAccumulator-=this.spawnInterval,this.spawnPatternBullets();this.patternPhase+=t*.5}}for(let e=this.dots.length-1;e>=0;e--){const o=this.dots[e];if(o===this.masterDot){o.update(t,s,i);continue}if(o.isFrozen()){o.update(t,s,i);continue}const n=o.getPosition();if(n.x<-b||n.x>s.width+b||n.y<-b||n.y>s.height+b){this.dots.splice(e,1);continue}o.position.x+=o.velocity.x*t,o.position.y+=o.velocity.y*t}}updateMasterSpawnAnimation(t){this.masterDot&&this.masterDot.state===S.SPAWNING&&(this.masterSpawnElapsed+=t*1e3,this.masterDot.update(t,{width:0,height:0}),this.masterSpawnElapsed>=this.masterSpawnDuration&&(this.masterDot.state=S.ACTIVE,this.isShooting=!0))}createBullet(t,i=1){const s=this.baseDotSpeed*i,e=new G(this.originX,this.originY,this.type);return e.velocity.x=Math.cos(t)*s,e.velocity.y=Math.sin(t)*s,e.state=S.ACTIVE,e.skipSpawnAnimation(),this.dots.push(e),e}render(t){if(super.render?.(t),this.masterDot&&!this.masterDot.isDead()&&!this.masterDot.isFrozen()){const i=this.masterDot.getPosition(),s=1+Math.sin(this.elapsedMs*.005)*.2;t.drawCircleOutline(i.x,i.y,this.masterRadius*s,"#FFD700",3),t.drawCircleOutline(i.x,i.y,this.masterRadius*s*1.3,"rgba(255, 215, 0, 0.3)",1)}}isComplete(){return this.masterDead||this.masterDot&&this.masterDot.isFrozen()?this.dots.filter(i=>i!==this.masterDot&&!i.isDead()).length===0:!1}isActivelySpawning(){return this.masterDead||this.masterDot&&this.masterDot.isFrozen()?!1:this.isShooting}getSpawnPointDot(){return this.masterDot}isSpawnPointDead(){return this.masterDead}}class Bt extends H{type=y.SPIRAL;difficulty=g.HARD;constructor(t=g.HARD){switch(super(),t){case g.HARD:this.duration=4e3;break;case g.MEDIUM:this.duration=3e3;break}}spawnPatternBullets(){for(let e=0;e<3;e++){const o=this.patternPhase*2+e*Math.PI*2/3;for(let n=0;n<2;n++){const a=o+n*.1,r=.8+n*.1;this.createBullet(a,r)}}}}class Ft extends H{type=y.CIRCLE_BURST;difficulty=g.HARD;constructor(t=g.HARD){switch(super(),t){case g.HARD:this.duration=4e3;break;case g.MEDIUM:this.duration=3e3;break}}spawnPatternBullets(){const i=Math.PI*2/16;for(let s=0;s<16;s++){const e=s*i+this.patternPhase*.5;this.createBullet(e)}}}class kt extends H{type=y.AIMED_STREAMS;difficulty=g.HARD;playerPosition={x:0,y:0};constructor(t=g.HARD){switch(super(),t){case g.HARD:this.duration=4e3;break;case g.MEDIUM:this.duration=3e3;break}}update(t,i,s){this.playerPosition=i,super.update(t,i,s)}spawnPatternBullets(){const i=Math.atan2(this.playerPosition.y-this.originY,this.playerPosition.x-this.originX);for(let s=0;s<5;s++){const e=(s-Math.floor(2.5))*.15,o=i+e,n=.9+Math.random()*.2;this.createBullet(o,n)}}}class Gt extends H{type=y.WAVE;difficulty=g.HARD;constructor(t=g.HARD){switch(super(),t){case g.HARD:this.duration=4e3;break;case g.MEDIUM:this.duration=3e3;break}}spawnPatternBullets(){const t=Math.PI,i=7,s=Math.PI/2+Math.sin(this.patternPhase*2)*.3;for(let e=0;e<i;e++){const o=(e/(i-1)-.5)*t,n=s+o,a=.7+Math.abs(o)*.3;this.createBullet(n,a)}}}class Ht extends C{type=y.CONTAINMENT_RING;difficulty=g.EASY;ringRadius=100;dotSpeed=30;dotCount=40;innerRadius=20;constructor(t=g.EASY){super(),this.difficulty=t}spawn(t,i){this.start(),this.spawnRing(t,i)}update(t,i,s){for(let e=this.dots.length-1;e>=0;e--){const o=this.dots[e];if(!o.isLethal()){o.update(t,s,i);continue}const n=o.getPosition();if(n.x<-100||n.x>s.width+100||n.y<-100||n.y>s.height+100){this.dots.splice(e,1);continue}const a=i.x-n.x,r=i.y-n.y,h=Math.sqrt(a*a+r*r);h>this.innerRadius?(o.velocity.x=a/h*this.dotSpeed,o.velocity.y=r/h*this.dotSpeed):(o.velocity.x=0,o.velocity.y=0),o.update(t,s,i)}}spawnRing(t,i){const s=Math.floor(Math.random()*5),e=s>0?2:0,o=[];for(let n=0;n<s;n++){const a=this.dotCount*n/s+Math.floor(this.dotCount/(s*2)),r=a-e,h=a+e;o.push([r,h])}for(let n=0;n<this.dotCount;n++){if(o.some(([d,p])=>n>=d&&n<=p))continue;const r=2*Math.PI*n/this.dotCount,h=t.x+this.ringRadius*Math.cos(r),c=t.y+this.ringRadius*Math.sin(r);this.spawnDot(h,c)}}isComplete(){return this.getDots().length===0}}class Ut extends C{type=y.CYCLONE;difficulty=g.HARD;duration=25e3;circleRadius=50;dotSpeed=150;constructor(t=g.HARD){switch(super(),this.difficulty=t,t){case g.HARD:this.dotSpeed=300,this.circleRadius=80;break;case g.MEDIUM:this.dotSpeed=200,this.circleRadius=60;break;default:this.dotSpeed=150,this.circleRadius=50}}spawn(t,i){this.start(),this.spawnDots(i)}update(t,i,s){for(let e=this.dots.length-1;e>=0;e--){const o=this.dots[e];if(!o.isLethal()){o.update(t,s,i);continue}const n=o.getPosition();if(n.x<-50||n.x>s.width+50||n.y<-50||n.y>s.height+50){this.dots.splice(e,1);continue}o.update(t,s,i)}}spawnDots(t){const i=[{x:t.width*.15,y:t.height*.15},{x:t.width*.85,y:t.height*.15},{x:t.width*.15,y:t.height*.85},{x:t.width*.85,y:t.height*.85}],s=i[Math.floor(Math.random()*i.length)],e=150;for(let o=0;o<e;o++){const a=o/e*Math.PI*2+(Math.random()-.5)*.2,r=this.circleRadius*(.8+Math.random()*.4),h=s.x+Math.cos(a)*r,c=s.y+Math.sin(a)*r,d=a+Math.PI/2+(Math.random()-.5)*.5,p=this.dotSpeed*(.5+Math.random()*1);this.spawnDot(h,c,{x:Math.cos(d)*p,y:Math.sin(d)*p})}}isComplete(){return this.elapsedMs>this.duration&&this.getDots().length===0}}class Wt extends C{type=y.CLOCK_SWEEP;difficulty=g.MEDIUM;duration=25e3;center={x:0,y:0};hands=[];spawnProgress=0;spawnDuration=3500;hasFinishedSpawning=!1;secondHandSpeed=.5;secondHandLength=400;secondHandDotCount=15;minuteHandSpeed=.4;minuteHandLength=350;minuteHandDotCount=20;hourHandSpeed=.15;hourHandLength=200;hourHandDotCount=25;constructor(t=g.MEDIUM){switch(super(),this.difficulty=t,t){case g.HARD:this.hands=[this.createHand(this.secondHandSpeed*1.3,this.secondHandLength,this.secondHandDotCount,[]),this.createHand(this.minuteHandSpeed*1.2,this.minuteHandLength,this.minuteHandDotCount,[8,9,10]),this.createHand(this.hourHandSpeed*1.2,this.hourHandLength,this.hourHandDotCount+5,[])];break;case g.MEDIUM:this.hands=[this.createHand(this.secondHandSpeed,this.secondHandLength,this.secondHandDotCount,[]),this.createHand(this.minuteHandSpeed,this.minuteHandLength,this.minuteHandDotCount,[9,10,11]),this.createHand(this.hourHandSpeed,this.hourHandLength,this.hourHandDotCount,[])];break;default:this.hands=[this.createHand(this.secondHandSpeed*.8,this.secondHandLength*.9,this.secondHandDotCount-3,[]),this.createHand(this.minuteHandSpeed*.8,this.minuteHandLength*.9,this.minuteHandDotCount-3,[9,10]),this.createHand(this.hourHandSpeed*.8,this.hourHandLength*.9,this.hourHandDotCount-5,[])]}}createHand(t,i,s,e){const o=[],n=i/(s-1);for(let a=0;a<s;a++)e.includes(a)||o.push({index:a,distance:a*n,dot:null});return{angle:Math.random()*Math.PI*2,speed:t,length:i,dotCount:s,gaps:e,dots:o}}spawn(t,i){this.start(),this.center={x:i.width/2,y:i.height/2},this.spawnProgress=0,this.hasFinishedSpawning=!1;for(const s of this.hands)for(const e of s.dots){const o=this.center.x+Math.cos(s.angle)*e.distance,n=this.center.y+Math.sin(s.angle)*e.distance,a=this.spawnDot(o,n,{x:0,y:0});e.dot=a}}update(t,i,s){this.hasFinishedSpawning||(this.spawnProgress+=t*1e3,this.spawnProgress>=this.spawnDuration&&(this.hasFinishedSpawning=!0));for(const e of this.hands)e.angle+=e.speed*t;for(const e of this.hands)for(const o of e.dots){const n=o.dot;if(!n||n.isDead())continue;if(n.isFrozen()){n.update(t,s,i);continue}if(!this.hasFinishedSpawning){n.update(t,s,i);continue}const a=n.position.x-this.center.x,r=n.position.y-this.center.y,h=-e.speed*r,c=e.speed*a;n.position.x+=h*t,n.position.y+=c*t,n.velocity.x=h,n.velocity.y=c,n.update(t,s,i)}for(let e=this.dots.length-1;e>=0;e--)this.dots[e].isDead()&&this.dots.splice(e,1)}isComplete(){return this.elapsedMs>this.duration&&this.dots.length===0}}class Vt extends D{type=f.BLASTER;state="AIMING";aimTime=1e3;aimStartTime=0;beamPosition=0;prevBeamPosition=0;beamAngle=0;playerPosition={x:0,y:0};playerAngle=0;beamOriginPosition={x:0,y:0};BEAM_WIDTH=10;BEAM_LENGTH=150;BEAM_SPEED=600;activate(t,i){this.start(),this.dots=i,this.aimStartTime=Date.now(),this.playerPosition=t.getPosition(),this.playerAngle=t.directionAngle,this.beamAngle=this.playerAngle,this.state="AIMING"}update(t,i,s,e){if(this.state==="COMPLETE")return;const o=Date.now()-this.aimStartTime;if(this.state==="AIMING")this.playerPosition=i.getPosition(),this.playerAngle=i.directionAngle,o>=this.aimTime&&(this.state="FIRING",this.beamAngle=this.playerAngle,this.beamOriginPosition={...this.playerPosition});else if(this.state==="FIRING"){this.prevBeamPosition=this.beamPosition,this.beamPosition+=this.BEAM_SPEED*t,this.checkBeamCollision(s);const n=Math.max(e.width,e.height)*1.5;this.beamPosition>n&&(this.state="COMPLETE")}}checkBeamCollision(t){if(!t||t.length===0)return;const i=Math.cos(this.beamAngle),s=Math.sin(this.beamAngle),e=this.BEAM_WIDTH/2+2,o=this.BEAM_LENGTH/2+2;for(const n of t)if(!n.isDead()){const a=n.getPosition(),r=n.getRadius(),h=a.x-this.beamOriginPosition.x,c=a.y-this.beamOriginPosition.y,d=h*i+c*s,p=-h*s+c*i;if(Math.abs(p)>o+r)continue;const u=this.beamPosition+e,m=this.beamPosition-e,P=this.prevBeamPosition+e,E=this.prevBeamPosition-e,w=Math.min(m,E),M=Math.max(u,P);d>=w&&d<=M&&(n.kill(),this.addKilledDot())}}render(t){if(this.state==="COMPLETE")return;const i=t.getContext();if(this.state==="AIMING"){const s=this.playerPosition.x,e=this.playerPosition.y;i.save(),i.translate(s,e),i.rotate(this.playerAngle),i.fillStyle="rgb(128, 0, 128)",i.fillRect(0,-6,20,12),i.restore()}else if(this.state==="FIRING"){const s=this.beamOriginPosition.x+this.beamPosition*Math.cos(this.beamAngle),e=this.beamOriginPosition.y+this.beamPosition*Math.sin(this.beamAngle);i.save(),i.translate(s,e),i.rotate(this.beamAngle),i.fillStyle="rgba(128, 0, 255, 0.78)",i.fillRect(-5,-75,10,150),i.restore()}}isComplete(){return this.state==="COMPLETE"}}class Xt extends D{type=f.CHAINSAW;duration=5e3;chainsawRadius=50;playerPosition={x:0,y:0};warningStartTime=4200;flashDuration=100;flashGap=300;activate(t,i){this.start(),this.playerPosition=t.getPosition()}update(t,i,s,e){if(!(this.getElapsedTime()>=this.duration)&&!(!s||s.length===0)){this.playerPosition=i.getPosition();for(const o of s){if(o.isDead())continue;const n=o.getPosition(),a=n.x-this.playerPosition.x,r=n.y-this.playerPosition.y;Math.sqrt(a*a+r*r)<=this.chainsawRadius&&(o.kill(),this.addKilledDot())}}}shouldShowVisual(){const t=this.getElapsedTime();if(t<this.warningStartTime)return!0;const i=t-this.warningStartTime,s=i<this.flashDuration,e=i>=this.flashGap&&i<this.flashGap+this.flashDuration;return!s&&!e}render(t){if(!this.shouldShowVisual())return;const s=this.getElapsedTime()/50%(Math.PI*2),e=8,o=this.chainsawRadius*.7,n=this.chainsawRadius;t.drawCircle(this.playerPosition.x,this.playerPosition.y,this.chainsawRadius,Q.CHAINSAW+"66");const a=t.getContext();a.save(),a.translate(this.playerPosition.x,this.playerPosition.y),a.rotate(s),a.fillStyle="#E0E0E0";for(let r=0;r<e;r++){const h=r/e*Math.PI*2,c=(r+1)/e*Math.PI*2;a.beginPath(),a.moveTo(Math.cos(h)*o,Math.sin(h)*o),a.lineTo(Math.cos(h+(c-h)*.5)*n,Math.sin(h+(c-h)*.5)*n),a.lineTo(Math.cos(c)*o,Math.sin(c)*o),a.closePath(),a.fill()}a.fillStyle="#808080",a.beginPath(),a.arc(0,0,o*.5,0,Math.PI*2),a.fill(),a.restore()}isComplete(){return this.getElapsedTime()>=this.duration}getChainsawRadius(){return this.chainsawRadius}}class zt extends D{type=f.DOT_REPELLENT;duration=8e3;fieldRadius=100;playerPosition={x:0,y:0};activate(t,i){this.start(),this.dots=[],this.playerPosition=t.getPosition()}update(t,i,s,e){if(!(this.getElapsedTime()>=this.duration)&&!(!s||s.length===0)){this.playerPosition=i.getPosition();for(const n of s){if(n.isDead()||n.isFrozen())continue;const a=n.getPosition(),r=a.x-this.playerPosition.x,h=a.y-this.playerPosition.y,c=Math.sqrt(r*r+h*h);if(c<this.fieldRadius&&c>0){const d=5*(1-c/this.fieldRadius);n.position.x+=r/c*d,n.position.y+=h/c*d}}}}render(t){const i=t.getContext();i.save(),i.beginPath(),i.arc(this.playerPosition.x,this.playerPosition.y,this.fieldRadius,0,Math.PI*2),i.strokeStyle="rgba(128, 128, 128, 0.3)",i.lineWidth=3,i.stroke(),i.restore()}isComplete(){return this.getElapsedTime()>=this.duration}}class Yt extends D{type=f.ELECTRIC_BOMB;state="ROLLING";orbPosition={x:0,y:0};orbVelocity={x:0,y:0};chainNodes=[];lightningArcs=[];dotsToProcess=[];initialRadiusFactor=.25;chainRadiusFactor=.1;maxChainDepth=1e3;orbRadius=12;rollingDuration=1500;chainDelayMs=80;lastChainTime=0;bounds=null;lastCollisionTime=0;collisionCooldown=100;activate(t,i,s){this.dots=i,this.start(),s?this.orbPosition={x:s.x,y:s.y}:this.orbPosition={...t.getPosition()},this.orbVelocity={x:0,y:0},this.state="ROLLING"}update(t,i,s,e){switch(this.bounds===null&&(this.bounds=e),this.state){case"ROLLING":this.updateRolling(t,e);break;case"CHAINING":this.updateChaining(s,i,e);break}}getPosition(){return this.orbPosition}getRadius(){return this.orbRadius}handlePlayerCollision(t,i){const s=Date.now();if(s-this.lastCollisionTime<this.collisionCooldown)return!1;this.lastCollisionTime=s;const e=this.orbPosition.x-t.position.x,o=this.orbPosition.y-t.position.y,n=Math.sqrt(e*e+o*o),a=50,r=Math.sqrt(i.x**2+i.y**2);if(r<a)return!1;if(n===0)return this.orbVelocity.x=i.x,this.orbVelocity.y=i.y,!0;const h=e/n,c=o/n,d=-c,p=h,u=i.x*h+i.y*c,m=i.x*d+i.y*p,P=u/r;if(P<.1)return!1;const E=1.5;if(P>.7)this.orbVelocity.x=i.x*E,this.orbVelocity.y=i.y*E;else{const w=P,M=1-P;this.orbVelocity.x=(h*u*w+d*m*M)*E,this.orbVelocity.y=(c*u*w+p*m*M)*E}return!0}updateRolling(t,i){this.orbPosition.x+=this.orbVelocity.x*t,this.orbPosition.y+=this.orbVelocity.y*t,this.orbPosition.x-this.orbRadius<0?(this.orbPosition.x=this.orbRadius,this.orbVelocity.x=Math.abs(this.orbVelocity.x)):this.orbPosition.x+this.orbRadius>i.width&&(this.orbPosition.x=i.width-this.orbRadius,this.orbVelocity.x=-Math.abs(this.orbVelocity.x)),this.orbPosition.y-this.orbRadius<0?(this.orbPosition.y=this.orbRadius,this.orbVelocity.y=Math.abs(this.orbVelocity.y)):this.orbPosition.y+this.orbRadius>i.height&&(this.orbPosition.y=i.height-this.orbRadius,this.orbVelocity.y=-Math.abs(this.orbVelocity.y)),this.getElapsedTime()>=this.rollingDuration&&this.triggerInitialExplosion()}triggerInitialExplosion(){this.state="CHAINING",this.lastChainTime=Date.now();const t=(this.bounds?.width??800)*this.initialRadiusFactor;this.chainNodes.push({x:this.orbPosition.x,y:this.orbPosition.y,radius:t,activatedAt:Date.now(),chainDepth:0}),this.findAndElectrifyDots(this.chainNodes[0])}findAndElectrifyDots(t){for(const i of this.dots){if(i.isDead())continue;const s=i.getPosition(),e=s.x-t.x,o=s.y-t.y;if(Math.sqrt(e*e+o*o)<=t.radius){i.kill(),this.addKilledDot(),this.lightningArcs.push({x1:t.x,y1:t.y,x2:s.x,y2:s.y,createdAt:Date.now(),chainDepth:t.chainDepth});const a={x:s.x,y:s.y,radius:(this.bounds?.width??800)*this.chainRadiusFactor,activatedAt:Date.now(),chainDepth:t.chainDepth+1,parentX:t.x,parentY:t.y};this.chainNodes.push(a),this.dotsToProcess.push(i)}}}updateChaining(t,i,s){if(!t||t.length===0){this.state="COMPLETE";return}const e=Date.now();if(e-this.lastChainTime<this.chainDelayMs)return;this.lastChainTime=e;const o=this.chainNodes.filter(n=>n.chainDepth>0&&e-n.activatedAt<100&&n.chainDepth<this.maxChainDepth);if(o.length===0){this.checkPlayerHit(i);const n=this.chainNodes.filter(r=>e-r.activatedAt<600),a=this.chainNodes.some(r=>r.chainDepth>0);(n.length===0||!a)&&(this.state="COMPLETE");return}for(const n of o)this.findAndElectrifyDots(n);this.checkPlayerHit(i)}checkPlayerHit(t){}render(t){this.state==="ROLLING"?(t.drawCircle(this.orbPosition.x,this.orbPosition.y,this.orbRadius,"#00FFFF"),t.drawCircleOutline(this.orbPosition.x,this.orbPosition.y,this.orbRadius+4,"rgba(0, 255, 255, 0.5)",2)):(this.state==="CHAINING"||this.state==="COMPLETE")&&(this.renderChainNodes(t),this.renderLightning(t))}renderChainNodes(t){const i=Date.now(),s=500;this.chainNodes=this.chainNodes.filter(e=>i-e.activatedAt<s+100);for(const e of this.chainNodes){const o=i-e.activatedAt,n=Math.max(0,1-o/s);n>0&&(t.drawCircle(e.x,e.y,e.radius,`rgba(0, 255, 255, ${n*.3})`),t.drawCircleOutline(e.x,e.y,e.radius,`rgba(0, 255, 255, ${n})`,3))}}renderLightning(t){const i=Date.now(),s=500;this.lightningArcs=this.lightningArcs.filter(e=>i-e.createdAt<s);for(const e of this.lightningArcs){const o=i-e.createdAt,n=Math.max(0,1-o/s);n>0&&this.drawJaggedLightning(t,e.x1,e.y1,e.x2,e.y2,n,e.chainDepth)}}drawJaggedLightning(t,i,s,e,o,n,a){const r=3+Math.min(a,3),h=6+a*2,c=`rgba(0, 200, 255, ${n})`,d=`rgba(100, 230, 255, ${n*.5})`,p=[];p.push({x:i,y:s});for(let u=1;u<r;u++){const m=u/r,P=i+(e-i)*m,E=s+(o-s)*m,w=(Math.random()-.5)*h*2,M=(Math.random()-.5)*h*2;p.push({x:P+w,y:E+M})}p.push({x:e,y:o});for(let u=0;u<p.length-1;u++)t.drawLine(p[u].x,p[u].y,p[u+1].x,p[u+1].y,d,4);for(let u=0;u<p.length-1;u++)t.drawLine(p[u].x,p[u].y,p[u+1].x,p[u+1].y,c,2)}isActive(){return this.state==="ROLLING"}isComplete(){return this.state==="COMPLETE"}hasKilledPlayer(){return!1}getExplosionCount(){return this.chainNodes.length}}class Kt extends D{type=f.FLAME_BURST;FLAME_DURATION_MS=3e3;CONE_ANGLE_RAD=Math.PI/3;FLAME_REACH_PX=200;TRAIL_DURATION_MS=1e3;PARTICLE_MAX_AGE_MS=200;PARTICLE_AGE_VARIANCE_MS=100;PARTICLES_PER_FRAME=5;FRAME_TIME_MS=16;playerPosition={x:0,y:0};playerAngle=0;flames=[];trails=[];flameActive=!1;complete=!1;activate(t,i){this.start(),this.dots=i,this.playerPosition=t.getPosition(),this.playerAngle=t.directionAngle,this.flames=[],this.trails=[],this.flameActive=!0,this.complete=!1}update(t,i,s,e){if(this.complete)return;if(this.getElapsedTime()>=this.FLAME_DURATION_MS){this.flameActive=!1;const a=Date.now();this.trails=this.trails.filter(r=>a-r.startTime<r.duration),this.trails.length===0&&(this.complete=!0);return}this.playerPosition=i.getPosition(),this.playerAngle=i.directionAngle,this.spawnFlameParticles(),this.flames=this.flames.filter(a=>(a.age+=this.FRAME_TIME_MS,a.age<a.maxAge)),Math.random()<.3&&this.spawnFireTrail();const n=Date.now();this.trails=this.trails.filter(a=>n-a.startTime<a.duration),this.killDotsInFlameCone(s)}spawnFlameParticles(){for(let t=0;t<this.PARTICLES_PER_FRAME;t++){const i=(Math.random()-.5)*this.CONE_ANGLE_RAD,s=this.playerAngle+i,e=Math.random()*this.FLAME_REACH_PX,o=(Math.random()-.5)*20,n=(Math.random()-.5)*20;this.flames.push({x:this.playerPosition.x+Math.cos(s)*e+o,y:this.playerPosition.y+Math.sin(s)*e+n,age:0,maxAge:this.PARTICLE_MAX_AGE_MS+Math.random()*this.PARTICLE_AGE_VARIANCE_MS})}}spawnFireTrail(){const t=(Math.random()-.5)*this.CONE_ANGLE_RAD,i=this.playerAngle+t,s=20+Math.random()*60;this.trails.push({x:this.playerPosition.x+Math.cos(i)*s,y:this.playerPosition.y+Math.sin(i)*s,startTime:Date.now(),duration:this.TRAIL_DURATION_MS})}killDotsInFlameCone(t){if(!t||t.length===0)return;const i=this.CONE_ANGLE_RAD/2;for(const s of t){if(s.isDead())continue;const e=s.getPosition(),o=e.x-this.playerPosition.x,n=e.y-this.playerPosition.y;if(Math.sqrt(o*o+n*n)>this.FLAME_REACH_PX)continue;let h=Math.atan2(n,o)-this.playerAngle;for(;h>Math.PI;)h-=Math.PI*2;for(;h<-Math.PI;)h+=Math.PI*2;Math.abs(h)<=i&&(s.kill(),this.addKilledDot())}}render(t){if(this.complete)return;const i=t.getContext(),s=Date.now();this.renderTrails(i,s),this.flameActive&&(this.renderFlameCone(i),this.renderFlameParticles(i))}renderTrails(t,i){for(const s of this.trails){const o=(i-s.startTime)/s.duration,n=Math.max(0,1-o),a=8+o*5;t.beginPath(),t.arc(s.x,s.y,a,0,Math.PI*2),t.fillStyle=`rgba(255, 100, 0, ${n*.6})`,t.fill(),t.beginPath(),t.arc(s.x,s.y,a*.5,0,Math.PI*2),t.fillStyle=`rgba(255, 200, 50, ${n*.8})`,t.fill()}}renderFlameCone(t){t.save(),t.translate(this.playerPosition.x,this.playerPosition.y),t.rotate(this.playerAngle);const i=t.createRadialGradient(0,0,0,0,0,this.FLAME_REACH_PX);i.addColorStop(0,"rgba(255, 150, 0, 0.3)"),i.addColorStop(.5,"rgba(255, 100, 0, 0.2)"),i.addColorStop(1,"rgba(255, 50, 0, 0)"),t.beginPath(),t.moveTo(0,0),t.arc(0,0,this.FLAME_REACH_PX,-this.CONE_ANGLE_RAD/2,this.CONE_ANGLE_RAD/2),t.closePath(),t.fillStyle=i,t.fill(),t.restore()}renderFlameParticles(t){for(const i of this.flames){const s=i.age/i.maxAge,e=Math.max(0,1-s),o=6+s*8;t.beginPath(),t.arc(i.x,i.y,o,0,Math.PI*2),t.fillStyle=`rgba(255, ${Math.floor(100+s*50)}, 0, ${e*.5})`,t.fill(),t.beginPath(),t.arc(i.x,i.y,o*.4,0,Math.PI*2),t.fillStyle=`rgba(255, ${Math.floor(200+s*55)}, ${Math.floor(50+s*100)}, ${e*.8})`,t.fill()}}isComplete(){return this.complete}}const T=6,qt="#FF6B00",$t="rgba(255, 107, 0, 0.3)",Z=5*Math.PI/180,j=45,Zt=15,jt=500,Jt=250,Qt="#FFD700";class ti extends D{type=f.HOMING_MISSILE;missiles=[];explosions=[];missileSpeed=800;activate(t,i){this.start(),this.dots=i,this.missiles=[],this.explosions=[];const s=t.getPosition(),e=t.directionAngle,o=t.velocity,n=Math.sqrt(o.x**2+o.y**2)*.5,a=this.missileSpeed+n,r=[e-Math.PI/6,e,e+Math.PI/6];for(const h of r){const c={x:s.x,y:s.y,vx:Math.cos(h)*a,vy:Math.sin(h)*a,angle:h,target:null,active:!0};this.missiles.push(c)}}findBestTarget(t,i){if(!i||i.length===0)return null;let s=null,e=1/0;for(const o of i){if(o.isDead())continue;const n=o.getPosition(),a=W(t,n),r=Math.atan2(n.y-t.y,n.x-t.x),h=Math.abs(this.normalizeAngle(r-t.angle)),c=a*(1+h);c<e&&(e=c,s=o)}return s}normalizeAngle(t){for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;return t}createExplosion(t,i){const s=[];for(let o=0;o<4;o++){const n=Math.random()*Math.PI*2,a=Math.random()*j*.6;s.push({x:Math.cos(n)*a,y:Math.sin(n)*a,radius:Zt*(.8+Math.random()*.4)})}const e={x:t,y:i,startTime:Date.now(),duration:jt,mainRadius:j,subExplosions:s,hasAppliedDamage:!1,active:!0};this.explosions.push(e)}applyExplosionDamage(t,i){if(!t.hasAppliedDamage){for(const s of i){if(s.isDead())continue;const e=s.getPosition();W({x:t.x,y:t.y},e)<t.mainRadius+s.getRadius()&&(s.kill(),this.addKilledDot())}t.hasAppliedDamage=!0}}update(t,i,s,e){const o=Date.now();this.missiles=this.missiles.filter(n=>n.active),this.explosions=this.explosions.filter(n=>n.active);for(const n of this.explosions)o-n.startTime>=n.duration&&(n.active=!1),n.hasAppliedDamage||this.applyExplosionDamage(n,s);for(const n of this.missiles)if(n.active){if((!n.target||n.target.isDead())&&(n.target=this.findBestTarget(n,s)),n.target){const a=n.target.getPosition(),r=Math.atan2(a.y-n.y,a.x-n.x),h=this.normalizeAngle(r-n.angle),c=Math.max(-Z,Math.min(Z,h));n.angle+=c;const d=Math.sqrt(n.vx**2+n.vy**2);n.vx=Math.cos(n.angle)*d,n.vy=Math.sin(n.angle)*d}if(n.x+=n.vx*t,n.y+=n.vy*t,n.x<-T||n.x>e.width+T||n.y<-T||n.y>e.height+T){n.active=!1;continue}for(const a of s){if(a.isDead())continue;const r=a.getPosition();if(W(n,r)<T+a.getRadius()){this.createExplosion(n.x,n.y),n.active=!1;break}}}}render(t){const i=t.getContext(),s=Date.now();for(const e of this.missiles)e.active&&(i.save(),i.translate(e.x,e.y),i.rotate(e.angle),i.beginPath(),i.moveTo(-15,0),i.lineTo(-T,0),i.strokeStyle=$t,i.lineWidth=4,i.stroke(),i.beginPath(),i.moveTo(T*1.5,0),i.lineTo(-T,-T*.6),i.lineTo(-T,T*.6),i.closePath(),i.fillStyle=qt,i.fill(),i.restore());for(const e of this.explosions){if(!e.active)continue;const o=s-e.startTime,a=1-o/e.duration;if(i.save(),i.globalAlpha=a,i.fillStyle=Qt,i.beginPath(),i.arc(e.x,e.y,e.mainRadius,0,Math.PI*2),i.fill(),o>=Jt)for(const r of e.subExplosions)i.beginPath(),i.arc(e.x+r.x,e.y+r.y,r.radius,0,Math.PI*2),i.fill();i.restore()}}isComplete(){return this.missiles.every(t=>!t.active)&&this.explosions.every(t=>!t.active)}}class ii extends D{type=f.ICE_BOMB;state="EXPLODING";bounds=null;explosionRadius=0;explosionCenter={x:0,y:0};explosionStartTime=0;frozenDotsCount=0;activate(t,i){this.start(),this.explosionStartTime=Date.now(),this.explosionCenter={x:t.position.x,y:t.position.y},this.dots=i,this.explosionRadius=0,this.state="EXPLODING"}update(t,i,s,e){this.bounds||(this.bounds=e,this.explosionRadius=.3*e.width,this.freezeDotsInRadius(s)),(this.state==="EXPLODING"||this.state==="FADING")&&this.freezeDotsInRadius(s),this.state==="EXPLODING"?Date.now()-this.explosionStartTime>=500&&(this.state="FADING"):this.state==="FADING"&&Date.now()-this.explosionStartTime>=6e3&&(this.state="COMPLETE")}render(t){if(this.state==="EXPLODING"||this.state==="FADING"){const i=Date.now()-this.explosionStartTime;let s=.6;this.state==="FADING"&&(s=.6*(1-(i-500)/5500)),s>0&&t.drawCircle(this.explosionCenter.x,this.explosionCenter.y,this.explosionRadius,`rgba(0, 204, 255, ${s})`)}}isComplete(){return this.state==="COMPLETE"}freezeDotsInRadius(t){if(!(!t||t.length===0))for(const i of t){if(i.isDead()||i.isFrozen())continue;const s=i.getPosition(),e=s.x-this.explosionCenter.x,o=s.y-this.explosionCenter.y;Math.sqrt(e*e+o*o)<=this.explosionRadius&&(i.freeze(),this.frozenDotsCount++)}}getFrozenDotsCount(){return this.frozenDotsCount}getExplosionRadius(){return this.explosionRadius}}class si extends D{type=f.KINETIC_BOMB;state="COLLAPSING";explosionCenter={x:0,y:0};explosionRadius=0;bounds=null;killedDotsInExplosion=new Set;activate(t,i){this.dots=i,this.explosionCenter={x:t.position.x,y:t.position.y},this.start()}update(t,i,s,e){this.bounds||(this.bounds=e);const o=this.getElapsedTime();switch(this.state){case"COLLAPSING":o>=100&&(this.state="EXPLODING",this.explosionRadius=.45*e.width);break;case"EXPLODING":this.killDotsInExplosion(s),o>=1e3&&(this.state="COMPLETE");break}}render(t){const i=this.getElapsedTime();if(this.state==="COLLAPSING"){const s=50*(1-i/100);s>0&&t.drawCircle(this.explosionCenter.x,this.explosionCenter.y,Math.max(0,s),"#FF4500")}else if(this.state==="EXPLODING"){const o=1-(i-100)/900;o>0&&t.drawCircle(this.explosionCenter.x,this.explosionCenter.y,this.explosionRadius,`rgba(255, 69, 0, ${o*.7})`)}}isComplete(){return this.state==="COMPLETE"}killDotsInExplosion(t){for(const i of t){if(i.isDead()||this.killedDotsInExplosion.has(i))continue;const s=i.getPosition(),e=s.x-this.explosionCenter.x,o=s.y-this.explosionCenter.y;Math.sqrt(e*e+o*o)<=this.explosionRadius&&(i.kill(),this.addKilledDot(),this.killedDotsInExplosion.add(i))}}}class ei extends D{type=f.TRIPLE_CANNON;state="AIMING";aimTime=500;aimStartTime=0;playerPosition={x:0,y:0};playerAngle=0;bullets=[];currentBulletIndex=0;lastShotTime=0;shotDelay=250;BULLET_RADIUS=8;BULLET_SPEED=800;EXPLOSION_RADIUS=60;EXPLOSION_DURATION=300;activate(t,i){this.start(),this.dots=i,this.aimStartTime=Date.now(),this.playerPosition=t.getPosition(),this.playerAngle=t.directionAngle,this.state="AIMING",this.bullets=[],this.currentBulletIndex=0,this.lastShotTime=0}update(t,i,s,e){if(this.state==="COMPLETE")return;const o=Date.now()-this.aimStartTime;if(this.state==="AIMING")this.playerPosition=i.getPosition(),this.playerAngle=i.directionAngle,o>=this.aimTime&&(this.state="FIRING",this.fireBullet());else if(this.state==="FIRING"){const n=Date.now();this.playerPosition=i.getPosition(),this.playerAngle=i.directionAngle,this.currentBulletIndex<3&&n-this.lastShotTime>=this.shotDelay&&this.fireBullet();let a=!0;for(const r of this.bullets)r.exploded?n-r.explosionTime>=this.EXPLOSION_DURATION?r.active=!1:(this.checkExplosionCollision(r,s),a=!1):r.active&&(r.position.x+=r.velocity.x*t,r.position.y+=r.velocity.y*t,(r.position.x<0||r.position.x>e.width||r.position.y<0||r.position.y>e.height)&&this.explodeBullet(r),this.checkBulletCollision(r,s)&&this.explodeBullet(r),a=!1);a&&this.currentBulletIndex>=3&&(this.state="COMPLETE")}}fireBullet(){const t=Math.cos(this.playerAngle),i=Math.sin(this.playerAngle),s={position:{...this.playerPosition},velocity:{x:t*this.BULLET_SPEED,y:i*this.BULLET_SPEED},active:!0,exploded:!1,explosionTime:0};this.bullets.push(s),this.currentBulletIndex++,this.lastShotTime=Date.now()}explodeBullet(t){t.exploded=!0,t.explosionTime=Date.now(),t.velocity={x:0,y:0}}checkBulletCollision(t,i){if(!i||i.length===0)return!1;for(const s of i)if(!s.isDead()){const e=s.getPosition(),o=s.getRadius(),n=t.position.x-e.x,a=t.position.y-e.y,r=n*n+a*a,h=this.BULLET_RADIUS+o;if(r<h*h)return s.kill(),this.addKilledDot(),!0}return!1}checkExplosionCollision(t,i){if(!(!i||i.length===0)){for(const s of i)if(!s.isDead()){const e=s.getPosition(),o=s.getRadius(),n=t.position.x-e.x,a=t.position.y-e.y,r=n*n+a*a,h=this.EXPLOSION_RADIUS+o;r<h*h&&(s.kill(),this.addKilledDot())}}}render(t){if(this.state==="COMPLETE")return;const i=t.getContext();if(this.state==="AIMING"){const s=this.playerPosition.x,e=this.playerPosition.y;i.save(),i.translate(s,e),i.rotate(this.playerAngle),i.strokeStyle="rgb(255, 0, 255)",i.lineWidth=2,i.beginPath(),i.arc(20,0,8,0,Math.PI*2),i.stroke(),i.restore()}else if(this.state==="FIRING"){const s=Date.now();for(const e of this.bullets)if(e.active)if(e.exploded){const n=(s-e.explosionTime)/this.EXPLOSION_DURATION,a=1-n,r=this.EXPLOSION_RADIUS*(.5+.5*n);i.fillStyle=`rgba(128, 0, 255, ${a*.8})`,i.beginPath(),i.arc(e.position.x,e.position.y,r,0,Math.PI*2),i.fill(),i.fillStyle=`rgba(200, 100, 255, ${a})`,i.beginPath(),i.arc(e.position.x,e.position.y,r*.5,0,Math.PI*2),i.fill()}else i.fillStyle="rgb(255, 0, 255)",i.beginPath(),i.arc(e.position.x,e.position.y,this.BULLET_RADIUS,0,Math.PI*2),i.fill(),i.fillStyle="rgba(255, 100, 255, 0.5)",i.beginPath(),i.arc(e.position.x,e.position.y,this.BULLET_RADIUS*1.5,0,Math.PI*2),i.fill()}}isComplete(){return this.state==="COMPLETE"}}class oi extends D{type=f.FIREBALL_ORB;state="DRIFTING";orbPosition={x:0,y:0};orbVelocity={x:0,y:0};bounds=null;activeDuration=2500;fireDuration=1e4;fizzleStartTime=0;firePoints=[];fireTrailWidth=12;orbRadius=N*.6;lastSegmentPosition={x:0,y:0};minSegmentDistance=15;lastCollisionTime=0;collisionCooldown=100;activate(t,i,s){if(this.dots=i,this.start(),s)this.orbPosition={x:s.x,y:s.y};else{const e=Math.sqrt(t.velocity.x**2+t.velocity.y**2);if(e>10){const o=t.velocity.x/e,n=t.velocity.y/e,a=t.hitboxRadius+this.orbRadius+5;this.orbPosition={x:t.position.x+o*a,y:t.position.y+n*a}}else this.orbPosition={x:t.position.x,y:t.position.y-t.hitboxRadius-this.orbRadius-5}}this.orbVelocity={x:0,y:0},this.lastSegmentPosition={...this.orbPosition}}handlePlayerCollision(t,i){const s=Date.now();if(s-this.lastCollisionTime<this.collisionCooldown)return!1;this.lastCollisionTime=s;const e=this.orbPosition.x-t.position.x,o=this.orbPosition.y-t.position.y,n=Math.sqrt(e*e+o*o),a=50,r=Math.sqrt(i.x**2+i.y**2);if(r<a)return!1;if(n===0)return this.orbVelocity.x=i.x,this.orbVelocity.y=i.y,!0;const h=e/n,c=o/n,d=-c,p=h,u=i.x*h+i.y*c,m=i.x*d+i.y*p,P=u/r;if(P<.1)return!1;const E=2.2;if(P>.7)this.orbVelocity.x=i.x*E,this.orbVelocity.y=i.y*E;else{const w=P,M=1-P;this.orbVelocity.x=(h*u*w+d*m*M)*E,this.orbVelocity.y=(c*u*w+p*m*M)*E}return!0}getPosition(){return this.orbPosition}getRadius(){return this.orbRadius}isActive(){return this.state==="DRIFTING"}update(t,i,s,e){this.bounds=e;const o=Date.now(),n=o-this.fireDuration;if(this.firePoints=this.firePoints.filter(a=>a.createdAt>n),this.state==="DRIFTING"){this.orbPosition.x+=this.orbVelocity.x*t,this.orbPosition.y+=this.orbVelocity.y*t;const a=this.orbRadius,r=e.width-this.orbRadius,h=this.orbRadius,c=e.height-this.orbRadius;if(this.orbPosition.x<=a?(this.orbVelocity.x=Math.abs(this.orbVelocity.x),this.orbPosition.x=a):this.orbPosition.x>=r&&(this.orbVelocity.x=-Math.abs(this.orbVelocity.x),this.orbPosition.x=r),this.orbPosition.y<=h?(this.orbVelocity.y=Math.abs(this.orbVelocity.y),this.orbPosition.y=h):this.orbPosition.y>=c&&(this.orbVelocity.y=-Math.abs(this.orbVelocity.y),this.orbPosition.y=c),Math.sqrt(this.orbVelocity.x**2+this.orbVelocity.y**2)>10){const p=this.orbPosition.x-this.lastSegmentPosition.x,u=this.orbPosition.y-this.lastSegmentPosition.y;Math.sqrt(p*p+u*u)>=this.minSegmentDistance&&(this.firePoints.push({x:this.orbPosition.x,y:this.orbPosition.y,createdAt:o}),this.lastSegmentPosition={...this.orbPosition})}this.killDotsInRadius(this.orbPosition.x,this.orbPosition.y,this.orbRadius*1.5),this.getElapsedTime()>=this.activeDuration&&(this.state="FIZZLING",this.fizzleStartTime=o)}else this.state==="FIZZLING"&&o-this.fizzleStartTime>300&&(this.state="COMPLETE");for(const a of this.firePoints)this.killDotsInRadius(a.x,a.y,this.fireTrailWidth)}killDotsInRadius(t,i,s){for(const e of this.dots){if(e.isDead())continue;const o=e.getPosition(),n=o.x-t,a=o.y-i;n*n+a*a<=(s+5)*(s+5)&&(e.kill(),this.addKilledDot())}}render(t){if(!this.bounds)return;const i=t.getContext(),s=Date.now();if(this.firePoints.length>1){i.lineCap="round",i.lineJoin="round";for(let e=1;e<this.firePoints.length;e++){const o=this.firePoints[e],n=this.firePoints[e-1],r=(s-o.createdAt)/this.fireDuration;if(r>=1)continue;const h=Math.max(0,1-r),c=.85+Math.sin(s*.015+o.x*.05)*.15,d=h*c,p=this.fireTrailWidth*(1-r*.3);i.beginPath(),i.moveTo(n.x,n.y),i.lineTo(o.x,o.y),i.strokeStyle=`rgba(255, 200, 50, ${d*.9})`,i.lineWidth=p*1.3,i.stroke(),i.beginPath(),i.moveTo(n.x,n.y),i.lineTo(o.x,o.y),i.strokeStyle=`rgba(255, 100, 0, ${d})`,i.lineWidth=p,i.stroke(),i.beginPath(),i.moveTo(n.x,n.y),i.lineTo(o.x,o.y),i.strokeStyle=`rgba(255, 220, 100, ${d*.7})`,i.lineWidth=p*.4,i.stroke()}}if(this.state==="DRIFTING")this.drawFlamingOrb(i,this.orbPosition.x,this.orbPosition.y,this.orbRadius);else if(this.state==="FIZZLING"){const e=(s-this.fizzleStartTime)/300,o=this.orbRadius*(1-e);o>0&&this.drawFlamingOrb(i,this.orbPosition.x,this.orbPosition.y,o)}}drawFlamingOrb(t,i,s,e){const o=Date.now(),n=e*2.5,a=t.createRadialGradient(i,s,0,i,s,n);a.addColorStop(0,"rgba(255, 220, 100, 0.7)"),a.addColorStop(.4,"rgba(255, 100, 0, 0.4)"),a.addColorStop(1,"rgba(255, 50, 0, 0)"),t.fillStyle=a,t.beginPath(),t.arc(i,s,n,0,Math.PI*2),t.fill();const r=t.createRadialGradient(i-e*.2,s-e*.2,0,i,s,e);r.addColorStop(0,"#FFEE66"),r.addColorStop(.5,"#FF8800"),r.addColorStop(1,"#DD3300"),t.fillStyle=r,t.beginPath(),t.arc(i,s,e,0,Math.PI*2),t.fill();const h=5;for(let c=0;c<h;c++){const d=c/h*Math.PI*2,p=Math.sin(o*.008+c*1.3)*.25,u=d+p,m=e*(.35+Math.sin(o*.012+c*2.1)*.15),P=e*.25,E=i+Math.cos(u)*e*.7,w=s+Math.sin(u)*e*.7,M=i+Math.cos(u)*(e+m),et=s+Math.sin(u)*(e+m);t.beginPath(),t.moveTo(E,w),t.lineTo(M,et),t.strokeStyle="rgba(255, 200, 50, 0.6)",t.lineWidth=P,t.lineCap="round",t.stroke()}t.fillStyle="rgba(255, 255, 220, 0.5)",t.beginPath(),t.arc(i-e*.2,s-e*.2,e*.2,0,Math.PI*2),t.fill()}isComplete(){return this.state==="COMPLETE"&&this.firePoints.length===0}hasKilledPlayer(){return!1}}class ni extends D{type=f.TESLA_CANNON;state="AIMING";aimTime=500;aimStartTime=0;playerPosition={x:0,y:0};playerAngle=0;bullets=[];currentBulletIndex=0;lastShotTime=0;shotDelay=250;BULLET_RADIUS=8;BULLET_SPEED=800;EXPLOSION_RADIUS=60;EXPLOSION_DURATION=400;chainRadiusFactor=.1;maxChainDepth=5;bounds=null;activate(t,i){this.start(),this.dots=i,this.aimStartTime=Date.now(),this.playerPosition=t.getPosition(),this.playerAngle=t.directionAngle,this.state="AIMING",this.bullets=[],this.currentBulletIndex=0,this.lastShotTime=0}update(t,i,s,e){if(this.bounds===null&&(this.bounds=e),this.state==="COMPLETE")return;const o=Date.now()-this.aimStartTime;if(this.state==="AIMING")this.playerPosition=i.getPosition(),this.playerAngle=i.directionAngle,o>=this.aimTime&&(this.state="FIRING",this.fireBullet());else if(this.state==="FIRING"){const n=Date.now();this.playerPosition=i.getPosition(),this.playerAngle=i.directionAngle,this.currentBulletIndex<3&&n-this.lastShotTime>=this.shotDelay&&this.fireBullet();let a=!0;for(const r of this.bullets)r.exploded?n-r.explosionTime>=this.EXPLOSION_DURATION?r.active=!1:(this.processChainLightning(r,n),a=!1):r.active&&(r.position.x+=r.velocity.x*t,r.position.y+=r.velocity.y*t,(r.position.x<0||r.position.x>e.width||r.position.y<0||r.position.y>e.height)&&this.explodeBullet(r),this.checkBulletCollision(r,s)&&this.explodeBullet(r),a=!1);a&&this.currentBulletIndex>=3&&(this.state="COMPLETE")}}fireBullet(){const t=this.playerAngle+Math.PI,i=Math.cos(t),s=Math.sin(t),e={position:{...this.playerPosition},velocity:{x:i*this.BULLET_SPEED,y:s*this.BULLET_SPEED},active:!0,exploded:!1,explosionTime:0,chainNodes:[],lightningArcs:[]};this.bullets.push(e),this.currentBulletIndex++,this.lastShotTime=Date.now()}explodeBullet(t){t.exploded=!0,t.explosionTime=Date.now(),t.velocity={x:0,y:0};const i=(this.bounds?.width??800)*this.chainRadiusFactor*2.5;t.chainNodes.push({x:t.position.x,y:t.position.y,radius:i,activatedAt:Date.now(),chainDepth:0}),this.findAndElectrifyDots(t,t.chainNodes[0])}checkBulletCollision(t,i){if(!i||i.length===0)return!1;for(const s of i)if(!s.isDead()){const e=s.getPosition(),o=s.getRadius(),n=t.position.x-e.x,a=t.position.y-e.y,r=n*n+a*a,h=this.BULLET_RADIUS+o;if(r<h*h)return s.kill(),this.addKilledDot(),!0}return!1}findAndElectrifyDots(t,i){for(const s of this.dots){if(s.isDead())continue;const e=s.getPosition(),o=e.x-i.x,n=e.y-i.y;if(Math.sqrt(o*o+n*n)<=i.radius){s.kill(),this.addKilledDot(),t.lightningArcs.push({x1:i.x,y1:i.y,x2:e.x,y2:e.y,createdAt:Date.now(),chainDepth:i.chainDepth});const r={x:e.x,y:e.y,radius:(this.bounds?.width??800)*this.chainRadiusFactor,activatedAt:Date.now(),chainDepth:i.chainDepth+1,parentX:i.x,parentY:i.y};t.chainNodes.push(r)}}}processChainLightning(t,i){const s=t.chainNodes.filter(e=>e.chainDepth>0&&i-e.activatedAt<100&&e.chainDepth<this.maxChainDepth);for(const e of s)this.findAndElectrifyDots(t,e)}render(t){if(this.state==="COMPLETE")return;const i=t.getContext();if(this.state==="AIMING"){const s=this.playerPosition.x,e=this.playerPosition.y,o=this.playerAngle+Math.PI;i.save(),i.translate(s,e),i.rotate(o),i.strokeStyle="#00CCFF",i.lineWidth=2,i.beginPath(),i.arc(20,0,8,0,Math.PI*2),i.stroke(),i.restore()}else if(this.state==="FIRING"){const s=Date.now();for(const e of this.bullets)e.active&&(e.exploded?this.renderElectricExplosion(i,e,s):(i.fillStyle="#00CCFF",i.beginPath(),i.arc(e.position.x,e.position.y,this.BULLET_RADIUS,0,Math.PI*2),i.fill(),i.fillStyle="rgba(0, 204, 255, 0.5)",i.beginPath(),i.arc(e.position.x,e.position.y,this.BULLET_RADIUS*1.5,0,Math.PI*2),i.fill()))}}renderElectricExplosion(t,i,s){const o=(s-i.explosionTime)/this.EXPLOSION_DURATION,n=Math.max(0,1-o),a=400;i.chainNodes=i.chainNodes.filter(h=>s-h.activatedAt<a+50),i.lightningArcs=i.lightningArcs.filter(h=>s-h.createdAt<a);for(const h of i.chainNodes){const c=s-h.activatedAt,d=Math.max(0,1-c/a);d>0&&(t.fillStyle=`rgba(0, 204, 255, ${d*.3})`,t.beginPath(),t.arc(h.x,h.y,h.radius,0,Math.PI*2),t.fill(),t.strokeStyle=`rgba(0, 230, 255, ${d})`,t.lineWidth=2,t.beginPath(),t.arc(h.x,h.y,h.radius,0,Math.PI*2),t.stroke())}for(const h of i.lightningArcs){const c=s-h.createdAt,d=Math.max(0,1-c/a);d>0&&this.drawJaggedLightning(t,h.x1,h.y1,h.x2,h.y2,d,h.chainDepth)}const r=this.EXPLOSION_RADIUS*(.3+.5*o);t.fillStyle=`rgba(0, 255, 255, ${n*.6})`,t.beginPath(),t.arc(i.position.x,i.position.y,r,0,Math.PI*2),t.fill(),t.fillStyle=`rgba(200, 255, 255, ${n})`,t.beginPath(),t.arc(i.position.x,i.position.y,r*.4,0,Math.PI*2),t.fill()}drawJaggedLightning(t,i,s,e,o,n,a){const r=3+Math.min(a,3),h=6+a*2,c=`rgba(0, 230, 255, ${n})`,d=`rgba(100, 230, 255, ${n*.5})`,p=[];p.push({x:i,y:s});for(let u=1;u<r;u++){const m=u/r,P=i+(e-i)*m,E=s+(o-s)*m,w=(Math.random()-.5)*h*2,M=(Math.random()-.5)*h*2;p.push({x:P+w,y:E+M})}p.push({x:e,y:o}),t.strokeStyle=d,t.lineWidth=4,t.lineCap="round",t.beginPath(),t.moveTo(p[0].x,p[0].y);for(let u=1;u<p.length;u++)t.lineTo(p[u].x,p[u].y);t.stroke(),t.strokeStyle=c,t.lineWidth=2,t.beginPath(),t.moveTo(p[0].x,p[0].y);for(let u=1;u<p.length;u++)t.lineTo(p[u].x,p[u].y);t.stroke()}isComplete(){return this.state==="COMPLETE"}}I.register(y.ZOMBIE_SNOW,xt);I.register(y.SWEEPER_LINE,vt);I.register(y.SPARSE_GRID,Nt);I.register(y.ULTRA_SPARSE_GRID,Ot);I.register(y.BOUNCING_BALL,Lt);I.register(y.GATLING_POINT,_t);I.register(y.SPIRAL,Bt);I.register(y.CIRCLE_BURST,Ft);I.register(y.AIMED_STREAMS,kt);I.register(y.WAVE,Gt);I.register(y.CONTAINMENT_RING,Ht);I.register(y.CYCLONE,Ut);I.register(y.CLOCK_SWEEP,Wt);A.register(f.BLASTER,Vt);A.register(f.CHAINSAW,Xt);A.register(f.DOT_REPELLENT,zt);A.register(f.ELECTRIC_BOMB,Yt);A.register(f.FLAME_BURST,Kt);A.register(f.HOMING_MISSILE,ti);A.register(f.ICE_BOMB,ii);A.register(f.KINETIC_BOMB,si);A.register(f.NUCLEAR_BOMB,k);A.register(f.TRIPLE_CANNON,ei);A.register(f.FIREBALL_ORB,oi);A.register(f.TESLA_CANNON,ni);new Tt;
//# sourceMappingURL=index-BmcqfF1u.js.map
